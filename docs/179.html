<html>
<head>
<title>How we reduced Lambda cold starts at ACG | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>我们如何在云专家ACG减少λ冷启动</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/how-we-reduced-lambda-cold-starts-at-acg#0001-01-01">https://acloudguru.com/blog/engineering/how-we-reduced-lambda-cold-starts-at-acg#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>从第一天开始，云专家就是一家完全没有服务器的公司。</p><p>Sam Kroonenburg在创建云专家时选择无服务器的原因是为了<a href="https://acloud.guru/series/serverlessconf-nyc-2019/view/from-one-to-43" target="_blank" rel="noreferrer noopener">缩短上市时间</a>。五年后，无服务器已经成为该组织不可思议的生产力助推器。它实现了小而精的产品团队每天多次向产品交付特性的梦想。无服务器架构意味着这些团队可以花更少的时间管理基础设施，花更多的时间构建功能。</p><p>但是，正如他们所说，天下没有免费的午餐。在无服务器的情况下，这意味着我们必须专门设计我们的应用程序来解决随之而来的性能问题。我们提高性能的方式？最小化冷启动的影响和lambda函数之间的通信。以下是方法。</p><h2 id="h-how-we-reduced-the-impact-of-lambda-cold-starts-and-improved-our-lead-times-with-graphql-schema-stitching">我们如何通过GraphQL模式拼接减少Lambda冷启动的影响并缩短交付周期</h2><p>什么是冷启动？<a href="https://mikhail.io/serverless/coldstarts/aws/" target="_blank" rel="noreferrer noopener">这里</a>是一个极好的解释。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/f748ebbe080e5f53ac3ebb45baecef62.png" alt="" class="wp-image-41376" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_590/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/performance-matters.png 590w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_282/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/performance-matters.png 282w" sizes="(max-width: 590px) 100vw, 590px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/performance-matters.png"/><figcaption><em>Feedback from students that performance is important</em></figcaption></figure><p>当谈到管理冷启动的影响时，首先要考虑的是驱动前端行为的请求-响应API。对于云专家来说，我们的API层是用GraphQL编写的。</p><p>缓慢的响应速度是我们研究改进GraphQL层的主要原因。第二点，我们想提高开发人员的满意度。这可以通过减少生产时间(<a href="https://clubhouse.io/blog/lead-time-what-is-it-and-why-should-you-care/" target="_blank" rel="noreferrer noopener">交付周期</a>)来实现。对于像扩展或取消API这样的常见更改，我们不希望开发人员在两个地方进行更改，这可能需要对每个步骤进行额外的部署和代码审查。</p><p>让我们回顾一下架构的发展，以及这些变化是如何减少性能问题并缩短交付周期的。</p><h2 id="h-a-graphql-primer-using-web-series">使用web系列的GraphQL初级读本</h2><p>GraphQL的主要吸引力是在一个请求中获取单个页面所需的所有数据。这个决定尤其重要，因为我们同时也在构建我们的第一个移动应用程序。为了让GraphQL能够在一个请求中获取数据，必须有一个端点能够解析整个应用程序数据图。那个入口点就是我们的<strong>网关</strong>。我们的网关只是用作一个单一的入口点，并且在设计上不包含业务逻辑。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/452b0842d52dd27bb17f2019b9bb69df.png" alt="" class="wp-image-41379" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_2032/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/xray-screen.png 2032w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/xray-screen.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/xray-screen.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/xray-screen.png 768w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1536/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/xray-screen.png 1536w" sizes="(max-width: 2032px) 100vw, 2032px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/xray-screen.png"/><figcaption><em><br/>A typical request that would be used for loading our web series page. For example, this <a href="https://acloud.guru/series/aws-this-week" target="_blank" rel="noreferrer noopener">landing page</a></em>.</figcaption></figure><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/34bee67a03f9af3403aa0cc047d79f1d.png" alt="" class="wp-image-41381" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_2184/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/system-architecture.png 2184w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/system-architecture.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/system-architecture.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/system-architecture.png 768w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1536/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/system-architecture.png 1536w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_2048/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/system-architecture.png 2048w" sizes="(max-width: 2184px) 100vw, 2184px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/system-architecture.png"/><figcaption><em>Systems architecture / entity association of microservices involved in resolving web series.</em></figcaption></figure><p>GraphQL只是一个查询格式的规范。它没有规定一些关键的细节:<strong>模式定义应该存在于何处，数据如何在微服务内解析(域内)，以及数据如何在服务间解析(域间)</strong>。两种不同的架构方法调整这两个变量。</p><h2 id="h-lambda-functions-invoked-by-a-graphql-gateway">Graphql网关调用的Lambda函数</h2><p><a href="https://github.com/ACloudGuru/blog-acg-graphql-evolution/tree/master/01-gateway-invoke" target="_blank" rel="noreferrer noopener">代码</a></p><p><strong>模式定义的位置</strong>:位于网关上</p><p><strong>数据解析</strong>:网关执行Lambda调用进入微服务解析数据；网关拥有内部和内部类型的连接。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/023ef4fe2133bf8fcee585ec0cf1ba6e.png" alt="" class="wp-image-41383" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_2202/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/service-to-service.png 2202w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/service-to-service.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/service-to-service.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/service-to-service.png 768w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1536/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/service-to-service.png 1536w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_2048/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/service-to-service.png 2048w" sizes="(max-width: 2202px) 100vw, 2202px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/service-to-service.png"/><figcaption><em>Service to service was managed through AWS SDK Lambda Invoke</em>.</figcaption></figure><p>这种架构方法只是在网关上使用了GraphQL.js。这个网关将拥有整个模式，并管理我们后端的查询解析。这样，网关将使用AWS SDK的Lambda Invoke来访问每个微服务。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/89727dcaacee01dac30974689f77c0cd.png" alt="" class="wp-image-41384" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1478/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/invoke-call.png 1478w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/invoke-call.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/invoke-call.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/invoke-call.png 768w" sizes="(max-width: 1478px) 100vw, 1478px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/invoke-call.png"/><figcaption><em>An example AWS Lambda Invoke call the the gateway would make. (</em><a href="https://github.com/ACloudGuru/blog-acg-graphql-evolution/blob/7cff1d84c9a88356a633abefea0b6379b6eddee7/01-gateway-invoke/gateway/src/handler.js#L57" target="_blank" rel="noreferrer noopener"><em>Reference</em></a><em>)</em><br/></figcaption></figure><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/568b50f285f055ecf9d4bf10c8798ef4.png" alt="" class="wp-image-41386" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1033/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/data-resolution.png 1033w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/data-resolution.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/data-resolution.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/data-resolution.png 768w" sizes="(max-width: 1033px) 100vw, 1033px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/data-resolution.png"/><figcaption><em>Data resolution for query is orchestrated by the gateway.</em></figcaption></figure><p>数据的分辨率如下:</p><ul><li>网关解析所有系列</li><li>当系列已知时，网关然后要求该系列中的所有剧集</li><li>由于剧集实体拥有访问权限，它拥有关于某人是否应该观看该剧集的<a href="https://github.com/ACloudGuru/blog-acg-graphql-evolution/blob/7cff1d84c9a88356a633abefea0b6379b6eddee7/01-gateway-invoke/series/src/episodesBySeriesId.js#L71" target="_blank" rel="noreferrer noopener">业务逻辑</a></li><li>一旦剧集被解析，只有这样，网关才能从我们的身份服务中解析作者</li></ul><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/b10ba71def4335c747efde733074480f.png" alt="" class="wp-image-41388" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1184/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/sequence-diagram.png 1184w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/sequence-diagram.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/sequence-diagram.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/sequence-diagram.png 768w" sizes="(max-width: 1184px) 100vw, 1184px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/sequence-diagram.png"/><figcaption><em>A sequence diagram illustrated with XRay. Series + Identity called on gateway, and content called on series</em>.</figcaption></figure><p>XRay说明了两件关键的事情:初始化一个冷lambda函数所花费的时间，以及获取数据所花费的时间。每个lambda容器只需进行一次初始化，因为相同的容器将被后续请求重用(直到容器被回收)。</p><p>我们注意到这个查询跨越了五个lambda函数来解析所有需要的数据。有两种类型的lambda函数:频繁调用的lambda函数(网关lambda)和可能不调用的lambda函数(2x系列、1x内容、1x身份)。</p><p>上面的例子是lambda函数的最佳例子。(它们很少依赖代码，因为代码依赖会导致更长的冷启动时间。)在典型的例子中，大多数lambda冷启动大约是一秒钟。这意味着用户点击四个lambdas不热的页面(15分钟内没有被调用)可能会经历五秒钟的延迟。哎哟。</p><p>这种架构方法还有几个其他问题:</p><ul><li>GraphQL模式<a href="https://github.com/ACloudGuru/blog-acg-graphql-evolution/blob/7cff1d84c9a88356a633abefea0b6379b6eddee7/01-gateway-invoke/gateway/src/handler.js#L9" target="_blank" rel="noreferrer noopener">存在于网关</a>上。这需要在更改API时进行两次部署——增加了交付时间，降低了开发人员的满意度</li><li>通信与lambda相关联，这意味着我们不能拥有不使用Lambda功能的微服务。(这在从Linux Academy平台整合实验室和操场时变得非常重要。)</li></ul><h2 id="h-schema-stitching">模式拼接</h2><p><a href="https://github.com/ACloudGuru/blog-acg-graphql-evolution/tree/master/02-schema-stitching" target="_blank" rel="noreferrer noopener">代码</a></p><p><strong>模式定义</strong>的位置:在每个微服务中</p><p><strong>数据解析</strong>:网关将查询解析委托给微服务；网关拥有域间类型的连接；微服务拥有域内类型的连接。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/658eb70743d6157aa01ebb5baedccff7.png" alt="" class="wp-image-41393" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1118/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/gateway-comms.png 1118w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/gateway-comms.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/gateway-comms.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/gateway-comms.png 768w" sizes="(max-width: 1118px) 100vw, 1118px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/gateway-comms.png"/><figcaption><em>Now communicating from the gateway to the downstream services using schema delegation / stitching. RPCs also managed through connecting via GraphQL</em>.</figcaption></figure><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/c0ff830fe8f82ff4b3f45131562dbe10.png" alt="" class="wp-image-41396" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_466/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/stitching-schemas.png 466w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_177/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/stitching-schemas.png 177w" sizes="(max-width: 466px) 100vw, 466px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/stitching-schemas.png"/><figcaption><em>Stitching the schemas together and doing a cross domain link between episode and author entities together on the gateway. (</em><a href="https://github.com/ACloudGuru/blog-acg-graphql-evolution/blob/7cff1d84c9a88356a633abefea0b6379b6eddee7/02-schema-stitching/gateway/src/handler.js#L63" target="_blank" rel="noreferrer noopener"><em>Reference</em></a><em>)</em></figcaption></figure><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/cc684cbaf38b10f7ed8f728c85ddf6f3.png" alt="" class="wp-image-41399" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_817/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/delegate-sub-queries.png 817w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/delegate-sub-queries.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/delegate-sub-queries.png 768w" sizes="(max-width: 817px) 100vw, 817px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/delegate-sub-queries.png"/><figcaption><em>We delegate sub queries to responsible microservices</em></figcaption></figure><p>数据的分辨率如下:</p><ul><li>网关将查询的web系列部分委托给系列服务</li><li>由于剧集实体拥有访问权限，它具有关于某人是否应该观看剧集的业务逻辑，因此它仍然管理内容服务的解析</li><li>一旦剧集的解析发生，只有这样，网关才能通过身份服务委托作者的解析</li></ul><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/71c5d8dba0a37d22d2cd9d4e912c30a3.png" alt="Sequence diagram illustrated with XRay. Cold-start initialization omitted due to the likeliness of the lambda being warm." class="wp-image-41401" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_890/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/sequence-diagram-2.png 890w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/sequence-diagram-2.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/sequence-diagram-2.png 768w" sizes="(max-width: 890px) 100vw, 890px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/sequence-diagram-2.png"/></figure><p>用x射线说明的序列图。在网关上调用系列+标识；系列上调用的内容。由于<a href="https://acloudguru.com/blog/engineering/how-to-keep-your-lambda-functions-warm">λ可能变暖</a>，冷启动初始化被省略。</p><p>使用这种方法，每个微服务的API现在被表示为单个lambda函数。这做了两件事:</p><ul><li>域内连接(例如，连续剧+剧集解析发生在同一个lambda函数内，而不是跨越两个lambda函数)。这减少了可能的启动次数+服务到服务的调用时间</li><li>lambda可能会更热，因为整个服务只有一个lambda函数</li></ul><p>我们已经从五个可能的冷启动减少到四个(网关、系列+剧集、内容、作者)，<strong>尽管每个lambda都不太可能有冷启动</strong>，因为API lambda正在为该微服务处理许多不同的操作。</p><p>从拥有模式的网关过渡到模式拼接解决了第一种方法中的一些问题:</p><ul><li>对API和服务的更改可以在一次部署中完成，从而缩短了我们的交付时间</li><li>不再耦合到AWS lambda，因为我们使用HTTP进行通信</li></ul><p>这种方法确实存在一些问题，尽管它也有一些缺点:</p><ul><li>网关仍然必须管理域间连接(尽管与域内连接相比可能性较小)</li><li>使用API网关增加了额外的延迟(从技术上讲，Lambda Invoke仍然可以做到这一点)</li><li>安全性由x-api-keys而不是IAM管理</li></ul><p>监控变得更加困难，因为一个服务处理的所有API请求只有一个GraphQL lambda。我们已经决定使用一个特定于GraphQL的服务来解决这个问题(阿波罗引擎)。添加一个额外的服务并不意味着我们现在有多个地方可以搜索API请求的问题。<br/> <br/>为了让网关知道如何委托请求微服务，我们必须查询每一个微服务。(此时我们有40多个。)查询服务微服务将引入更长的冷启动或高速缓存无效问题。我们最终通过添加内部服务发现解决了这个问题。每次有请求进来，网关都会向服务发现工具发出一个请求，以获取每个微服务的整个模式、url和api键。<strong>注意</strong>:服务发现没有包含在示例代码中，增加了三个额外的自省调用。</p><h2 id="h-cold-start-analysis">冷启动分析</h2><p>为了比较不同的方法，我们使用ApacheBench，然后将结果导出到Excel中。为了捕捉冷启动的效果，之前所有功能都被重新部署。需要考虑的是，这个ApacheBench测试是完全合成的(一次完成)，并不代表真实世界的流量(在一天中交错进行)。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/48c96980a2dd54dac55ab667841d70d3.png" alt="" class="wp-image-41405" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_560/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/apache-bench.png 560w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/apache-bench.png 300w" sizes="(max-width: 560px) 100vw, 560px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/apache-bench.png"/><figcaption><em>ApacheBench running performance testing (</em><a href="https://github.com/ACloudGuru/blog-acg-graphql-evolution/blob/master/01-gateway-invoke/performance.sh" target="_blank" rel="noreferrer noopener"><em>Reference</em></a><em>)</em></figcaption></figure><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/579fa9796194d31980d1ff66862f0a75.png" alt="" class="wp-image-41407" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_912/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/vs.png 912w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/vs.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/vs.png 768w" sizes="(max-width: 912px) 100vw, 912px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/vs.png"/><figcaption><em>Gateway Invoke vs. Schema Stitching (</em><a href="https://github.com/ACloudGuru/blog-acg-graphql-evolution/blob/master/Results.xlsx" target="_blank" rel="noreferrer noopener"><em>Raw Results</em></a><em>)</em></figcaption></figure><p>数据结果中似乎有两个关键差异。<br/> <br/>在这个特定的查询模式中，拼接有低20%的p99(五秒到四秒)。较低的p99是由于在解析系列数据时少了一个lambda函数调用/冷启动。在综合测试中不容易显示的是冷启动的减少，因为lambda函数被对这些微服务的其他调用保持温暖。我们怀疑，与网关方法拥有的许多lambda函数相比，单个API lambda函数的利用率更高。这意味着随着时间的推移，冷启动次数会明显减少。<br/> <br/>网关调用性能在p60-p70标志之间较好。在模式拼接方法中，我们在微服务之间通信时引入了API网关。似乎添加API网关会给结果增加额外的差异。如果我们决定继续使用lambda invoke进行模式拼接，而不是API Gateway，这可能会减少不一致性。</p><h2 id="h-lead-time-analysis">提前期分析</h2><p>要确定我们的网关上发生的API变化的确切数量有点困难。不过，我们可以通过使用从我们的Apollo Studio changelog中提取的数据进行一些粗略的计算。我们可以看到，在9月份，我们对GraphQL模式进行了大约230次更改。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/5b8d6e6c504b5ba6883e3b5ac45a4c1f.png" alt="" class="wp-image-41409" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_884/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/apollo-studio.png 884w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/apollo-studio.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/apollo-studio.png 768w" sizes="(max-width: 884px) 100vw, 884px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/10/apollo-studio.png"/><figcaption><em>Apollo Studio calculating GraphQL schema diff</em></figcaption></figure><p>通过查看diff中包含的内容，似乎大约有20个部署中有模式更改。一个模式的改变可能需要大约三个工程小时，一个PR(另一个审查代码的工程师的上下文切换)和部署网关，这不是没有道理的。这意味着，通过捆绑和部署模式变更以及代码变更，我们可能每月节省60个小时。</p><h2 id="h-conclusion">结论</h2><p>为了提高整体学生体验，我们进行了一些重大的架构更改。</p><p>模式拼接允许更少的冷启动，当它们<em>发生</em>时，它们的影响会更小(至少20%)。迁移到schema stitch还大大减少了从开发到生产的API变更的交付时间(我们所有的工程师，大约每月60小时)。</p><p>下一步是什么？改进是永无止境的努力。因此，我们认为通过利用<a href="https://github.com/ACloudGuru/blog-acg-graphql-evolution/tree/master/03-federation" target="_blank" rel="noreferrer noopener"> Apollo Federation </a>，我们可以将我们的性能和交付时间向前推进一步。</p><h4 id="h-about-the-author">关于作者</h4><p>Dale自2015年以来一直是一名无服务器开发者，当时无服务器框架仍被称为Jaws。他对无服务器系统如何帮助开发人员减少构建高弹性系统的时间特别感兴趣，尽管他们说戴尔喜欢无服务器的真正原因是因为他可以舒服地睡一整夜。</p></div></div>    
</body>
</html>