<html>
<head>
<title>Getting started with the Amazon Aurora Serverless Data API | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Amazon Aurora无服务器数据API入门|云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/getting-started-with-the-amazon-aurora-serverless-data-api#0001-01-01">https://acloudguru.com/blog/engineering/getting-started-with-the-amazon-aurora-serverless-data-api#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p id="c92d">在本文的截屏视频中，我们将介绍使用Data API创建Aurora无服务器数据库的三种方法。我们还将介绍连接到支持数据API的Aurora无服务器数据库的四种方法。</p><p id="c719">让我们快速回顾一下Amazon Aurora提供了什么，为什么是无服务器数据库，并回答，什么是数据API，为什么我应该关心？</p><h2 id="29e5">关于亚马逊极光</h2><p id="b466">Amazon Aurora是一个为云构建的MySQL和PostgreSQL兼容的关系数据库<a href="https://aws.amazon.com/relational-database/" target="_blank" rel="noreferrer noopener">T1，它结合了传统企业数据库的性能和可用性以及开源数据库的简单性和成本效益。</a></p><p id="183f"><strong>为什么亚马逊极光没有服务器？<br/> </strong>亚马逊Aurora无服务器是为<a href="https://aws.amazon.com/rds/aurora/" target="_blank" rel="noreferrer noopener">亚马逊Aurora </a> (MySQL兼容版)提供的按需、自动扩展配置。数据库将自动启动、关闭，并根据您的应用需求增加或减少容量。对于不频繁、间歇性或不可预测的工作负载，这是一个简单、经济高效的选择。</p><p id="7f70"><strong>什么是亚马逊Aurora无服务器数据API？<br/></strong>Data API是Aurora无服务器数据库之上的新托管API层，允许您直接连接MySQL或PostgreSQL数据库。它还允许您通过HTTP从任何应用程序执行SQL语句，而无需使用MySQL驱动程序、插件或管理连接池或VPC。</p><p id="0da0">可以将数据API看作是与关系数据交互的完全托管的API。当Data API连接到您的无服务器集群时，您还可以继承数据库的自动伸缩、可用性和备份，以及在不使用时暂停数据库。</p><p id="a0e6">这是这篇文章的视频版本。尽情享受吧！</p><figure class="wp-block-embed is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio"><p class="wp-block-embed__wrapper"> </p></figure><p/><hr class="wp-block-separator is-style-dots"/><h3 id="366f">使用数据API创建Aurora无服务器数据库的三种方法:</h3><p id="942f">我个人最喜欢的是选项2 CloudFormation for deployment，因为您可以部署可预测的资源(与手动创建相比，不会遗漏任何步骤)，并且可以在CloudFormation模板中添加额外的AWS服务和权限。</p><p id="422e"><strong>选项#1:亚马逊RDS控制台— <em>手动<br/></em></strong>RDS控制台是一种快速部署资源的方式，按照以下说明只需几分钟即可完成:</p><p id="e63a"><strong>创建新的Aurora无服务器集群</strong>:</p><ol><li>启动亚马逊RDS控制台。</li><li>选择<strong>亚马逊极光引擎。</strong></li><li>选择<strong>兼容MySQL 5.6的</strong>(无服务器的唯一选项)，然后选择<strong>下一步</strong>。</li><li>选择<strong>无服务器</strong>作为容量类型，并提供集群名称和主凭据，然后选择<strong>下一步。</strong></li><li>保留所有默认值，选择<strong>创建数据库。</strong></li></ol><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/e39dc3547efa850d58ae032f0e76250c.png" alt="" class="wp-image-42013" data-original-src="http://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_OVuVuYPpY23YK0sOtsSEjw.gif"/><figcaption>Screencast for creating an Aurora Serverless Cluster via the RDS Console</figcaption></figure></div><p id="4bbb"><strong>启用数据API(针对现有的Aurora无服务器集群):<br/> </strong>我们将通过RDS管理控制台为新创建的Aurora无服务器集群手动启用数据API。希望这是暂时的，直到我们可以使用EnableHTTPEndpointAPI参数通过CloudFormation模板启用数据API。同时…</p><ol><li>启动<a href="https://console.aws.amazon.com/rds/home?region=us-east-1#databases:" target="_blank" rel="noreferrer noopener"> RDS管理控制台</a></li><li>选择您的集群(即使它显示数据库)</li><li>选择右上角的<strong>修改</strong>按钮</li><li>选择网络&amp;安全部分下的<strong>数据API </strong></li><li>选择<strong>继续</strong>按钮</li><li>在修改计划下选择<strong>立即应用</strong></li><li>选择“<strong>修改集群</strong>单选按钮</li></ol><p id="6543"><strong>选项#2:云形成— <em>自动化<br/> </em> </strong>云形成是以自动化方式部署一致环境的最佳方式。该解决方案包括基于GitHub repo <a href="https://github.com/mobilequickie/rds-aurora-mysql-serverless" target="_blank" rel="noreferrer noopener">中提供的CloudFormation模板创建CloudFormation堆栈。</a></p><p id="861c">该模板包含了为部署Aurora无服务器数据库而定义的所有参数，只需点击几下鼠标。除了创建无服务器数据库之外，该模板还创建了一个AWS Lambda函数(在Node.js 8.10中编写)，以使用新的<a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/RDSDataService.html" target="_blank" rel="noreferrer noopener"> AWS RDSDataService API </a>访问启用了数据API的数据库。稍后，当我们在下面的解决方案3中连接到一个启用了数据API的数据库时，会有更多关于Lambda函数的内容。</p><p id="e926">CloudFormation模板将提供以下资源:</p><ul><li>极光无服务器(MySQL) <strong>集群</strong></li><li>极光无服务器(MySQL) <strong>数据库</strong></li><li>AWS <strong> Lambda函数</strong>，用于使用<a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/RDSDataService.html" target="_blank" rel="noreferrer noopener"> AWS RDSDataService API </a>通过数据API连接到您的数据库。</li><li><strong> IAM策略</strong>用于RDSDataService API的Lambda执行，CloudWatch日志，从AWS Secrets只读获取数据库主凭证。</li></ul><p id="7a89"><strong>开始使用CloudFormation <br/> </strong>按照本<a href="https://github.com/mobilequickie/rds-aurora-mysql-serverless" target="_blank" rel="noreferrer noopener"> GitHub repo </a>中概述的两(2)个步骤在您的AWS帐户中部署资源。</p><p id="0df8">第一步是通过CloudFormation堆栈部署资源，第二步是为创建的Aurora无服务器数据库启用数据API。</p><ul><li><strong>第一步</strong>:在这里通过GitHub repo <a href="https://github.com/mobilequickie/rds-aurora-mysql-serverless#step-1-create-an-aurora-serverless-database-via-cloudformation" target="_blank" rel="noreferrer noopener">部署CloudFormation栈。</a></li><li><strong>第二步</strong>:按照GitHub第二步指令<a href="https://github.com/mobilequickie/rds-aurora-mysql-serverless#step-2-enable-data-api-for-your-aurora-serverless-cluster" target="_blank" rel="noreferrer noopener">启用数据API这里</a>。</li></ul><p id="68d9"><strong>选项#3: AWS CLI或SDK — <em>脚本化<br/></em></strong>AWS CLI或AWS SDK可用于创建您的资源，只需几行代码。下面是创建新的Aurora无服务器集群的完整AWS CLI语句:</p>  <p>一旦创建了Aurora无服务器集群，请按照上一节中的<strong>步骤2 </strong> : <em>启用数据API </em>，现在您就有了一个启用了数据API的Aurora无服务器数据库。</p><hr class="wp-block-separator is-style-dots"/><h3 id="ad4d">使用数据API连接到数据库的四种方法</h3><p id="122e"><strong>解决方案#1:数据查询</strong>(通过RDS控制台)</p><ol><li>启动亚马逊<a href="https://console.aws.amazon.com/rds/home?region=us-east-1" target="_blank" rel="noreferrer noopener"> RDS管理控制台</a>。</li><li>选择查询编辑器。</li><li>在Connect to Database窗口中，选择您的集群，提供您的主用户、主口令和数据库名称(可选)。</li><li>选择<strong>连接到数据库</strong>。</li></ol><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/ee6ffdc5f9b3b96061dabf7d5ed9eb5a.png" alt="" class="wp-image-42008" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_5Hk6ZUotNKJ44vu0kHdy7w.png"/></figure><p id="0317"><strong>注意</strong>:当您第一次提供集群凭证时，服务会自动为您创建一个AWS密码，之后每次通过查询编辑器访问该集群时，服务都会使用该AWS密码来获取该集群的主用户凭证。</p><p id="2c60">一旦进入查询编辑器，<strong>选择清除按钮</strong>并输入:</p><pre class="wp-block-code"><code>use MarketPlace;
select * from Customers;</code></pre><p id="fa37">选择<strong>运行</strong>。</p><p id="1d2b">如果您有一个包含数据的<em>客户</em>表，结果如下:</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/630a8198f10c70ae37287c9a5cbf696d.png" alt="" class="wp-image-42011" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_IGRJXnY8OwaxWOODu8lM_Q.png"/><figcaption>SQL statement in RDS Console — Query Editor</figcaption></figure></div><p id="dc1c">提示:当您需要验证表的内容或者只是执行一些快速的SQL语句时，查询编辑器是一个很好的工具。</p><p id="ea1f"><strong>解决方案#2: AWS CLI <br/> </strong>使用您自己的集群arn、机密arn、数据库名称和您选择的SQS选择语句修改提供的AWS CLI脚本。</p>  <p id="4820"><strong>解决方案#3: AWS Lambda函数<br/> </strong>一旦您部署了一个启用了Aurora无服务器数据API的数据库，您就可以使用RDSDataService API，通过一个简单的AWS Lambda函数轻松连接并执行任何SQL语句。</p><p id="3ba8">这个函数不需要在亚马逊VPC中，也不需要任何MySQL驱动程序或担心连接池。只需将SQL语句作为HTTP请求，Aurora Serverless会处理剩下的事情！</p><p id="4f4c">开始使用Lambda函数通过数据API进行连接:</p><p id="55a7">您可以使用上面的deploy <strong>选项# 2—</strong><a href="https://github.com/mobilequickie/rds-aurora-mysql-serverless" target="_blank" rel="noreferrer noopener"><strong>cloud formation</strong></a>来提供一个数据库、一个Lambda函数，并填写环境变量来开始，或者…您可以<strong>复制这段代码并直接部署到Lambda</strong>。</p><p id="e95c">如果您手动这样做，您将需要填充Lambda环境变量以匹配您的Aurora无服务器环境，如集群Arn、DB name和AWS Secrets arn。</p><p id="8fbf">下面是针对启用了Aurora无服务器数据API的数据库执行SQL语句的完整代码。同样，确保提供环境变量，然后传入如下内容:</p><pre class="wp-block-code"><code>{ "sqlStatement": "SELECT * FROM &lt;YOUR-TABLE-NAME&gt;" }</code></pre><p>Lambda函数将使用从AWS Secrets中提取的主凭证连接到您的数据库，并返回一个JSON响应。就这么简单！</p>  <p id="c0f4"><strong>解决方案#4: AWS AppSync <br/> </strong>通过AWS AppSync构建GraphQL API时，您现在可以直接访问启用了无服务器数据API的数据库作为数据源，并且……app sync将根据现有的数据库表设计为您生成一个GraphQL模式！</p><p id="a8ed">对于这个解决方案，我们将使用AWS Amplify CLI的新的<a href="https://aws-amplify.github.io/docs/cli/graphql?sdk=ios#automatically-import-existing-datasources" target="_blank" rel="noreferrer noopener"><em>add-graphql-data source</em></a>插件，该插件自动获取您的无服务器数据库表并创建/更新GraphQL模式，生成适当的变化、查询和订阅，并将您的数据库设置为现有GraphQL API的graph QL数据源。是的，请吧。</p><p id="623c">在我们使用插件之前，我们希望确保我们的Aurora无服务器数据库至少有一个表。如果数据库不存在，让我们现在通过使用RDS控制台中的RDS查询编辑器来创建它们，然后我们将切换到Amplify CLI+<em>add-graph QL-data source</em>插件。</p><p id="9505">在这里，我们将使用RDS查询编辑器来创建一个数据库和示例表。如果您在前面的步骤中已经有了数据库和表格，请转到下面的[放大CLI —安装CLI]部分。</p><ul><li>启动亚马逊<a href="https://console.aws.amazon.com/rds/home?region=us-east-1" target="_blank" rel="noreferrer noopener"> RDS管理控制台</a></li><li>选择<strong>查询编辑器</strong></li><li>在<strong>连接到数据库</strong>窗口中，选择您的集群，提供您的主用户、主密码和数据库名称(可选)。</li><li>选择<strong>连接数据库。</strong></li></ul><p id="e56f">在查询编辑器窗口中，运行以下命令:</p><p id="5492">如果您还没有创建数据库“市场”,请创建它。</p><pre class="wp-block-code"><code>CREATE DATABASE MarketPlace;</code></pre><p>创建新的客户表。</p><pre class="wp-block-code"><code>USE MarketPlace;
CREATE TABLE Customers (
  id int(11) NOT NULL PRIMARY KEY,
  name varchar(50) NOT NULL,
  phone varchar(50) NOT NULL,
  email varchar(50) NOT NULL
);</code></pre><p id="17f3">现在我们有了一个数据库和一个Customers表，我们现在可以使用<em> add-graphql-datasource </em>插件来生成一个graphql模式，将数据库添加为datasource，并基于[Customers]表添加变异、查询和订阅。</p><p id="3dc0">下面是<em> add-graphql-datasource </em>插件的工作方式:</p><p id="51dc"><strong> Amplify CLI —安装CLI <br/> </strong>如果你以前没有安装过AWS Amplify CLI，这里有一个快捷方式。如果您安装了AWS CLI，Amplify CLI将利用这些凭证，因此不需要<em> amplify configure </em>。</p><pre class="wp-block-code"><code>$ npm install -g @aws-amplify/cli
$ amplify configure</code></pre><p><strong>放大CLI — Init <br/> </strong>在你的iOS项目文件夹的根目录下启动Mac终端。现在，我们将使用下面的Amplify命令初始化我们的AWS后端项目。</p><pre class="wp-block-code"><code>$ amplify init</code></pre><p id="62f3">将指导您完成设置项目的过程。</p><p id="79da"><strong>放大CLI —添加API </strong></p><pre class="wp-block-code"><code>$ amplify add api</code></pre><p><strong>放大CLI —添加GraphQL数据源</strong></p><pre class="wp-block-code"><code>$ amplify api add-graphql-datasource</code></pre><p>现在，让我们使用<a href="https://console.aws.amazon.com/appsync/home" target="_blank" rel="noreferrer noopener"> AppSync控制台</a>中的查询工具在<em> Customers </em>表中创建一个新客户。</p>  <figure class="wp-block-image size-large"><img loading="lazy" src="../Images/30336eac463a9482647111f34a26b68f.png" alt="" class="wp-image-42014" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_uZ3Sft7rGiKyOMk_K6p-yw.png"/><figcaption>AppSync Queries — in action</figcaption></figure><p>然后，我们可以在<a href="https://console.aws.amazon.com/rds/home" target="_blank" rel="noreferrer noopener"> RDS控制台</a>的查询编辑器中查询<em> Customers </em>表，以进行仔细检查。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/aeed2a8ac953635613957942dfe3df62.png" alt="" class="wp-image-42010" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_IGRJXnY8OwaxWOODu8lM_Q-1.png"/><figcaption>Amazon RDS Query Editor — Aurora Serverless Data API SQL Statement</figcaption></figure><p id="ff72">现在我们已经有了模式、突变、查询、订阅，以及作为GraphQL API数据源的无服务器Aurora数据库，我们可以开始使用带有生成代码的移动或web客户端来与这些结构化数据进行交互了！</p><p>SQL query select调用可以通过RDS Data API返回多少行和数据是有限制的(1000行或1MB的数据)。使用RDS数据API的另一种方法是使用独立的MySQL Python客户端PyMySQL，它为您提供了建立连接、查询和在MySQL db(在我们的例子中是无服务器RDS DB)上获得大量操作的灵活性。尝试我们的动手实验室，使用Python和PyMySQL集成Aurora和Lambda函数。</p><h3 id="1879">结论</h3><p id="3fd2">Data API允许任何开发人员通过对数据库的更多控制、更少的管理、没有驱动程序或连接池来利用数据的结构化集合，并且以HTTP请求的形式执行SQL语句是一个游戏规则改变者。</p><hr class="wp-block-separator is-style-wide"/><h2 class="has-text-align-center" id="h-get-the-skills-you-need-for-a-better-career">获得更好职业所需的技能。</h2><p class="has-text-align-center">掌握现代技术技能，获得认证，提升您的职业生涯。无论您是新手还是经验丰富的专业人士，您都可以通过实践来学习，并在ACG的帮助下推进您的云计算职业生涯。</p><hr class="wp-block-separator is-style-wide"/></div></div>    
</body>
</html>