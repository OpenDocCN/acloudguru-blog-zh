<html>
<head>
<title>Fundamentals of Serverless Functions &amp; Applications | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>无服务器功能和应用基础|云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/serverless-functions-in-depth#0001-01-01">https://acloudguru.com/blog/engineering/serverless-functions-in-depth#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p id="h-in-this-tutorial-you-ll-learn-the-fundamentals-of-serverless-functions-serverless-applications-while-this-tutorial-is-focused-on-front-end-developers-new-to-the-serverless-space-this-is-a-good-deep-dive-for-anyone-looking-to-learn-more-about-serverless-functions-in-general">在本教程中，您将学习无服务器功能和无服务器应用程序的基础。虽然本教程主要针对不熟悉无服务器领域的前端开发人员，但对于那些希望了解更多关于无服务器功能的人来说，这是一个很好的深度学习。</p>  <hr class="wp-block-separator is-style-dots"/><p id="5969">在加州大学伯克利分校最近发表的一篇名为“<em>简化的云编程:关于无服务器计算的伯克利观点</em>的文章中，做出了这样的预测:</p><blockquote class="wp-block-quote"><p><mark> <strong>“无服务器计算将成为云时代的默认计算模式，在很大程度上取代有服务器计算，从而结束客户端-服务器时代。”</strong>T3】</mark></p></blockquote><p id="44c9">无服务器<a href="https://www.cbinsights.com/research/16-enterprise-it-trends-2019/" target="_blank" rel="noreferrer noopener">是云中所有服务中增长最快的</a>。无服务器计算产业<a href="https://www.cbinsights.com/research/serverless-startups-to-watch-expert-intelligence/" target="_blank" rel="noreferrer noopener">预计将在2021年增长到77亿美元</a>，而2016年为19亿美元。</p><h3 id="06dc">无服务器应用程序</h3><p id="a6f4">那么什么是无服务器应用程序呢？这是我的定义:</p><p id="9a7a">无服务器应用运行在无状态计算容器中，这些容器是事件驱动的、短暂的(作为服务的功能，可能持续一次调用)，并且完全由您选择的云提供商管理。这些应用程序无缝扩展，不需要任何服务器操作。</p><p id="2238">这个想法是你以函数的形式编写你的应用程序代码。当您部署您的功能时，您需要一种方法以事件的形式调用它。</p><p id="4a44">如果从客户端应用程序调用代码，该事件可能来自某种类型的API网关(http请求)，来自另一个无服务器功能的<em>事件，或者来自另一个云服务的事件(例如在上传某些内容后来自亚马逊S3)。</em></p><p id="a68d">您的云提供商代表您执行功能代码。云提供商还负责供应和管理服务器，以便在调用时运行代码。</p><h3 id="2059">前端开发人员面临的无服务器挑战</h3><p id="da45">对于许多刚接触云计算的<a href="https://acloudguru.com/blog/engineering/why-do-you-care-so-much-about-your-backend-when-your-customers-dont">前端开发人员&amp;开发人员</a>来说，问题在于用户界面&amp;开始使用这种类型的架构的过程并不像它可能的那样简单明了&amp;工具超出了我们习惯使用的领域。</p><p id="0693">在云提供商的基础上构建了许多抽象概念来简化这一过程——例如，无服务器框架、Terraform和无服务器应用模型(SAM)等提供了框架和工具来简化这些资源的供应和部署。</p><p id="77af">虽然很多时候你仍然需要理解基本的术语&amp;行话来开始使用这些工具。</p><p id="2757"><a href="https://aws-amplify.github.io/" target="_blank" rel="noreferrer noopener"> Amplify框架</a>提供了一个抽象层，我认为它非常适合从您的前端环境部署&amp;云功能。我觉得这种方法不仅对于前端开发人员来说是完美的，而且与传统的做事方式相比是一个飞跃。</p><p id="1aad">在本教程中，我将使用Amplify框架在AWS 上创建、部署、更新、连接和删除<a href="https://acloudguru.com/blog/engineering/processing-an-arbitrary-number-of-jobs-with-aws-step-functions">云函数的整个过程。</a></p><h3 id="1e7d">调用函数</h3><p id="c935">部署无服务器功能后，该功能本身需要有一种被调用的方式。同样，调用这些函数有三种主要方式:</p><ol><li>通过HTTP端点</li><li>通过<a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/Lambda.html" target="_blank" rel="noreferrer noopener"> aws-sdk </a>(多次来自另一个功能)</li><li>来自云中的事件(上传图像时的S3，在您的数据库中创建项目时，等等..)</li></ol><p id="56db">我们将从前端应用程序调用该函数，因此我们将通过HTTP端点与它进行交互。您通常需要做几件事情来让它与AWS一起工作:</p><ol><li>创建函数。</li><li>在API网关中创建API端点</li><li>配置API Gateway将http请求转发给函数。</li></ol><p id="ca48">Amplify框架允许我们用一个命令设置所有这些。<strong>我们开始吧！</strong></p><h2 id="a07f">入门指南</h2><p id="10e1">我们将要部署的函数将是一个从另一个API 获取<a href="https://shibe.online/" target="_blank" rel="noreferrer noopener">柴犬图片的函数。柴犬API没有启用CORS，所以我们不能直接从浏览器与API交互。这种情况的明显例子是在服务器上构建它，所以我们将在一个无服务器的函数中这样做。</a></p><p id="99eb">我们要做的第一件事是创建一个客户端应用程序。您可以使用您选择的框架(即React、Vue、React Native、Angular等..)对于这个项目。从这个客户端项目中，我们将向我们创建的无服务器应用程序发出请求。</p><p id="c09b">一旦你创建了你将用来测试你的功能的客户端应用程序，进入这个目录&amp;进入下一步。</p><h3 id="734f">安装和配置Amplify CLI</h3><p id="492f">我们接下来要做的是安装和配置Amplify CLI</p><pre class="wp-block-code"><code>npm install -g @aws-amplify/cli
amplify configure</code></pre><blockquote class="wp-block-quote"><p>如果这是你第一次配置Amplify &amp;想要了解它是如何工作的，看看这个视频。</p></blockquote><p id="6456">一旦安装并配置了CLI，我们将初始化一个新的Amplify项目。这将引导我们完成几个步骤&amp;询问我们希望项目如何建立的问题。</p><pre class="wp-block-code"><code>amplify init</code></pre><blockquote class="wp-block-quote"><p>CLI应该检测您正在工作的项目的类型&amp;在您选择了应用程序名称、环境名称和IDE选项之后，自动填充大多数字段。</p></blockquote><p id="c633"><code>amplify init</code>命令是Amplify powered cloud应用程序的一次性初始化步骤。您为每个项目(JavaScript、iOS或Android)运行一次，将您的应用程序与AWS后端连接起来。要了解这个命令在幕后做什么，请查看文档。</p><p id="8a80">一旦我们初始化了Amplify项目，我们就可以创建第一个Lambda函数了。为此，请运行以下命令:</p><pre class="wp-block-code"><code>amplify add api
? Please select from one of the below mentioned services REST
? Provide a friendly name for your resource to be used as a label for this category in the project shibaapi
? Provide a path (e.g., /items) /pictures
? Choose a Lambda source ❯ Create a new Lambda function
? Provide a friendly name for your resource to be used as a label for this category in the project: shibafunction
? Provide the AWS Lambda function name: shibafunction
? Choose the function template that you want to use: Serverless express function
? Do you want to edit the local lambda function now? n
? Restrict API access n
? Do you want to add another path? n</code></pre><blockquote class="wp-block-quote"><p>刚刚发生了什么？Amplify CLI提供了两种资源:AWS Lambda函数&amp;API网关配置，允许我们通过HTTP端点与之交互。在文件夹<strong> amplify/backend </strong>中，我们现在应该看到两个新文件夹:<strong> api </strong> &amp; <strong>函数</strong>。</p></blockquote><p id="6ab2">现在，我们可以通过运行amplify <code>push</code>命令在我们的帐户中创建这些资源:</p><pre class="wp-block-code"><code>amplify push</code></pre><p id="fe9e">现在我们的Lambda函数已经部署好了，并且已经上线了！</p><h2 id="b446">λ函数</h2><p id="1bb1">Lambda函数的基础代码是CLI为我们创建的，位于<strong>amplify/back end/function/shiba function</strong>。</p><p id="4431">Lambda函数通常有一个所谓的<a href="https://docs.aws.amazon.com/lambda/latest/dg/nodejs-prog-model-handler.html" target="_blank" rel="noreferrer noopener">处理程序</a>函数，负责调用Lambda函数。你可以在<strong>shiba function/src/index . js</strong>中看到我们的handler函数。如果我们愿意，我们可以直接引用&amp;来使用这个函数，但是在我们的例子中，我们使用的是<a href="https://github.com/awslabs/aws-serverless-express" target="_blank" rel="noreferrer noopener">无服务器快速框架</a>:</p><pre class="wp-block-code"><code>// amplify/backend/function/shibafunction/src/index.js
const awsServerlessExpress = require('aws-serverless-express');
const app = require('./app');
const server = awsServerlessExpress.createServer(app);
exports.handler = (event, context) =&gt; {
  console.log(`EVENT: ${JSON.stringify(event)}`);
  awsServerlessExpress.proxy(server, event, context);
};</code></pre><blockquote class="wp-block-quote"><p>上述代码会将所有请求转发到<strong> shibafunction/src/app.js </strong>中定义的路由。</p></blockquote><p id="55e5">无服务器express框架基本上允许我们创建一个<a href="https://expressjs.com/" target="_blank" rel="noreferrer noopener"> express应用程序</a>,并在Lambda函数中完成路由&amp; http动词，因此我们可以在其中做更多的事情，而不仅仅是一个基本的JavaScript函数。</p><p id="e187">如果你在<strong> app.js </strong>中查找，你会看到为我们创建的所有路线。我们来看看<strong>app . get</strong>&amp;<strong>app . post</strong>:</p><pre class="wp-block-code"><code>// amplify/backend/function/shibafunction/src/app.js
app.get('/pictures', function(req, res) {
  // Add your code here
  res.json({success: 'get call succeed!', url: req.url});
});
app.post('/pictures', function(req, res) {
  // Add your code here
  res.json({success: 'post call succeed!', url: req.url, body: req.body})
});</code></pre><p id="aa4c">在这些函数中，我们有一个可用的请求和响应(req &amp; res)参数。</p><p id="1f4a">请求(<code>req</code>)将在所有具有<code>event</code>&amp;<code>context</code>的操作(<code>req.apiGateway</code>)上有一个<code>apiGateway</code>属性。</p><ul><li><code><a href="https://docs.aws.amazon.com/lambda/latest/dg/nodejs-prog-model-context.html" target="_blank" rel="noreferrer noopener">context</a></code>包含关于函数本身的所有元数据。</li></ul><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/d1d98699e14603811c50810a7ba0185c.png" alt="" class="wp-image-42270" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_aHdh7zzvsIVXKYnRLKVOFg.png"/></figure><ul><li><code>event</code>表示导致lambda调用的事件或触发器。该事件将包含关于API调用的数据&amp;元数据，在我们的例子中，像头、路径、&amp;甚至用户数据，如果API受身份验证保护的话。</li></ul><p id="df73">在put、post或delete操作中，我们还可以访问body对象。主体将包含我们想要发送给API的任何数据(我们稍后将研究如何发送主体对象)。</p><p id="5e4c">那么我们如何调用这个函数？我们用Amplify 的<a href="https://aws-amplify.github.io/docs/js/api#using-rest" target="_blank" rel="noreferrer noopener"> API类别来做。它是这样工作的。API有六种不同类型的操作:</a></p><ul><li>API.get</li><li>API.post</li><li>API.put</li><li>API.delete</li><li>API.head</li><li>API.graphql</li></ul><blockquote class="wp-block-quote"><p>因为我们使用的是REST API，所以我们不会使用<code><a href="https://aws-amplify.github.io/docs/js/api#using-aws-appsync" target="_blank" rel="noreferrer noopener">graphql</a></code>操作。</p></blockquote><p id="fbcc">要调用一个端点，需要设置<code>apiName</code>(必选)、<code>path</code>(必选)和<code>options</code>(可选)参数，每个方法返回一个承诺:</p><pre class="wp-block-code"><code>// definition: API.get(apiName, path, options)
// Use this in your client application to interact with the API
import { API } from 'aws-amplify'
API.get('shibaAPI', '/pictures')
  .then(response =&gt; console.log({ response }))
  .catch(err =&gt; console.log({ err }))
// or
const response = await API.get('shibaAPI', '/pictures')
console.log({ response })</code></pre><p>如果我们使用put、post或delete，我们也可以在第三个参数中传递主体:</p><pre class="wp-block-code"><code>const body = { userId: '22' }
API.post('shibaAPI', '/pictures', { body }}</code></pre><p>如果我们想传递标题:</p><pre class="wp-block-code"><code>const headers = { username: 'naderdabit' }
API.get('shibaAPI', '/pictures', { headers })</code></pre><p>或者我们可以两者都通过:</p><pre class="wp-block-code"><code>const body = { userId: '22' }
const headers = { username: 'naderdabit' }
API.post('shibaAPI', '/pictures', { body, headers }}</code></pre><h2 id="1fff">创建我们的自定义Lambda函数</h2><p id="5b21">现在，让我们更新我们的函数来调用柴犬API。</p><p id="04d0">我们需要做的第一件事是在我们的函数包中安装<a href="https://github.com/axios/axios" target="_blank" rel="noreferrer noopener"> axios </a>,这样我们就可以从它发出http请求。导航到<strong>amplify/back end/function/shiba function/src&amp;从命令行安装:</strong></p><pre class="wp-block-preformatted">yarn add axios
# or
npm install axios</pre><p>接下来，我们需要在lambda函数中打开app.js。这里，我们将更新app.post函数来调用API</p><pre class="wp-block-code"><code>// amplify/backend/function/shibafunction/src/app.js
// first require axios at the top of the file
const axios = require('axios')
// next, update the app.post function
app.post('/pictures', async function(req, res) {
  let number = 5
  if (req.body.number) {
    number = req.body.number
  }
  
  try {
    const response = await axios.get(`http://shibe.online/api/shibes?count=${number}`)
    const data = response.data
    res.json({err: null, success: 'post call succeed!', data })
  } catch (err) {
    res.json({ err: err })
  }
});</code></pre><p>现在，因为我们已经改变了我们的功能代码，我们需要在我们的后端更新它。这很容易做到，我们只需再次运行<code>push</code>命令:</p><pre class="wp-block-code"><code>amplify push</code></pre><blockquote class="wp-block-quote"><p>这将把后端文件夹中的任何更改更新到AWS后端。</p></blockquote><p id="6eca">现在，我们应该能够从我们的客户端应用程序调用API了。让我们从API中请求30张图片:</p><pre class="wp-block-code"><code>const shibaData = await API.post('shibaapi', '/pictures', { body: { number: 30 }})
console.log('shibaData:', shibaData)
# or
API.post('shibaapi', '/pictures', { body: { number: 30 }})
  .then(data =&gt; console.log('data: ', data))
  .catch(err =&gt; console.log('error:', err))</code></pre><h2 id="7585">测试</h2><p id="441b">现在我们已经有了一个可以运行的功能，如果我们想在将它部署到我们的环境之前在本地进行更改和测试，会怎么样呢？嗯，我们很容易做到。Amplify有一个命令允许我们在本地调用和测试lambda函数。</p><p id="347a">因为我们的功能本质上只是一个express应用程序，所以我们可以启动我们的express服务器&amp;通过curl命令或Postman之类的工具向它发出请求。</p><h3 id="5abe">调用函数</h3><p id="1d16">让我们调用一个lambda函数，在我们的例子中它将启动express服务器。</p><p id="9398"><strong>设置端口<br/> </strong>如果您正在运行React应用程序，默认端口被设置为3000，这与express应用程序将要运行的默认端口相同。如果您想指定不同的端口，您可以在文件底部的<strong> app.js中进行更改:</strong></p><pre class="wp-block-code"><code>// shibafunction/src/app.js
app.listen(3001, function() {
  console.log("App started")
});</code></pre><p>现在，让我们调用这个函数:</p><pre class="wp-block-code"><code>amplify function invoke shibafunction</code></pre><ul><li>？提供包含您的处理函数的脚本文件的名称:<strong> index.js </strong></li><li>？提供要调用的处理函数的名称:<strong>处理函数</strong></li></ul><p id="4e7b">这将启动express服务器。我们可以发出curl请求，或者使用类似Postman的东西来发出请求:</p><h3 id="dfd9"><strong>获取请求</strong></h3><pre class="wp-block-code"><code>curl ‘localhost:3000/pictures’</code></pre><h3 id="h-post-request">发布请求:</h3><pre class="wp-block-code"><code>curl ‘localhost:3000/pictures’ -X POST</code></pre><h3 id="h-post-request-with-body"><strong>发布请求，正文:</strong></h3><pre class="wp-block-code"><code>curl ‘localhost:3000/pictures’ -X POST \
-d ‘{ “number”: 7 }’ -H “Content-Type: application/json”</code></pre><h2 id="2210">更新API</h2><p id="5bd3">如果我们想改变我们的API，比如添加额外的路由或添加身份验证，该怎么办？为此，您可以从CLI运行<code>update</code>命令:</p><pre class="wp-block-code"><code>amplify update api</code></pre><p id="d329">这将引导您完成更新API的几个步骤。如果您想要添加或更改路由，您需要在将新路由添加到您的<strong> &lt;函数name &gt; /src/app.js </strong>之前，首先使用该命令更新配置。文件将工作。</p><h2 id="ba47">多重环境</h2><p id="940f">如果您想通过创建一个新功能进行试验&amp;在不影响您当前环境的情况下进行测试，该怎么办？</p><p id="e9ad">您可以克隆您当前的环境，这将部署全新的沙盒资源，允许您测试、部署和删除新功能，而不会影响您的主环境。</p><p id="3b95">要了解更多关于如何设置多个环境的信息，请查看这里的文档。</p><h2 id="80a2">删除功能</h2><p id="a998">现在我们已经启动并运行了我们的应用程序，当我们想要删除我们的函数时会发生什么呢？我们可以使用amplify CLI来做到这一点。</p><h3 id="1349">删除函数&amp; api</h3><pre class="wp-block-code"><code>amplify remove api
amplify remove function
amplify push</code></pre><h3 id="h-deleting-the-entire-project-all-resources">删除整个项目和所有资源</h3><h2 id="h-conclusion">结论</h2>  <p id="539b">无服务器是当今最有趣和发展最快的技术之一。我真的很高兴能在这个领域工作&amp;我觉得不管你为什么平台或云提供商构建，花时间学习这个真的是很好的投资——微软和谷歌也提供他们自己风格的无服务器。</p><p id="b3d5">要阅读我关于如何利用无服务器构建全栈应用的想法，请查看我的帖子<a href="https://medium.com/@dabit3/full-stack-development-in-the-era-of-serverless-computing-c1e49bba8580" target="_blank" rel="noreferrer noopener">无服务器计算时代的全栈开发</a>。</p><p id="6059">Amplify还支持许多其他类别，如认证、GraphQL、S3等等。要了解更多关于这些类别的信息，请点击这里的文档<a href="https://aws-amplify.github.io/docs/js/start" target="_blank" rel="noreferrer noopener"/>。</p><hr class="wp-block-separator"/><h2 class="has-text-align-center" id="h-get-the-skills-you-need-for-a-better-career">获得更好职业所需的技能。</h2><p class="has-text-align-center">掌握现代技术技能，获得认证，提升您的职业生涯。无论您是新手还是经验丰富的专业人士，您都可以通过实践来学习，并在ACG的帮助下推进您的云计算职业生涯。</p><hr class="wp-block-separator"/><p><em>我的名字是</em> <a href="https://twitter.com/dabit3" target="_blank" rel="noreferrer noopener"> <em>纳德达比特</em> </a> <em>。我在</em><a href="https://aws.amazon.com/mobile/" target="_blank" rel="noreferrer noopener"><em>AWS Mobile</em></a><em>工作，负责类似</em><a href="https://aws.amazon.com/appsync/" target="_blank" rel="noreferrer noopener"><em>AWS app sync</em></a><em>和</em><a href="https://github.com/aws/aws-amplify" target="_blank" rel="noreferrer noopener"><em>AWS Amplify</em></a><em>这样的项目。我也是</em><a href="https://www.manning.com/books/react-native-in-action" target="_blank" rel="noreferrer noopener"><em>React Native in Action</em></a><em>&amp;React Native Training</em><a href="https://medium.com/react-native-training" target="_blank" rel="noreferrer noopener"><em>React Native Training</em></a><em>&amp;</em><a href="https://medium.com/open-graphql" target="_blank" rel="noreferrer noopener"><em>OpenGraphQL</em></a><em>的作者。</em></p></div></div>    
</body>
</html>