<html>
<head>
<title>How to run serverless PHP on Azure | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何在云专家Azure |上运行无服务器PHP</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/how-to-run-serverless-php-on-azure#0001-01-01">https://acloudguru.com/blog/engineering/how-to-run-serverless-php-on-azure#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>随着<a rel="noreferrer noopener" href="https://docs.microsoft.com/azure/azure-functions/functions-custom-handlers?WT.mc_id=data-10498-alvidela" target="_blank"> Azure Functions自定义处理程序</a>的到来，你现在可以在Azure上运行PHP无服务器应用。在本文中，您将看到如何通过让您的PHP项目读取Azure函数来利用这一新功能。</p><h4 id="h-getting-started">入门指南</h4><h2 id="h-structure-of-a-serverless-app">无服务器应用程序的结构</h2><p>Azure无服务器应用具有以下文件夹结构:</p><pre class="wp-block-code"><code>├── HttpTrigger
│   ├── function.json
│   └── index.php
├── QueueTrigger
│   ├── function.json
│   └── index.php
├── deploy.sh
├── host.json
├── local.settings.json</code></pre><p>每一个无服务器功能都存在于类似于<code>HttpTrigger</code>和<code>QueueTrigger</code>的文件夹中。在这些文件夹中，你将有两个文件<code>function.json</code>和<code>index.php</code>。</p><p>在<code>functions.json</code>中，您将指定函数如何被触发，它接收什么参数，以及它返回什么，而<code>index.php</code>是包含您的函数逻辑的文件。要了解更多关于Azure Functions无服务器应用的结构，请看本指南:<a href="https://docs.microsoft.com/azure/azure-functions/functions-reference?WT.mc_id=data-10498-alvidela"> Azure Functions开发者指南</a></p><p>对于PHP，这是我们感兴趣的，你需要在你的函数文件夹中有一个<code>index.php</code>文件，就像上面的<code>HttpTrigger</code>例子一样。您的PHP代码必须遵循这些约定:</p><pre class="wp-block-code"><code>&lt;?php
use Azserverless\Context\FunctionContext;

function run(FunctionContext $context) {
    $req = $context-&gt;inputs['req'];

    $context-&gt;log-&gt;info('Http trigger invoked');

    $query = $req['Query'];

    if (array_key_exists('name', $query)) {
        $name = $query['name'];
        $message = 'Hello ' . $query['name'] . '!';
    } else {
        $name = 'EMPTY';
        $message = 'Please pass a name in the query string';
    }

    $context-&gt;outputs['outputQueueItem'] = json_encode($name);
    $context-&gt;log-&gt;info(sprintf('Adding queue item: %s', $name));

    return [
        'body' =&gt; $message,
        'headers' =&gt; [
            'Content-type' =&gt; 'text/plain'
        ]
    ];
}
?&gt;</code></pre><p>您需要一个名为<code>run</code>的函数，它接受一个<code>FunctionContext</code>参数，该参数将包含您的函数接收到的输入，以及其他实用程序，如<a href="https://github.com/Seldaek/monolog" target="_blank" rel="noreferrer noopener">独白记录器</a>。您还可以在<code>$context</code>参数中设置<code>outputs</code>，就像代码对<code>outputQueueItem</code>所做的那样，添加一个值，该值将在这种特定情况下被转发到一个队列中。</p><p>那么，这个<code>FunctionContext</code>是从哪里来的呢？它来自专门为Azure PHP开发的新的<a href="https://github.com/videlalvaro/azserverless" target="_blank" rel="noreferrer noopener"> Azserverless </a>库。</p><p>转到您的项目根文件夹，并在您的<code>composer.json</code>中添加以下依赖项:</p><pre class="wp-block-code"><code>"require": {
    "videlalvaro/azserverless": "*"
}</code></pre><p>如果您没有安装composer，请遵循此处的说明<a href="https://getcomposer.org/doc/00-intro.md" target="_blank" rel="noreferrer noopener">。</a></p><p>然后在命令行上运行<code>composer.phar install</code>，这将获得所有需要的依赖项。</p><h2 id="h-configuring-azure-functions-for-php">为PHP配置Azure函数</h2><p>现在是时候告诉Azure函数如何运行你的PHP项目了。打开<code>host.json</code>。在该文件中，您应该添加一个顶级条目，指定该项目使用自定义处理程序运行:</p><pre class="wp-block-code"><code>    "customHandler": {
      "description": {
      "defaultExecutablePath": "php",
      "arguments": [
        "-S",
        "0.0.0.0:%FUNCTIONS_CUSTOMHANDLER_PORT%",
        "vendor/videlalvaro/azserverless/bin/serverless.php"
      ]
    },
    "enableForwardingHttpRequest": false
  },</code></pre><p>我们告诉Azure函数如何执行PHP，提供将请求转发给函数处理程序的<code>vendor/videlalvaro/azserverless/bin/serverless.php</code>文件的路径。</p><p>最后，我们需要告诉azure我们的应用程序将在<code>PHP 7.4</code>上运行。打开命令行，使用以下参数调用<a href="https://acloudguru.com/course/azure-cli-essentials"> Azure CLI </a>:</p><pre class="wp-block-code"><code>az webapp config set --name your_app_name --resource-group your_resource_group --php-version 7.4</code></pre><h2 id="h-final-touches">最后润色</h2><p>在部署之前，确保配置您的<code>local.settings.json</code>文件，包括<code>"FUNCTIONS_WORKER_RUNTIME": "custom"</code>配置键/值和您的<code>AzureWebJobsStorage</code>连接字符串:</p><pre class="wp-block-code"><code>{
  "IsEncrypted": false,
  "Values": {
    "FUNCTIONS_WORKER_RUNTIME": "custom",
    "AzureWebJobsStorage": "DefaultEndpointsProtocol=https;AccountName=&lt;accountname&gt;;AccountKey=&lt;accountkey&gt;;EndpointSuffix=&lt;endpointsuffix&gt;"
  }
}</code></pre><p>最后，确保添加指南<a href="https://docs.microsoft.com/azure/app-service/configure-language-php?pivots=platform-windows&amp;WT.mc_id=data-10498-alvidela#run-composer" target="_blank" rel="noreferrer noopener">为Azure应用服务</a>配置PHP应用中指定的Kudu脚本，以便<code>composer</code>在每次部署应用时运行，保持您的依赖关系最新。</p><p>就是这样！您应该准备好通过使用新的自定义处理程序特性将您的PHP应用程序部署到Azure功能中。</p><h2 id="h-learn-more">了解更多信息</h2><p>如果您想了解更多关于本文所涉及的主题，请务必访问以下网站:</p><p>黑客快乐！</p><h5>关于作者</h5><p>阿尔瓦罗·维德拉是微软的一名开发者拥护者，他组织了DuraznoConf。他是RabbitMQ in Action的合著者，并为计算机器协会撰写文章。你可以在推特上找到他的名字是<a class="" href="https://twitter.com/old_sound?opt_id=oeu1596472260634r0.19676524222612213"> @old_sound </a> 。</p></div></div>    
</body>
</html>