<html>
<head>
<title>Packaging AWS Lambda functions as container images | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>将AWS Lambda打包成容器映像|云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/packaging-aws-lambda-functions-as-container-images#0001-01-01">https://acloudguru.com/blog/engineering/packaging-aws-lambda-functions-as-container-images#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>在<a href="https://reinvent.awsevents.com/" target="_blank" rel="noreferrer noopener"> AWS re:Invent 2020 </a>上宣布了对<a href="https://aws.amazon.com/lambda/pricing/" target="_blank" rel="noreferrer noopener"> AWS Lambda </a>的容器映像支持。这是AWS功能即服务产品的一个重要新增功能。Lambda在管理可伸缩性、高可用性和容错方面为开发人员提供了许多好处，并且还支持按价值付费的模型。通过支持函数的容器封装，Lambda现在成为了广大开发者的一个选择。</p><p>在这篇文章中，我解释了这个新功能提供了什么，并浏览了一个教程，展示了如何构建一个容器<a href="https://acloudguru.com/blog/engineering/serverless-image-optimization-and-delivery" target="_blank" rel="noreferrer noopener">映像并在Lambda函数</a>中运行。</p><h2 id="h-why-did-aws-add-support-for-container-packaging">为什么AWS增加了对容器打包的支持？</h2><p>在这个改变之前，Lambda部署包是一个zip文件。zip文件包含代码以及任何库和依赖项。你可以手动上传这个文件，或者使用自动化工具，如<a href="https://aws.amazon.com/serverless/sam/" target="_blank" rel="noreferrer noopener"> AWS无服务器应用模型</a>(AWS SAM)<a href="https://aws.amazon.com/cdk/" target="_blank" rel="noreferrer noopener">AWS CDK</a>，或者<a href="https://www.serverless.com/" target="_blank" rel="noreferrer noopener">无服务器框架</a>。</p><p>然而，许多客户已经投资了基于容器的部署工具和工作流。除了CI/CD、安全性和治理工具之外，还包括Docker。Docker是一个非常强大的运行和管理容器的工具(如果你想提高你的技能，你可以通过获得Docker认证来做到这一点)。有了这一改变，开发人员可以从统一的开发和部署过程中受益。</p><hr class="wp-block-separator"/><p class="has-text-align-center" id="h-">你是想开始你的AWS职业生涯还是想让你的技能更上一层楼？我们的AWS学习路径提供定制的路径，让您的云计算之旅更加精彩！</p><hr class="wp-block-separator"/><h2 id="h-the-benefits-of-using-container-packaging-for-functions">使用容器包装功能的好处</h2><p>Lambda将基于容器的函数视为不可变的实体。调用时，作为容器映像部署的函数按原样运行。这意味着部署包在不同的环境中是不可变的，包括桌面、<a href="https://acloudguru.com/blog/engineering/continuous-deployment-with-serverless-and-circleci" target="_blank" rel="noreferrer noopener"> CI/CD流程和Lambda执行环境</a>。</p><p>对于工作负载较大的开发人员来说，基于容器的部署包现在最大可达10 GB。这释放了许多新的工作负载可能性，尤其是对于数据密集型或依赖性密集型应用程序。对于机器学习或数据分析，这允许开发人员利用无服务器计算的优势。如果您使用PyTorch、NumPy和类似的库，以前的250 MB部署包限制阻止了许多工作负载使用Lambda。</p><p>这种新方法还提高了不同AWS计算选项之间的可移植性。你可以为你的代码选择一个首选的基于映像的方法，这样在AWS Fargate或Amazon EC2等服务之间实现可移植性就更容易了。</p><h2 id="h-how-it-works">它是如何工作的</h2><p>有了容器映像支持，Lambda支持<a href="https://docs.docker.com/registry/spec/manifest-v2-2/" target="_blank" rel="noreferrer noopener"> Docker映像清单模式</a>和<a href="https://opencontainers.org/" target="_blank" rel="noreferrer noopener">开放容器倡议(OCI)规范</a>(版本1.0起)。它支持来自<a href="https://aws.amazon.com/ecr/" target="_blank" rel="noreferrer noopener">亚马逊弹性容器注册中心</a> (ECR)的容器映像部署。</p><p>Lambda服务提供了各种预安装运行时的基本映像选项。这些基础映像将由AWS进行修补和维护。目前支持的运行时有dotnetcore2.1、dotnetcore3.1、go1.x、java8、java8.al2、java11、nodejs12.x、nodejs10.x、python3.8、python3.7、python3.6、python2.7、ruby2.5、ruby2.7、provided.al2、provided。开发者也可以提供他们自己的基于Linux内核的映像。</p><p>这里一个有趣的新组件是<a href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-images.html" target="_blank" rel="noreferrer noopener">运行时接口客户端</a> (RIC)。ric是在运行时将客户功能代码与Lambda API集成在一起的包装器。这些都预装在AWS提供的基本映像上。对于您构建的映像，您必须确保RIC存在。有一个<a href="https://github.com/aws/aws-lambda-python-runtime-interface-client" target="_blank" rel="noreferrer noopener">开源版本</a>用于定制基础映像。</p><p>还有一个运行时接口仿真器(RIE ),使您能够在本地测试功能代码。在开发和其他生产前环境中，通过发送HTTP请求来测试功能非常有用。模拟器在容器内部的端口上监听HTTPS请求，然后包装这些请求并作为事件提供给函数。这也是一个<a href="https://github.com/aws/aws-lambda-runtime-interface-emulator/" target="_blank" rel="noreferrer noopener">开源项目</a>。</p><p>Lambda执行环境在运行时提供了一个只读文件系统。要写入文件，您可以访问512MB /tmp存储空间。默认用户是唯一受支持的用户，这使得Lambda能够在调用期间提供最低特权的安全权限。</p><h2 id="h-many-things-don-t-change">许多事情不会改变</h2><p>将Lambda函数打包成容器映像的能力带来了新的功能，但许多事情并没有改变。如果您是一名现有的Lambda开发人员，并且对您当前构建和部署应用程序的方法感到满意，那么您不需要做任何改变。如果你想使用这种新型包装，你可以依靠许多东西继续工作，因为他们以前没有。</p><p>Lambda的资源和操作模型完全相同。这意味着自动扩展特性、跨多个可用性区域的高可用性以及安全性和隔离模型是相同的。</p><p>性能配置文件也仍然取决于映像大小、运行时选择以及函数的依赖性。我在这个<a href="https://www.youtube.com/watch?v=FTCaOQJvG6Y" target="_blank" rel="noreferrer noopener"> YouTube视频</a>中讨论的许多优化技巧仍然适用于基于容器的Lambda函数。Lambda定价也是一样的，不管你用哪种打包方式。</p><p>Lambda的主要特性仍然适用于基于容器的函数。您可以继续使用提供的并发性、扩展、Amazon弹性文件系统(EFS)和X射线集成。您还可以像以前一样让这些函数访问您的VPC，使用保留并发，或者将成功和失败处理路由到Lambda目的地。</p><h2 id="h-how-to-package-a-lambda-function-as-a-container-image">如何将Lambda函数打包成容器映像</h2><p>为了展示这在实践中是如何工作的，本演练使用了一个基于Linux的环境，其中已经安装了<a href="https://aws.amazon.com/cli/" target="_blank" rel="noreferrer noopener"> AWS CLI </a>、<a href="https://nodejs.org/en/download/" target="_blank" rel="noreferrer noopener"> Node.js </a>和<a href="https://docs.docker.com/get-docker/" target="_blank" rel="noreferrer noopener"> Docker </a>。</p><p>1.创建应用目录，设置npm，安装用于生成测试数据的<a href="https://www.npmjs.com/package/faker" target="_blank" rel="noreferrer noopener"> Faker.js包</a>:</p><pre class="wp-block-preformatted">mkdir getCustomerFunction
cd getCustomerFunction
npm init –y
npm i faker --save</pre><p>2.创建一个名为<em> app.js </em>的文件，粘贴以下代码。这与您在常规zip文件部署中使用的Lambda处理程序代码相同:</p><div class="wp-container-640f2ad63845c wp-block-group"><div class="wp-block-group__inner-container"><pre class="wp-block-preformatted">const faker = require('faker')
module.exports.lambdaHandler = async (event, context) =&gt; {
    return faker.helpers.createCard()
}</pre></div></div><p>3.创建一个名为<em> Dockerfile </em>的文件，并粘贴以下代码。这指导Docker如何构建容器，安装任何必要的包，并显示Lambda处理程序在哪里可用。</p><pre class="wp-block-preformatted">FROM public.ecr.aws/lambda/nodejs:12
COPY app.js package*.json ./
RUN npm install
CMD [ "app.lambdaHandler" ]</pre><p id="block-68856527-9a0f-4418-bfde-cf25aa148df1">完成这些步骤后，我的IDE看起来像这样:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/5377ddefe406e2dca6d9466beb398e3d.png" alt="" class="wp-image-42719" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1092/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image1.png 1092w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image1.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image1.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image1.png 768w" sizes="(max-width: 1092px) 100vw, 1092px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image1.png"/></figure><p>4.使用Docker通过以下功能代码构建一个映像:</p><pre class="wp-block-preformatted">docker build -t get-customer .</pre><p>5.在ECR中创建新的存储库，并将Docker映像推送到repo。将<accountid>替换为您的AWS帐户ID，将<region>替换为您的首选AWS地区:</region></accountid></p><pre class="wp-block-preformatted">aws ecr create-repository --repository-name get-customer --image-scanning-configuration scanOnPush=true

docker tag get-customer:latest &lt;accountID&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com/get-customer:latest

aws ecr get-login-password | docker login --username AWS --password-stdin &lt;accountID&gt;.dkr.ecr.us-east-1.amazonaws.com

docker push &lt;accountID&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com/get-customer:latest</pre><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/b1d519f36e4033e0f1420158fbbbe916.png" alt="" class="wp-image-42720" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1022/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image2.png 1022w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image2.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image2.png 768w" sizes="(max-width: 1022px) 100vw, 1022px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image2.png"/></figure><h2 id="h-invoking-container-image-as-a-lambda-function">将容器图像作为Lambda函数调用</h2><p>一旦图像被推送到ECR，您就可以在新的Lambda函数中使用它。在<a href="https://console.aws.amazon.com/lambda/home" target="_blank" rel="noreferrer noopener"> Lambda控制台</a>中，选择<strong>创建功能</strong>，然后在<em>基本信息</em>面板中选择新的容器图像。选择<strong>创建功能</strong>完成该过程。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/a8297d3d70944b35ea8c5936f9ee9c09.png" alt="" class="wp-image-42721" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1245/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image3.png 1245w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image3.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image3.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image3.png 768w" sizes="(max-width: 1245px) 100vw, 1245px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image3.png"/></figure><p>在下一页中，当使用容器图像成功创建函数时，会出现一个通知。你可以像测试任何常规Lambda函数一样测试这个函数。选择<strong> Test </strong>后，你会看到函数代码返回的随机测试数据:</p><p/><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/8cf950c91530b6b64bf4b35149d9e044.png" alt="" class="wp-image-42722" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1119/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image4.png 1119w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image4.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image4.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image4.png 768w" sizes="(max-width: 1119px) 100vw, 1119px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image4.png"/></figure><p>在Lambda控制台中，您可以设置超时(1–900秒)和内存分配(128 MB到10，240 MB)。10 GB的限制是一项新功能，提高了以前的最大内存3 GB。</p><h2 id="h-using-aws-sam-to-automate-the-process">使用AWS SAM实现流程自动化</h2><p>使用AWS SAM可以自动构建和部署基于容器的Lambda函数。为此，您需要安装<a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html" target="_blank" rel="noreferrer noopener"> AWS SAM CLI </a>。你需要ECR回购URI-要找到它，导航到<a href="https://console.aws.amazon.com/ecr/repositories" target="_blank" rel="noreferrer noopener"> ECR控制台</a>并从<em> get-customer </em>回购中复制URI。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/e0accef718e4fb31972b6f7ed5db5aed.png" alt="" class="wp-image-42723" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1216/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image5.png 1216w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image5.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image5.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image5.png 768w" sizes="(max-width: 1216px) 100vw, 1216px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image5.png"/></figure><p>本演练使用前面创建的ECR repo部署完全相同的功能。首先，您使用AWS SAM来初始化一个项目，以生成一个示例函数和<em> Dockerfile </em>。接下来，使用build和deploy命令来自动构建映像，推送到ECR repo，并创建Lambda函数。</p><p>从终端:</p><p>1.输入<em> sam init </em>启动AWS SAM向导。</p><p>2.选择“1–AWS快速入门模板”。</p><p>3.您可以选择zip或图像部署。选择2–图像。</p><p>4.您可以选择您喜欢的运行时基础映像。在这种情况下，选择1–Amazon/nodejs 12 . x-base。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/1959b255fe8b275dd5eec30f3bf4a615.png" alt="" class="wp-image-42724" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_723/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image6.png 723w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image6.png 300w" sizes="(max-width: 723px) 100vw, 723px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image6.png"/></figure><p>5.对于<em>项目</em>名称，输入‘我的sam功能’。这将创建一个包含AWS SAM模板、自述文件和单元测试的样例项目。</p><p>6.导航到<em> my-sam-function </em>项目中的<em> hello-world </em>函数目录，打开app.js，粘贴以下函数代码并保存更改:</p><pre class="wp-block-preformatted">const faker = require('faker')
module.exports.lambdaHandler = async (event, context) =&gt; {
    return faker.helpers.createCard()
}</pre><p>7.将终端放在<em> my-sam-function </em>项目目录中，构建项目:</p><pre class="wp-block-preformatted">sam build</pre><p>8.使用AWS SAM部署的引导模式部署基于容器的功能:</p><pre class="wp-block-preformatted">sam deploy –guided</pre><p>对于<em>栈名</em>，输入‘my-Sam-project’，输入首选区域，然后输入之前复制的ECR库URI。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/b4203d60f095b56e3c29ba032aa452f4.png" alt="" class="wp-image-42725" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_803/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image7.png 803w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image7.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image7.png 768w" sizes="(max-width: 803px) 100vw, 803px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image7.png"/></figure><p>部署完成后，新功能会出现在Lambda控制台中。您可以通过使用之前使用的<em>测试</em>选项来调用该函数。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/f1fda9dcff15ea9dc7aab76257673ebe.png" alt="" class="wp-image-42726" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1184/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image8.png 1184w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image8.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image8.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image8.png 768w" sizes="(max-width: 1184px) 100vw, 1184px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image8.png"/></figure><h2 id="h-conclusion">结论</h2><p>有了Lambda的新容器映像支持，您可以使用Docker来打包您的自定义代码和Lambda函数的依赖项。10 GB部署包限制使得部署不适合现有250 MB文件配额的较大工作负载成为可能。</p><p>在这篇文章中，我展示了如何构建Docker映像并在Lambda服务中部署该映像。我还展示了如何使用AWS SAM来简化样板项目的生成、构建映像和部署功能。</p><p>现在是在AWS中发展云技能和提升职业水平的最佳时机。</p><p>要获得更多帮助您充分利用基于Lambda的应用程序的技巧和诀窍，请访问<a href="https://serverlessland.com/" target="_blank" rel="noreferrer noopener">无服务器世界</a>。</p></div></div>    
</body>
</html>