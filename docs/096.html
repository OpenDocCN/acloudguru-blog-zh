<html>
<head>
<title>Migrating Flask App from Elastic Beanstalk to AWS Lambda | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>将Flask App从Elastic Beanstalk迁移到AWS Lambda |云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/adventures-in-migrating-to-serverless#0001-01-01">https://acloudguru.com/blog/engineering/adventures-in-migrating-to-serverless#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p id="a8d6">在纽约参加了一个云专家的<a href="https://nyc.serverlessconf.io/" target="_blank" rel="noreferrer noopener"> Serverlessconf </a>会议后，我受到启发，花了一个周末的时间来尝试实施我从研讨会和演讲者会议中学到的东西。我的目标是将我在AWS Elastic Beanstalk中编排的简单web应用程序迁移到AWS Lambda中的<a href="https://acloudguru.com/blog/engineering/aws-lambda-is-winning-but-first-it-had-to-die" target="_blank" rel="noreferrer noopener">无服务器实现中。让周末开始吧！</a></p><p id="cccd">我的简单食谱网站是一个Flask应用程序，它在MySQL数据库中查询食谱，并允许用户使用他们的Twitter帐户创建购物清单。</p><p id="f3a9">简单的recipe应用程序使用托管在AWS Elastic Beanstalk上的Python、Flask、OAuth、JavaScript、JQuery、RDS。它并不花哨，但它是测试新技术的好地方，它让我在学习新技术时有了目标——比如无服务器！</p><p id="de30">这个网站几乎没有流量，所以为最少的资源付费真的让我很恼火。我可能会把每月10美元花在咖啡上。现在，它有一个由Route 53托管的域名和一个指向Elastic Beanstalk上的单实例部署的负载平衡器。在无服务器的世界里，这几乎不需要任何费用。</p><p id="e702">让我们谈谈目标:我的目标是尽可能多地提升和移动<em/>。我知道我们可以很容易地用DynamoDB在Node中重写这一点，但我们坚持使用Python/Flask组合，因为这个小小的应用程序是更大迁移的代理。Flask为我们提供了很好的服务，添加路由和调试非常简单，我们希望它能在这次过渡中幸存下来。这是周六早上，我喝了咖啡因做这件事！</p><h2 id="54b2">将烧瓶应用程序移动到AWS Lambda</h2><p id="dd60">事实证明，有几个框架旨在使将Flask移动到Lambda变得“容易”——<a href="https://github.com/Miserlou/Zappa" target="_blank" rel="noreferrer noopener">Zappa</a>和<a href="https://github.com/aws/chalice" target="_blank" rel="noreferrer noopener">Chalice</a>——所以我们<em>可能会在午餐时间完成</em>。几个小时后，很明显，Chalice是Zappa的克隆，它添加了一些自动IAM魔法，但提供了其功能的一小部分，并需要对我的应用程序进行重大代码更改。</p><p id="2f8f">我丢掉圣杯，专注于扎帕。</p><p id="3c78">这个<em> Hello World </em>的例子运行得如此之好，以至于我的期望很高——但是当我试图部署我的应用程序时，我得到了当天的第一个错误。这不是一个友好的Python/Flask错误，而是一个长达一页的AWS错误，让我质疑我的职业选择。</p><p id="2cbe">到午餐时间，我发现Zappa在读取Windows上的文件时有问题，所以我将一个UTF-8默认值直接破解到有问题的Zappa python文件中，以继续运行。我喜欢早上技术债的味道。</p><p id="db06"><em>哎呀，更多错误</em>:</p><ol><li>Zappa需要一系列极其复杂的IAM权限，似乎没有人需要将它们记录在一个地方。到处都是碎片，但我最终还是从地狱构建了一个IAM策略来使它工作。我避免了显而易见的“完全管理员访问”方法，试图学习一些东西并以正确的方式做事。很明显，是我的错。</li><li>Lambda似乎不喜欢<a href="https://pypi.python.org/pypi/mysqlclient" target="_blank" rel="noreferrer noopener"> mysqlclient </a> Python库。我能找到的所有AWS例子都使用<a href="https://github.com/PyMySQL/PyMySQL" target="_blank" rel="noreferrer noopener"> pymysql </a>，所以我花了几分钟把它们切换出来。午餐时间结束了，我开始了漫长的下午。</li><li>我运行<code>zappa deploy dev</code>并等待两分钟。它上传，我在控制台看到绿色而不是红色，并得到一个API端点。成功！我在浏览器中剪切并粘贴网址，然后等待，等待…然后超时了。我的胜利多么短暂。这似乎不是很重要，但标志着一个野生品种鹅追逐的开始，这一天剩下的时间沉。</li></ol><h2 id="f5c1">AWS Lambda RDS和OAuth解决方案</h2><p id="d24a">在Lambda中使用RDS是一种反模式，因为您将扩展瓶颈推到了数据库。但现实是，即使不是大多数，也有许多web应用程序使用SQL数据库——所以我忍住了转向DynamoDB并继续解决这个问题的冲动。对于像我这样很少使用的爱好网站，RDS选项仍然有效。</p><p id="65e4">问题的症结在于RDS是一个使用VPC的资源。为了让你的Lambda函数看到数据库，它也在VPC中。当你打开Lambda函数的网络部分时，这是你可以设置它的地方。</p><p id="28da">在这一点上，如果你还没有完成任何形式的AWS认证，你可能应该停下来<a href="https://acloud.guru/learn/aws-certified-solutions-architect-associate" target="_blank" rel="noreferrer noopener">寻求一些帮助</a>。幸运的是，我有证书——所以我可以在没有任何帮助的情况下轻松迷惑自己！</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/5eeb1fea8bb94e44895f906f5ae3327c.png" alt="" class="wp-image-41732" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_9_xtAmOEnU6XdvFeDTERWg.png"/></figure><p id="a7dc">在配置了必要的安全组设置后，我刷新URL并加载页面。但遗憾的是，所有的菜单链接都因为一个危险的禁止错误而失败。一些快速的谷歌搜索显示，在Zappa中创建的API端点包括<em>阶段名称</em>，它打破了Flask应用程序中的所有路线。</p><p id="9d75">关注积极的一面，至少主页是管用的。</p><p id="8465">幸运的是，这个问题可以通过使用自定义域名来解决。我使用Route 53和Certificate Manager来快速设置域，并像往常一样休息30分钟，而CloudFront会做<em>该做的事情</em>。这是我的午餐加晚餐，让我在进入第二轮之前有几分钟时间理清思绪。</p><p id="7e07">部署完成后，应用程序现在成功加载了所有路线，看起来我差不多完成了。<em>差不多</em>。</p><p id="4c0b">我发现我的Twitter OAuth在被点击时超时了，这很遗憾，因为它是应用程序的一个关键部分。嗯，代码中没有任何错误——但是在钻研了晦涩的错误消息并到处设置日志消息后，看起来我的应用程序再也无法到达Twitter的API了。</p><p id="491f">令人沮丧的是，一旦VPC中有了RDS所需的Lambda函数，它就无法访问互联网。听着，这个次要但重要的点的主要文档在λ函数的网络部分的<em>浅灰色文本</em>中:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/77a3ad1c396902213634a9b33bd8262d.png" alt="" class="wp-image-41733" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_L7rHzu0Y4qCnFcBN0KbxSQ.png"/></figure><p id="68ed">现在我需要一个每小时0.045美元或每月32美元的NAT网关，这不符合我零成本的预期。这一切似乎都是错误的。我悄悄上床睡觉，看看明天能不能解决这个问题。</p><h3 id="3b68">周日早上:回到马背上</h3><p id="c592">现在是早上7点，55度，鸟儿在外面唱歌——但是我的屏幕一直停留在这个超时错误上，就像我从来没有离开过一样。我需要几秒钟来重组并提醒自己我们在这里做什么。</p><p id="98d7">我有一个Flask应用程序，它与RDS对话，并使用一个简单的Twitter OAuth从访问者那里获取ID——我们希望将这一切都转移到Lambda。就是这样。为了解决这个VPC问题，除了支付NAT网关的费用之外，我认为有几个选择:</p><ol><li><span class="has-inline-color has-dark-gray-color">抛弃我的<a href="https://pythonhosted.org/Flask-OAuth/" target="_blank" rel="noreferrer noopener"> Flask OAuth </a>库和那十几行神奇的代码，转移到<strong> AWS Cognito </strong>。由于这是Amazon内部的托管服务，我不需要Lambda函数的互联网访问。</span></li><li><span class="has-inline-color has-dark-gray-color">删除RDS并将数据移至DynamoDB。这将完全消除对VPC的需求，因此我可以保留现有的OAuth解决方案。</span></li><li>将数据库逻辑分离到它自己的Lambda函数中(在VPC内部),将应用程序的其余部分分离到VPC外部的函数中。这似乎很有希望。</li></ol><p id="d85b">该应用程序只有少数非常简单的数据库查询，这些查询获取食谱，计算出用户选择了哪些食谱，并计算出购物清单。在一个小时内，我构建了一个代理Lambda函数，它将返回这些结果集，手动打包zip和库(urgh ),一切看起来都很好。</p><p id="30b0">我创建了一个没有VPC的测试工具函数来调用这个数据库函数，它返回Python就绪的数据行字典。看起来不错！我返回到主应用程序，更新列出所有食谱的路径——让它调用Lambda函数，而不是调用数据库:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/0fdd3319f47ed240d6f41d5755739b6d.png" alt="" class="wp-image-41734" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_nKvflmW7u9gvaV8mCTYBwg.png"/></figure><p id="1621">此时，我只想看到Lambda函数返回相同的查询结果。我做了一个<code>zappa update dev</code>然后等待…</p><p id="cf27">看哪！没用！</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/aa3a953db784d86a3c5c9c53fef09f92.png" alt="" class="wp-image-41736" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_Qgu0CiY0KX1Y5iEbk2BhQg.png"/></figure><p id="40fd">玩这个，看起来当你通过boto3调用Lambda函数时，Zappa开始抖动了。我不确定为什么——但是只有当我删除对Lambda的boto3引用时，部署操作才能再次工作。我试着调试了一个小时，但毫无进展。</p><p id="89f8">我想得越多，让Python以这种方式调用SQL-proxy Lambda就越觉得奇怪。我减少了损失，并着眼于下一个选择——cogn ITO！</p><h3 id="0e9b">因此认知为哑</h3><p id="7508">我对这个选择感到兴奋。Cognito满足了您对用户管理的需求，提供了用户池、联合身份管理和各种各样的好处。原则上，我可以抛弃OAuth，与Cognito集成，不再需要NAT网关。</p><p id="c26d">除了——不是这个案例——我在接下来的几个小时里发现。</p><p id="e800">我现在在Chrome上打开了太多标签，我几乎看不到标题。我以前没有用过Cognito，所以我很惊讶地发现…</p><ol><li>文档很薄弱，没有针对web应用的全面示例。</li><li>它是为Node和JavaScript量身定制的，几乎没有提到Python。</li><li>对于基本认证来说，这是一个太大的解决方案。在这个应用程序中，我们只需要一个Twitter ID来跟踪用户选择的食谱——我们不需要IAM权限、用户数据库或任何复杂的东西。</li></ol><p id="44bd">对于为无服务器从头开始编写的Node或JS应用程序，Cognito无疑是解决方案，但对于我的Python-heavy Flask应用程序，还不清楚这将如何工作。</p><p id="795b">在谷歌上搜索Python Cognito示例，很快就发现我不是第一个问这个问题的人。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/c90e281f0f57a4e5d2cf15fab3155eb2.png" alt="" class="wp-image-41735" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_oeWWV1IJ7-Cb4fTU88axMg.png"/></figure><h2 id="3d0e">为什么远离RDS？</h2><p id="f134">如果我消除RDS，我就解决了几个问题。一个是传统数据库的扩展瓶颈问题，第二个是对VPC的需求，它解决了我的OAuth的互联网访问问题。</p><p id="1728">但是困难在于跨表移植到DynamoDB。菜谱表在一个单独的表中分解配料，还有第三个表跟踪哪些用户选择了菜谱。</p><p id="7453">它从关系世界中的几个表变成了两个NoSQL表——向后端添加了一些聚合逻辑。从表面上看，这是一个小的迁移，但是它确实导致重写了主应用程序查询和处理数据的方式。</p><p id="8ede">这个练习的目的是提升和移位，RDS与DynamoDB的切换将导致重写大约三分之一的Python代码。在用尽了所有其他东西(和我自己)之后，这似乎是最好的解决方案——但它并不微不足道。如果我走这条路，我还不如用JavaScript重新编写应用程序，完全抛弃Python、Flask和Zappa。</p><p id="b33a">这有点令人泄气——但这就是周末的结局。我走了相当多的路，但没有成功完成我所希望的简单任务。</p><h3 id="fa90">匆忙下结论</h3><p id="169a">这方面的大部分工作还在进行中，我很可能在这篇文章中的一些事情上是错误的。我仍然在黑暗中摸索，并真诚地在这里抛出我的结论——希望它们能引发一些对话。</p><p id="4520"><strong> Flask不属于<br/> </strong>编写Flask应用程序非常容易，我可以在这种环境下快速完成一些相当复杂的事情。但是将一个简单的Flask应用移植到Lambda似乎是错误的方法，Flask并不真正属于那里。即使这样做了，Zappa最终还是创建了一个与无服务器架构背道而驰的单一功能。</p><p id="3e2d">不要改造<br/> 这与我使用Elastic Beanstalk的经验相反，它使部署web应用程序变得非常容易，并与基于WSGI的框架如Flask、Bottle和Pyramid紧密配合。但是在向无服务器迁移的过程中，我认为我们需要使用无服务器提供的东西，而不是改造超出其预期用途的东西。</p><p id="a9ac">文档很少<br/> 和许多AWS服务一样，文档也很少。在过去，我已经解决了S3 CORS问题、CloudFront发行版配置和未记录的弹性Beanstalk特性，最终理解并自信地解决了问题。但是我在这个周末的练习中一无所获，仍然有许多问题没有答案。</p><p id="f440">需要更多的模式<br/> 在编码方面，我一直发现我是通过鼓捣实实在在的例子来学习的，但似乎很难在这里找到任何具体的东西。我毫不怀疑这些服务的健壮性，但亚马逊肯定会给我们一些教程、例子和最佳实践。</p><p id="2719">TL；将Python web应用程序提升和转移到无服务器的灾难恢复版本:</p><ol><li>您的应用程序所使用的服务组合(在我的例子中是RDS + Flask + OAuth)可能不像预期的那样容易在无服务器环境中工作。</li><li>一个提升和转移可能需要足够的修改来保证重写，即使是对于表面上简单的应用程序。</li><li>文档(特别是缺乏)可能是追踪神秘错误的主要时间消耗。</li></ol><p id="209b">而我将继续把无服务器作为我们的主要交付机制。我谨慎地认为任何迁移都是微不足道的。重新开始可能更容易——但这是我另一个周末的计划。</p><p id="df5b">我很想在下面的评论中听到你的想法！</p><hr class="wp-block-separator"/><h2 class="has-text-align-center" id="h-level-up-your-cloud-career">提升您的云计算职业生涯</h2><p class="has-text-align-center">无论您是云新手还是经验丰富的专家，云专家都能让您轻松(而且非常棒)地获得认证并掌握现代技术技能。查看ACG目前的免费课程或立即开始免费试用。</p><hr class="wp-block-separator"/></div></div>    
</body>
</html>