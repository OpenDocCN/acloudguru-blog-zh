<html>
<head>
<title>How to use GitHub Actions to automate Terraform | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何使用GitHub操作来自动化Terraform |云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/how-to-use-github-actions-to-automate-terraform#0001-01-01">https://acloudguru.com/blog/engineering/how-to-use-github-actions-to-automate-terraform#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>在这篇博文中，我们将看一个使用GitHub Actions来自动化Terraform的例子，并为您提供一个快速简单的CI/CD解决方案。</p><p>我相信大多数管理员都会同意，<a href="https://acloudguru.com/blog/engineering/the-ultimate-terraform-cheatsheet" target="_blank" rel="noreferrer noopener"> Terraform </a>是在您的环境中部署和管理基础架构的非常强大和高效的工具。但是你知道你可以用GitHub动作让它变得更好并自动化吗？</p><p>GitHub Actions将持续集成添加到GitHub库，以自动化您的软件构建、测试和部署。</p><p>当使用CI/CD自动化Terraform时，它将实施配置最佳实践，促进协作，并自动化Terraform工作流。在这篇博客中，我将带领你使用Terraform和GitHub操作创建一个AWS S3网站。</p><hr class="wp-block-separator"/><h2 class="has-text-align-center" id="h-accelerate-your-career">加速您的职业发展</h2><p class="has-text-align-center"><a href="https://acloudguru.com/pricing">从ACG开始</a>通过AWS、Microsoft Azure、Google Cloud等领域的课程和实际动手实验室改变你的职业生涯。</p><hr class="wp-block-separator"/><h3 id="h-prerequisites">先决条件</h3><p>因此，在能够使用GitHub操作来自动化Terraform之前，首先需要设置和配置这三样东西:</p><ol><li>Terraform CLI已下载并安装。</li><li>您将需要一个AWS帐户，有一个AWS访问密钥和秘密密钥，以及授予用户的<strong> AmazonS3FullAccess </strong> IAM权限。您还需要创建一个S3存储桶来远程存储Terraform状态。</li><li>最后，您需要建立一个具有以下结构的GitHub存储库:</li></ol><ul><li>一个名为<strong> src </strong>的目录，你将在其中存储你的网站代码。</li><li>答。<strong> github </strong>目录，然后您将在其中创建一个<strong>工作流</strong>目录并存储您的github动作配置文件。</li><li>一个<strong> terraform </strong>目录，您将在其中存储您的terraform配置文件。</li></ul><p class="has-text-align-center">想从Terraform中获得最大收益的所有基本命令列表吗？查看我们的<a href="https://acloudguru.com/blog/engineering/the-ultimate-terraform-cheatsheet" target="_blank" rel="noreferrer noopener"> Terraform备忘单</a>。</p><h2 id="h-configure-your-aws-provider-and-remote-state"><strong>配置您的AWS提供商和远程状态</strong></h2><p>假设您已经配置了所有的先决条件，接下来您必须做的就是配置Terraform来引用您的AWS帐户。</p><p>您需要在GitHub repo中的terraform目录下创建一个名为<strong> main.tf </strong>的文件，配置如下:</p><pre class="wp-block-code"><code>terraform {
  required_providers {
    aws = {
      source = "hashicorp/aws"
      Version = "~&gt;3.27"
    }
  }

  required_version = "&gt;=0.14.9"

}

provider "aws" {
  version = "~&gt;3.0"
  region  = "east-us-1"
}</code></pre><p/><p>该代码块将告诉Terraform我们想要提供AWS资源，并且我们将资源创建默认为AWS内的<strong> east-us-1 </strong>区域。(您可以将其更改为适合您的任何地区。)</p><p>接下来，您需要将远程状态添加到我们的配置中。您需要将下面的代码块添加到main.tf文件中，就在下面的<strong> required_version </strong>值之后，并用您的bucket名称和bucket键替换占位符值:</p><pre class="wp-block-code"><code>required_version = "&gt;=0.14.9" 

   backend "s3" {
       bucket = "[Remote_State_S3_Bucket_Name]"
       key    = "[Remote_State_S3_Bucket_Key]"
       region = "east-us-1"
   }
}</code></pre><p>状态是Terraform用来比较基础设施的当前状态和期望状态的。默认情况下，Terraform在本地存储状态。</p><p>这对于测试和诸如此类的事情来说很好，但是对于大多数生产级别或大型基础设施来说，出于安全和协作的目的，您真的应该考虑远程存储状态。</p><p>此外，由于我们使用GitHub操作，状态将需要远程创建。如果没有远程状态，Terraform会生成一个本地文件，但不会提交给GitHub，因此我们会丢失状态数据。这可能会导致自动化的各种问题，因为Terraform非常依赖状态数据。</p><h2 id="h-finishing-up-your-terraform-configuration"><strong>完成你的地形配置</strong></h2><p>现在，您已经将远程后端添加到了您的配置中，我们现在可以添加资源块，它将定义您希望Terraform将哪些资源部署到您的基础架构中。您需要添加以下代码块来创建网站所需的S3资源:</p><pre class="wp-block-code"><code>resource "aws_s3_bucket" "s3Bucket" {
     bucket = "[BUCKET_NAME_HERE]"
     acl       = "public-read"

     policy  = &lt;&lt;EOF
{
     "id" : "MakePublic",
   "version" : "2012-10-17",
   "statement" : [
      {
         "action" : [
             "s3:GetObject"
          ],
         "effect" : "Allow",
         "resource" : "arn:aws:s3:::[BUCKET_NAME_HERE]/*",
         "principal" : "*"
      }
    ]
  }
EOF

   website {
       index_document = "index.html"
   }
}</code></pre><h2 id="h-setting-up-github-actions"><strong>设置GitHub动作</strong></h2><p>既然我们已经解决了这个问题，现在我们可以继续设置我们的GitHub操作了。</p><p>现在你可能会问，“为什么我要把我们的Terraform配置添加到GitHub动作或其他CI/CD管道中？”以下是一些原因:</p><ul><li>管道创造更多<strong>可见性</strong>。在团队中使用Terraform管理基础设施时，您可以轻松查看正在运行的内容以及运行时间。在本地运行时，只有您拥有这种可见性。</li><li>管道创造<strong>可追溯性</strong>。当在管道中运行Terraform时，它们通常存储日志。这允许您在方便的时候回顾旧的构建及其输出。</li><li>流水线创造<strong>重复性</strong>。当您配置管道时，它应该每次都执行相同的操作。这将使调试和故障排除更加容易。</li><li>最后，他们创造了简单性。管道本质上可以取代本地实例。这样你就不用设置本地的依赖关系什么的了。</li></ul><p>在GitHub动作可以运行之前，您需要做的第一件事是将您的AWS凭证添加到存储库中。为此，您需要遵循以下步骤:</p><ol><li>导航到您的存储库并选择<strong>设置</strong>选项卡。</li><li>一旦你看到左边有一个<strong>秘密</strong>部分，从列表底部数第三个，点击它。</li><li>点击<strong>新建储存库密码</strong>按钮。</li><li>添加您的<strong> AWS_SECRET_ACCESS_KEY </strong>并点击<strong>添加秘密</strong>按钮。</li><li>重复步骤3，添加您的<strong> AWS_ACCESS_KEY_ID </strong>，并点击<strong>添加秘密</strong>按钮。</li></ol><p>接下来，在<strong>中创建<strong> actions.yaml </strong>文件。github/workflows </strong>目录下有如下代码:</p><pre class="wp-block-code"><code>name: Deploy Infrastructure

on:
  push:
    branches:
      - master

jobs:
  tf_fmt:
    name: Deploy Site
    runs-on: ubuntu-latest
    steps:

    - name: Checkout Repo
      uses: actions/checkout@v1

    - name: Terraform Init
      uses: hashicorp/terraform-github-actions/init@v0.4.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TF_ACTION_WORKING_DIR: 'terraform'
        AWS_ACCESS_KEY_ID:  ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: Terraform Validate
      uses: hashicorp/terraform-github-actions/validate@v0.3.7

    - name: Terraform Apply
      uses: hashicorp/terraform-github-actions/apply@v0.4.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TF_ACTION_WORKING_DIR: 'terraform'
        AWS_ACCESS_KEY_ID:  ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: Sync S3
      uses: jakejarvis/s3-sync-action@master
      env:
        SOURCE_DIR: './src'
        AWS_REGION: 'us-east-1'
        AWS_S3_BUCKET: '[BUCKET_NAME_HERE]'
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}</code></pre><p>我们在这里声明，任何时候有推送到<strong> src </strong>目录的时候，都会启动一个动作，让Terraform部署对你的网站所做的更改。您需要确保使用您的bucket名称更新yaml文件。你还需要确保你已经创建了<strong> src </strong>目录，并在其中添加了一个<strong>index.html</strong>文件。</p><h3 id="h-success">成功！</h3><p>就是这样！您已经使用Terraform和GitHub操作成功创建了一个CI/CD管道。想想这种可能性，以及这样的过程能为您节省多少时间，尤其是当您的站点或基础设施增长时。使用Terraform和GitHub操作确实可以帮助创建一个简化的、易于管理的、可重复的流程，从而节省时间并减少麻烦。下次见，大师们！</p><h2>了解有关使用Terraform管理应用程序和基础设施的更多信息</h2><p>请查看我的新课程<a href="https://acloudguru.com/course/using-terraform-to-manage-applications-and-infrastructure" target="_blank" rel="noreferrer noopener">使用Terraform管理应用程序和基础设施</a>，体验Terraform的奇妙世界！</p><p>我们将探讨管理员如何使用Terraform轻松地向各种提供商部署基础设施。无论是单一的简单配置，还是包含多个提供商的更复杂配置，本课程都将展示从一个位置管理基础架构是多么简单。</p><hr class="wp-block-separator"/><p class="has-text-align-center"><a href="https://get.acloudguru.com/cloud-dictionary-of-pain"> <strong>获得痛苦的云词典</strong> </a> <br/>说云不一定要努力。我们分析了数以百万计的回复，找出了最容易让人犯错的概念。抓住这个<a href="https://get.acloudguru.com/cloud-dictionary-of-pain" target="_blank" rel="noreferrer noopener">云指南</a>获取一些最痛苦的云术语<a>的简洁定义。</a></p></div></div>    
</body>
</html>