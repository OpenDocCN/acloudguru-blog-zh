<html>
<head>
<title>How To Deploy a Simple Application in Azure using Cosmos DB and Terraform | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何使用Cosmos DB和Terraform在Azure中部署简单的应用程序</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/deploy-a-simple-application-in-azure-using-terraform#0001-01-01">https://acloudguru.com/blog/engineering/deploy-a-simple-application-in-azure-using-terraform#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>Azure Cosmos DB是一个全球分布式数据库服务。在开发全球分布式应用程序时，它为开发人员提供了很大的灵活性。多亏了Terraform，您只需几行HCL代码就可以轻松部署Cosmos DB帐户和资源。</p><p>在这篇文章中，我将向你展示如何在Azure中部署一个简单的应用程序。我们将通过使用Terraform将Azure Cosmos DB部署到Azure容器实例来实现这一点。首先，我们将学习如何创建Azure Cosmos DB实例，然后更新配置以创建Azure容器实例，最后创建一个使用这两种资源的简单应用程序。</p><hr class="wp-block-separator"/><p class="has-text-align-center has-medium-font-size">加速你的职业生涯！</p><p class="has-text-align-center"><a href="https://acloudguru.com/pricing" target="_blank" rel="noreferrer noopener">从ACG开始</a>通过AWS、Microsoft Azure、Google Cloud等领域的课程和实际动手实验室改变你的职业生涯</p><hr class="wp-block-separator"/><h2 class="has-text-align-left" id="h-what-you-ll-need"><strong> <strong>你需要什么</strong> </strong></h2><p>要跟进这篇文章，你需要一些东西:</p><ul><li>Azure订阅</li><li>要么在本地安装<a href="https://learn.hashicorp.com/tutorials/terraform/install-cli" target="_blank" rel="noreferrer noopener"> Terraform </a>，要么在Azure中使用内置Terraform的云外壳</li><li>如果您在本地使用terraform，您还需要安装<a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" target="_blank" rel="noreferrer noopener"> Azure CLI </a>来向Azure认证Terraform。</li><li>您选择的文本编辑器(我的建议是<a href="https://code.visualstudio.com" target="_blank" rel="noreferrer noopener"> VS代码</a>)</li></ul><h2 id="h-step-1-creating-the-initial-configuration"><strong> <strong>步骤1:创建初始配置</strong> </strong></h2><p>假设您已经具备了入门所需的一切，接下来要做的事情就是配置Terraform来使用Azure provider进行配置。您需要在您为项目创建的目录中创建一个名为<strong> main.tf. </strong>的文件。我创建了一个名为<strong> terraformguru </strong>的目录，这将是我这个项目的工作目录。</p><p>在<strong> main.tf </strong>文件中，您首先需要定义您将用于配置的提供者。</p><p>一旦我们定义了提供者，我们将需要在初始配置中定义三个资源。</p><ul><li>第一个资源是我们的资源组，我们将把其他资源绑定到这个资源组。</li><li>我们将需要在下一个资源块中使用随机提供程序来生成一个随机整数，以便在Azure Cosmos DB帐户配置中使用。</li><li>然后我们可以定义我们的Azure Cosmos DB帐户。</li></ul><p>您的配置应该如下例所示:</p><p><img loading="lazy" src="../Images/8132cf7d12531a50e3408808d0a22032.png" data-original-src="https://lh6.googleusercontent.com/Gj0W729HqmZBzBxhW-L6CeiwPSsiKlrmgq_bNSd7rxpilK4FXWuuIHjBjiPdMp_b5QS0d4ZslryXUribb8TCTsl1p6HSaNIegH6ojajUgVN9C9-V2H3MGb4En18CklIeuf5iIDOg2qqESAc25w"/></p><p>在我们的Azure Cosmos DB帐户资源块中，我们需要定义这些参数:</p><ul><li><strong>名称</strong>(与随机整数组合成唯一名称)</li><li><strong>位置</strong>(资源组位置)</li><li><strong>资源组名称</strong>(资源组的名称)</li><li><strong>报价_类型</strong></li><li><strong>种类</strong></li><li><strong>一致性_策略</strong></li><li><strong>地理位置</strong></li></ul><p>一旦我们定义了三个资源，就该应用我们的配置并创建我们的Cosmos DB实例了。</p><h2 id="h-step-2-applying-our-configuration"><strong>步骤2:应用我们的配置</strong></h2><p>第一步是初始化我们的工作目录，这样我们就可以为我们的项目下载所需的提供者插件。我们可以通过运行以下命令来实现这一点:</p><p><img loading="lazy" src="../Images/41027e552d4ff72dfab37deeb5057968.png" data-original-src="https://lh5.googleusercontent.com/znbX8-gUMAECRp8OP2gRfSdgazqTVRqASx8QYqvlp_jhIIwJvNpRpKLKgEfBCdM-_3X2JChQ_mbpPriWNKQhXw_1PfTx3l2YI3naAdn8jpkw0bbp-ivsvA9MkO92Ir1GDJ82QXCLwQly3ChZWw"/></p><p>接下来，我们将通过运行以下命令来验证我们的配置，以确保代码的语法是正确的:</p><figure class="wp-block-image"><img loading="lazy" src="../Images/c11cbe146224f91f886eab1b45e0fa9e.png" alt="" data-original-src="https://lh5.googleusercontent.com/8dvM_8FRIj-Zavzcf0njUG3RBd-R6Ze5I6hibOZ83SMTzPI-Hod_vnhecnDJtWwofBSf5_2chenumbxCQfBkcEgeivb_XUBDWSRgC36dj9QDK_H9M_5B7-Jo80e-37_jy7Qf51j95Nbf2nXaWA"/></figure><p>一旦我们确认我们的配置是有效的，我们接下来可以通过运行plan命令来进行配置的模拟运行，如下例所示:</p><figure class="wp-block-image"><img loading="lazy" src="../Images/150f5e1e0dc5a7353dd209b53735a0a4.png" alt="" data-original-src="https://lh4.googleusercontent.com/BsubaMTbXMS_YSkL0tcOKJvpdr_WRixMsfHl0A_2FRxE_1yDE8DevUFW30CdvAN82UJqj5qV2scqU243vNpXiQfGwWsDqqUJUfI0RdXXHNa4rC8Mkpu4SrI3oXqDBeoC6-3hzANL1k1iWHjw-w"/></figure><p>如果一切正常，看起来会像我们希望的那样，我们就可以最终应用我们的配置了:</p><figure class="wp-block-image"><img loading="lazy" src="../Images/6f67b4c346485bddf87f0236335c65ab.png" alt="" data-original-src="https://lh3.googleusercontent.com/GobvUsIosQC7cyo_TBFkHCICdOFTRWbr6cSfdeqic4oFrYY4QxjP1Bf9pHJkXYfUQg3kjZCIUlHZJcBIxC2gjPmf753cHIRFuSq5ulRe1JSYk-iSxoZBRRJFtKObh43nsl57sVLdN6OsjCNv1w"/></figure><p>在应用运行之后，我们应该在Azure中有一个Cosmos DB的实例。现在我们可以更新我们的配置，这样我们就可以使用我们的新实例。</p><h2 id="h-step-3-update-the-configuration-with-a-container-instance"><strong>步骤3:用容器实例更新配置</strong></h2><p>现在是时候更新我们的配置并添加一个容器实例了。这个容器实例将使用我们的Cosmos DB实例，该实例本身使用一个运行小型投票web应用程序的容器映像。添加的配置应该类似于下面的示例:</p><figure class="wp-block-image"><img loading="lazy" src="../Images/b102bc270e2f0dceda77db5b33afa25e.png" alt="" data-original-src="https://lh5.googleusercontent.com/93RBmquCV9IbmmxRWnDJAzDVd75g28j4Qtg41IdLrD5AilEdUHZvdjY8gYHIhpy-BJZiN6j8waif9Set3MRwSxX5xFuQMEHI4t3G7--fypqjOK6VfXWsbZL614CPmNYu9EipFXDFYPZakosVQQ"/></figure><p>这里我们为容器实例添加了一个资源块。在我们的Azure容器组资源块中，我们需要定义这些参数:</p><ul><li><strong>名称</strong></li><li><strong>位置</strong>(资源组位置)</li><li><strong>资源组名称</strong>(资源组的名称)</li><li><strong> ip地址类型</strong></li><li><strong>域名标签</strong></li><li><strong> os_type </strong></li><li><strong>容器</strong>(这是我们指定图像的地方)</li><li><strong>安全_环境_变量</strong></li></ul><p>这里需要指出几个关键点。</p><ul><li>首先，在我们的容器参数中，注意我们指定了一个从微软容器图像注册表中提取的图像。我们使用Cosmos DB后端的前端投票应用程序。</li><li>我们从创建的Cosmos DB实例中提取两个环境变量，并为每个变量设置一个环境变量。<ul><li>首先，我们为数据库提取端点并设置环境变量<strong> COSMOS_DB_ENDPOINT </strong>，然后我们提取数据库的主密钥并设置环境变量<strong> COSMOS_DB_MASTERKEY </strong>。这两个环境变量是数据库的关键，允许容器连接到数据库并使用数据库实例。没有它们，应用程序将无法工作。</li><li>另请注意，我们正在设置一个输出变量，该变量将显示我们的应用程序端点，以便我们可以连接到应用程序。</li></ul></li></ul><p>一旦我们将它添加到我们的配置中，它应该看起来像这样:</p><p><img loading="lazy" src="../Images/22bc742f5f315e4088ca3a242b4fcfc6.png" data-original-src="https://lh4.googleusercontent.com/XtJCr2EiTIV8X0vSN6AfkTIw4FQpVHIHOKm_EJHFb_kX8zFUG09QgF6WQ-zvBL5Yq__CMSt0RgHWA2GHVe8qEFUtDnsA7_mcq470wIF90uWQI8x18B4P7aRdsmi1-FoYhIOsA0dV1fbcpje3Qw"/></p><p>我们现在可以将我们的更改部署到我们的配置中。我们应该验证我们的配置，以确保代码的语法是正确的:</p><figure class="wp-block-image"><img loading="lazy" src="../Images/c11cbe146224f91f886eab1b45e0fa9e.png" alt="" data-original-src="https://lh5.googleusercontent.com/8dvM_8FRIj-Zavzcf0njUG3RBd-R6Ze5I6hibOZ83SMTzPI-Hod_vnhecnDJtWwofBSf5_2chenumbxCQfBkcEgeivb_XUBDWSRgC36dj9QDK_H9M_5B7-Jo80e-37_jy7Qf51j95Nbf2nXaWA"/></figure><p>然后，我们将对配置进行一次预演:</p><figure class="wp-block-image"><img loading="lazy" src="../Images/150f5e1e0dc5a7353dd209b53735a0a4.png" alt="" data-original-src="https://lh4.googleusercontent.com/BsubaMTbXMS_YSkL0tcOKJvpdr_WRixMsfHl0A_2FRxE_1yDE8DevUFW30CdvAN82UJqj5qV2scqU243vNpXiQfGwWsDqqUJUfI0RdXXHNa4rC8Mkpu4SrI3oXqDBeoC6-3hzANL1k1iWHjw-w"/></figure><p>最后应用我们的配置:</p><figure class="wp-block-image"><img loading="lazy" src="../Images/6f67b4c346485bddf87f0236335c65ab.png" alt="" data-original-src="https://lh3.googleusercontent.com/GobvUsIosQC7cyo_TBFkHCICdOFTRWbr6cSfdeqic4oFrYY4QxjP1Bf9pHJkXYfUQg3kjZCIUlHZJcBIxC2gjPmf753cHIRFuSq5ulRe1JSYk-iSxoZBRRJFtKObh43nsl57sVLdN6OsjCNv1w"/></figure><p>在应用运行之后，我们应该会看到以下输出:</p><figure class="wp-block-image"><img loading="lazy" src="../Images/c8cce326ca6b02b2b1dc6471c10f2be6.png" alt="" data-original-src="https://lh5.googleusercontent.com/ADmBCoGBI-wprSXuVut9BCpuIOlKOt9DvQbn-nzgCNpN0qdZcxswPnAMxZ39mZLsG2Sabb6QIBs3zqvdOhOopCdzioxOAU3Gell_a7VYJx3YnFGdag8uySU34Vvza6O_gTNi9xnDPo4WhX00gw"/></figure><h3 id="h-testing-our-application"><strong>测试我们的应用</strong></h3><p>现在我们的资源已经部署好了，我们有了显示在终端输出中的应用程序端点。</p><p>转到您的浏览器，使用输出中显示的地址导航到我们的应用程序。您应该看到以下内容:</p><figure class="wp-block-image"><img loading="lazy" src="../Images/7ab19e7c4286adfbe828663b2ffada4d.png" alt="" data-original-src="https://lh6.googleusercontent.com/ySIMyT4vohHS73fQZE_y5ENZo45tIUVq-2kDyrtNVc1ljGRd2LegWfZ7GSKTFUEo6p5sn9Yg4We0p6wByiY8Sy4zfkgAan9kXhrjzN4XeNu8zWj-8PO2f5Xct-BleS_gGFLp7mtPv_y1NpvOAA"/></figure><p>现在，如果您选择其中一个选项，您应该会立即看到如下的投票结果:</p><figure class="wp-block-image"><img loading="lazy" src="../Images/66bbea14c7826549a39d3bcfb40b833b.png" alt="" data-original-src="https://lh6.googleusercontent.com/HZli9iHZs91-UgHebYmfFoR4xWkyq1QuSDVMtbeOIfPelOMCj11UuAvsDq5h9vawSVVwUzD32s1YpLf-AwvbM5Q2w8TL5My0Ry1Qhnx3Mjep0flHt9BAP0AK8kDhgYDjjVp0A8gLFyosyo-wpw"/></figure><h2 id="h-step-4-success">第四步:成功！</h2><p>就是这样！您已经成功地使用Terraform和Cosmos DB在Azure中部署了一个简单的应用程序。正如你所看到的，这是快速而简单的，只需要几行Terraform代码。要了解更多，请查看我的课程<a href="https://learn.acloud.guru/course/advanced-terraform-with-azure/dashboard" target="_blank" rel="noreferrer noopener">Advanced terra form with Azure</a>。保持令人敬畏的大师，学习所有的东西！下次见。</p><p class="has-text-align-center"><em>想要跟上Azure的所有事物？</em> <a href="https://www.youtube.com/c/AcloudGuru" target="_blank" rel="noreferrer noopener"> <em>在YouTube上订阅一位云大师</em> </a> <em>，获取每周亚马逊新闻和AWS公告。你也可以像ACG上的</em><a href="https://www.facebook.com/acloudguru" target="_blank" rel="noreferrer noopener"><em/></a><em>一样，关注我们上的</em> <a href="https://twitter.com/acloudguru" target="_blank" rel="noreferrer noopener"> <em>推特</em> </a> <em>，或者加入</em> <a href="https://discord.com/invite/pluralsight" target="_blank" rel="noreferrer noopener"> <em>不和谐</em> </a> <em>的对话！</em></p></div></div>    
</body>
</html>