<html>
<head>
<title>How to build a multi-region active-active architecture on AWS | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何在AWS上构建多区域主动-主动架构|云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/why-and-how-do-we-build-a-multi-region-active-active-architecture#0001-01-01">https://acloudguru.com/blog/engineering/why-and-how-do-we-build-a-multi-region-active-active-architecture#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><h2 id="h-everything-fails-all-the-time-build-for-resiliency">任何事情都有失败的时候—构建弹性</h2><figure class="wp-block-pullquote has-border-color"><blockquote><p>任何足够先进的技术都和魔法没什么区别。</p><cite>Arthur C. Clarke</cite></blockquote></figure><p id="581d">这是我们构建多区域、主动-主动架构系列的第二部分。在上一篇文章中，我们谈到了对可用性 的<strong> <a href="https://read.acloud.guru/the-quest-for-availability-771fa8a94a7c" target="_blank" rel="noreferrer noopener">追求，因为它是这种设计的核心。在本帖中，我们将讨论设计多区域主动-主动架构的<strong>为什么</strong>和<strong>如何</strong>。</a></strong></p><p id="20a2">请记住，构建和成功运行多区域主动-主动架构是很困难的，所以这篇文章不会假装涵盖所有相关的内容。相反，它应该被视为这种艺术的介绍。</p><h2 id="016c">为什么要为多区域架构烦恼呢？</h2><p id="c076">好问题，很高兴你问了！基本上有三个原因可以解释为什么你想要一个多区域架构。</p><ol><li><strong>改善最终用户的延迟</strong></li><li><strong>灾难恢复</strong></li><li><strong>业务需求</strong></li></ol><h3 id="b323"><strong> 1。改善最终用户的延迟</strong></h3><p id="7941">这个想法非常简单，与光速有关，但还没有人能够破解。你的后台离终端用户越近，体验就越好。</p><p id="8457">像<a href="https://aws.amazon.com/cloudfront/" target="_blank" rel="noreferrer noopener">亚马逊CloudFront </a>这样的内容交付网络(CDN)用于加速内容的交付，尤其是静态内容(例如图像、视频、JavaScript库等。)提供给全球的最终用户。使用全球分布的缓存服务器网络，静态内容就像在本地一样被提供给消费者，从而改进了静态内容的交付。</p><p id="1685">然而，即使CloudFront为您的大部分内容解决了问题，一些更动态的调用仍然需要在后端完成，而且它可能离您很远，这给请求增加了宝贵的毫秒数。</p><p id="d5c6">例如，如果您的用户在欧洲，但您的后端在美国或澳大利亚，则增加的延迟分别约为140毫秒和300毫秒。对于许多流行的游戏、银行业务需求或交互式应用来说，这些延迟是不可接受的。</p><p id="0c00">事实上，延迟在客户对高质量体验的感知中扮演着重要角色，并被证明在一定程度上影响着用户的行为，<a href="https://dl.acm.org/citation.cfm?id=2609627" target="_blank" rel="noreferrer noopener">延迟越低，用户参与度越大</a>。</p><p id="89a8">大公司也多次证实了这一观察结果:</p><ul><li><strong>亚马逊</strong> : 100毫秒的额外加载时间导致销售额下降1%(格雷格林登，消息来源<a href="http://stanforddatamining.2006-11-29.ppt/" target="_blank" rel="noreferrer noopener">此处</a>)。</li><li><strong>谷歌</strong> : 500毫秒的额外加载时间导致搜索减少了20%(玛丽莎·梅耶尔，来源<a href="https://books.google.fi/books?id=UPY7Tt_nlBAC&amp;lpg=PA105&amp;ots=_w_03082nU&amp;dq=Google%20500%20ms%20of%20extra%20load%20time%2020%25%20fewer%20searches%20Marrissa%20Mayer&amp;pg=PA105#v=onepage&amp;q=Google%20500%20ms%20of%20extra%20load%20time%2020%25%20fewer%20searches%20Marrissa%20Mayer&amp;f=false" target="_blank" rel="noreferrer noopener">此处</a>)。</li><li>雅虎！ : 400毫秒的额外加载时间导致页面加载前点击“返回”的人数增加了5-9%(妮可·沙利文，消息来源<a href="https://books.google.fi/books?id=UPY7Tt_nlBAC&amp;lpg=PA105&amp;ots=_w_03082sS&amp;dq=400%20ms%20of%20extra%20load%20time%20caused%20a%205%E2%80%939%25%20increase%20in%20the%20number%20of%20people%20who%20clicked%20%E2%80%9Cback%E2%80%9D&amp;pg=PA105#v=onepage&amp;q=400%20ms%20of%20extra%20load%20time%20caused%20a%205%E2%80%939%25%20increase%20in%20the%20number%20of%20people%20who%20clicked%20%E2%80%9Cback%E2%80%9D&amp;f=false" target="_blank" rel="noreferrer noopener">此处</a>)。</li></ul><p id="313b">随着技术的进步，特别是随着AR、VR和MR的出现，需要更身临其境和逼真的体验，开发人员需要生产具有严格延迟要求的软件系统。因此，拥有本地可用的应用程序和内容变得越来越重要。</p><h3 id="a271"><strong> 2。灾难恢复</strong></h3><p id="bdb4">在2012年平安夜上，<a href="https://medium.com/netflix-techblog/a-closer-look-at-the-christmas-eve-outage-d7b409a529ee" target="_blank" rel="noreferrer noopener">网飞流媒体服务经历了由AWS <a href="https://aws.amazon.com/message/680587/" target="_blank" rel="noreferrer noopener"> ELB控制平面</a>引起的中断</a>。ELB的失败超出了网飞的纠正能力。</p><p id="5c3e">接下来是任何AWS客户的一些重要和鼓舞人心的工程工作——实现<strong>区域弹性</strong>。</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/f90875067ad6a142bcfbbd7278e2d7e1.png" alt="" class="wp-image-42547" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_e1Xht1m5hZF5S07my4gbZg.png"/><figcaption>Regional Resiliency at work.</figcaption></figure></div><blockquote class="wp-block-quote"><p>正如<a href="https://netflixtechblog.com/a-closer-look-at-the-christmas-eve-outage-d7b409a529ee" target="_blank" rel="noreferrer noopener">网飞在其博客上解释</a>的那样，“网飞旨在处理一个区域中单个可用性区域的全部或部分故障，因为我们跨三个区域运行，并且两个区域的功能没有损失。我们正在研究如何<strong>扩展我们的弹性，以处理部分或全部地区中断</strong></p></blockquote><p id="c0f8">事实上，如果您的应用程序由多个不同的服务组成，并且其中一个对您的应用程序至关重要的服务遇到了问题，您可能希望将流量转移到一个健康的区域，以防止客户生气。</p><p id="37ee">网飞并不是唯一一个从ELB的失败中吸取教训的人——AWS也从那次失败中吸取了教训，并且已经采取措施减小潜在失败的爆炸半径。如今，控制平面的实现更加健壮。</p><p id="31da">失败总是会发生，当失败发生时，重要的是既要努力减少问题的发生，又要努力减轻问题影响的严重性。</p><h3 id="a5c7"><strong> 3。业务需求</strong></h3><p id="c573">最后，一些客户可能有在相距数百公里的不同区域存储数据的业务需求。因此，这些客户必须在多个区域存储数据。这变得越来越普遍，因为AWS现在在全球有18个地区，分布在美洲、亚太、欧洲、中东和非洲。</p><h2 id="73c7">如何在AWS中构建多区域主动-主动架构</h2><p id="5f81">简而言之，多区域主动-主动架构获得跨多个AWS区域部署的客户机请求路径上的所有服务。为此，必须满足几个要求。</p><ol><li>地区间的数据复制一定要<strong>快</strong><strong/><strong>可靠</strong>。</li><li>你需要一个<strong>全球</strong> <strong>网络基础设施</strong>来连接你的不同地区。</li><li>服务不应该有本地状态——它们必须是<strong>无状态的</strong>，并且状态应该在区域之间共享。</li><li>应尽可能避免跨地区的同步呼叫。应用程序应该<strong>使用区域资源</strong>。</li><li><strong> DNS路由</strong>应该用于允许不同的场景。</li></ol><p id="0603">让我们仔细看看这些要求。</p><h3 id="2f33">1.可靠的数据复制</h3><p id="c808">先简单说一下<a href="https://en.wikipedia.org/wiki/CAP_theorem" target="_blank" rel="noreferrer noopener"> CAP定理</a>。CAP定理指出，分布式系统不可能同时提供以下三种保证中的两种以上:<a href="https://en.wikipedia.org/wiki/Consistency_model" target="_blank" rel="noreferrer noopener"><strong/></a><strong><a href="https://en.wikipedia.org/wiki/Availability" target="_blank" rel="noreferrer noopener">可用性</a> </strong>和<a href="https://en.wikipedia.org/wiki/Network_partitioning" target="_blank" rel="noreferrer noopener"> <strong>分区容差</strong> </a> <strong>。但是特别是在存在网络分区的情况下，人们必须在一致性和可用性之间做出选择。</strong></p><p id="0f0e">这意味着我们有两个选择:放弃一致性将允许系统保持高可用性，优先考虑一致性意味着系统可能不总是可用的。</p><p id="7244">因为我们正在构建一个多区域架构，并且正在优化可用性，所以我们必须放弃一致性——从设计上来说，这也意味着我们需要<strong>采用异步系统和复制</strong>。</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/400d0c314efa91af948f502147d66537.png" alt="" class="wp-image-42549" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_ETiKPw0DVSPcNiJOIGo4Dw.png"/><figcaption>Synchronous vs asynchronous pattern</figcaption></figure></div><p id="a113">对于分布式数据存储，异步复制以引入复制滞后或延迟为代价，将主节点与其副本分离。</p><p id="f33e">这意味着在主节点上执行的更改不会立即反映在其副本上——这种滞后的结果产生了通常被称为<a href="https://en.wikipedia.org/wiki/Eventual_consistency" target="_blank" rel="noreferrer noopener">最终一致性</a>的情况。当一个系统达到最终的一致性时，我们说它已经收敛，或者达到了副本收敛。</p><p id="5226">为了实现副本收敛，系统必须协调分布式数据的多个副本之间的差异。它可以通过执行以下协调来实现这一点:</p><ul><li>比较数据的版本</li><li>数据本身的“智能”比较</li><li>选择任意的最终状态</li></ul><p id="c1d0">最常见的协调方法，也是大多数系统中使用的方法，包括DynamoDB全局表，被称为<em>“最后一个写入者获胜”</em>。</p><p id="0cf7">在设计应用程序时，必须考虑到<strong>异步复制</strong>的影响，因为除了对架构产生影响之外，它还会对客户端用户界面设计和体验产生一些影响。</p><p id="cc58">这意味着接口应该是完全无阻塞的。用户交互和操作应该立即解决，而不需要等待任何后端响应——所有事情都应该在后台异步解决，并且对用户透明。</p><p id="d6aa">没有加载消息或微调永远停留在屏幕上。对服务器的请求应该与用户界面完全分离。这种“技巧”还会让用户相信应用程序很快，即使实际上并不是这样——隐藏网络延迟甚至全面服务失败。</p><p id="ab62">这通常被称为<strong>优雅降级</strong>，它也被网飞用来减轻某些故障。</p><h3 id="49dc">2.全球网络基础设施</h3><p id="e8bd">几年前，在部署多区域体系结构时，标准做法是在区域之间建立安全的VPN连接，以便异步复制数据。</p><p id="1030">虽然部署和管理这些连接变得更加容易，但主要问题是它们通过互联网传输，因此容易受到路由突然变化的影响，尤其是延迟，这使得很难保持一致的良好复制。</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/36e9cabca959be02f131525773e283a1.png" alt="" class="wp-image-42545" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1__HlloqwPf-F9f3WWcAtGtA.png"/><figcaption>James Hamilton — AWS re:Invent 2016</figcaption></figure></div><p id="0fe0">为了克服这个问题，AWS副总裁兼杰出工程师詹姆斯·汉密尔顿<a href="https://www.youtube.com/watch?v=uj7Ting6Ckk" target="_blank" rel="noreferrer noopener">宣布</a>AWS将提供高带宽的全球网络基础设施，由环绕全球的冗余100GbE链路供电。</p><p id="21ed">这意味着AWS区域连接到一个专用的全球网络主干，与公共互联网相比，它提供了更低的成本和更一致的跨区域网络延迟，其优势显而易见:</p><ol><li>改进延迟、数据包丢失和整体质量</li><li>避免网络互连容量冲突</li><li>更强的运营控制</li></ol><h3 id="8e5b">3.无状态应用程序</h3><p id="6599">我之前写过<a href="https://hackernoon.com/10-lessons-from-10-years-of-aws-part-1-258b56703fcf" target="_blank" rel="noreferrer noopener">本地状态是云反模式</a>。对于多区域架构来说更是如此。当客户端与应用程序交互时，它们通过一系列称为会话的交互来完成。</p><p id="198c">在无状态架构中，服务器必须独立于之前的请求或会话来处理所有客户端请求，并且不应该在本地存储任何会话信息。因此，给定相同的输入，无状态应用程序应该向任何最终用户提供相同的响应。</p><p id="e6df">无状态应用程序可以水平扩展，因为任何请求都可以由任何可用的计算资源(例如，实例、容器或函数)来处理。</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/319e40db3548b06313d64c43e8da45ad.png" alt="" class="wp-image-42550" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_HbJKa9tYyaDHWxEo_UNMTg.png"/><figcaption>Stateful Applications</figcaption></figure></div><p id="f91c">通过使用像<a href="http://memcached.org/" target="_blank" rel="noreferrer noopener"> Memcached </a>、<a href="https://redis.io/" target="_blank" rel="noreferrer noopener"> Redis </a>、<a href="https://github.com/netflix/evcache/wiki" target="_blank" rel="noreferrer noopener"> EVCache </a>这样的内存对象缓存系统，或者像<a href="http://cassandra.apache.org/" target="_blank" rel="noreferrer noopener"> Cassandra </a>或<a href="https://aws.amazon.com/dynamodb/" target="_blank" rel="noreferrer noopener"> DynamoDB </a>这样的分布式数据库，可以与任何实例、容器或函数共享状态，这取决于您的对象的结构和您在性能方面的需求。</p><p id="0b05">2013年，网飞<a href="https://www.youtube.com/watch?v=hAyA86QGRnI" target="_blank" rel="noreferrer noopener">讲述了</a>和<a href="https://medium.com/netflix-techblog/active-active-for-multi-regional-resiliency-c47719f6685b" target="_blank" rel="noreferrer noopener">写下了</a>关于在多区域设置中测试Cassandra的著名故事，在多区域集群的一个区域中写入100万条记录，然后在500毫秒后在另一个区域中读取，同时保持集群上的生产负载水平——所有这些都没有任何数据丢失。</p><h3 id="57df">4.使用本地资源，避免跨区域通话</h3><p id="f2f8">如前所述，防止延迟增加对应用程序至关重要。因此，重要的是避免同步跨区域调用，并始终确保本地资源可供应用程序使用，从而优化延迟。</p><p id="387e">例如，存储在亚马逊S3存储桶中的对象应该在多个地区复制，以允许从任何地区进行本地访问。幸运的是，亚马逊为亚马逊S3实现了功能<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/crr.html" target="_blank" rel="noreferrer noopener">跨区域复制</a>。跨区域复制是一种存储桶级别的配置，支持跨不同AWS区域中的存储桶自动、异步复制对象。</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/e682699e4ea9ffb6d9d1a1f7cd9f1ab0.png" alt="" class="wp-image-42554" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_SMawCtVcSkQ6ZaQMZ0Vd7Q.png"/><figcaption>S3 Cross Region replication</figcaption></figure></div><p>这种资源的本地访问也适用于数据库。为了支持这种情况，AWS推出了针对MySQL的亚马逊RDS的<a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_ReadRepl.html" target="_blank" rel="noreferrer noopener">跨区域读取副本，随后是MariaDB、PostgreSQL </a>和<a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/AuroraMySQL.Replication.CrossRegion.html" target="_blank" rel="noreferrer noopener">亚马逊Aurora </a>。</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/27a151be4c87d1de6575c098bade385b.png" alt="" class="wp-image-42551" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_lA2vZQAnJxvIqmeTex-O3A.png"/><figcaption>Cross-Region Read Replicas for Amazon RDS MySQL, MariaDB, PostgreSQL and Amazon Aurora.</figcaption></figure></div><p id="841e">将跨多个区域的写入和读取操作分开将提高您的灾难恢复能力，但这也将使您能够将读取操作扩展到离您的用户更近的区域，并使从一个区域迁移到另一个区域变得更容易。</p><p id="8c97">这种模式的主要限制是，所有关键的写入流量都必须传输到一个位于源区域的主设备。</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/62ce3b6247e7f37086c28b493385fdff.png" alt="" class="wp-image-42557" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_Zkulfkw-4jq07IEEQUh1bw.png"/><figcaption>Reads (green) and Writes (red) patterns.</figcaption></figure></div><p id="7764">请记住，为了使用跨区域读取副本，您必须接受如上所述的最终一致性，因为数据复制是异步的。</p><p id="815b"><em>注意:使用RDS，您可以通过使用</em><a href="http://aws.amazon.com/cloudwatch/" target="_blank" rel="noreferrer noopener"><em>Amazon cloud watch</em></a><em>来监控这种复制延迟，如果它达到您的应用程序无法接受的高水平，就发出警报。</em></p><p id="44c2">为了防止对数据库进行跨区域写入，您可以使用<a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-multi-master.html" target="_blank" rel="noreferrer noopener"> Amazon Aurora多主集群</a>。</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/eca978fd3499051b382bf738272a147a.png" alt="" class="wp-image-42555" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_SqUwu8tKcgrMnl_2wDj38g.png"/><figcaption>Andy Jassy, CEO of AWS, announcing Aurora Multi-Master at re:Invent 2017.</figcaption></figure></div><p id="0243">多主集群提高了Aurora已经很高的可用性。如果您的一个主实例出现故障，集群中的其他实例将立即接管，在实例故障甚至整个AZ故障期间保持读写可用性，应用程序不会停机。</p><p id="d4ca"><a href="https://aws.amazon.com/dynamodb/global-tables/"> Amazon DynamoDB全局表</a>还允许您构建全球分布式应用程序。</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/0715876bab8fc42a258d5a861d2f93fb.png" alt="" class="wp-image-42552" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_n9f2wYeTZrhPxcX-yfzeig.png"/><figcaption>Global applications powered by DynamoDB Global Tables.</figcaption></figure></div><p id="7e6b">DynamoDB全局表由多个副本表组成，每个区域一个副本表，DynamoDB将其视为一个单元。每个副本都有相同的表名和相同的主键模式。</p><p id="e66a">应用程序可以将数据写入任何副本表。DynamoDB自动将写操作传播到其他AWS区域中的其他副本表。</p><p id="a5d8">DynamoDB是在<a href="https://aws.amazon.com/blogs/aws/prime-day-2017-powered-by-aws/" target="_blank" rel="noreferrer noopener">黄金时段</a>在<strong>Amazon.com</strong>使用的同一个数据库。例如，2017年，来自Alexa、Amazon.com网站和亚马逊履行中心的<a href="https://aws.amazon.com/dynamodb/" target="_blank" rel="noreferrer noopener">亚马逊DynamoDB </a>请求总计3.34万亿次，峰值为每秒1290万次。</p><h3 id="a07e">5.DNS路由</h3><p id="3969">为了在地区之间路由流量，我们需要使用支持可配置路由策略的域名系统(DNS)。</p><p id="2ea1"><a href="https://aws.amazon.com/route53/" target="_blank" rel="noreferrer noopener"> Amazon Route 53 </a>提供高度可用和可扩展的域名系统(DNS)、域名注册和健康检查web服务。但对我们的用例来说，最重要的是，它通过各种<a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-policy.html" target="_blank" rel="noreferrer noopener">路由策略</a>支持<a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/traffic-flow.html" target="_blank" rel="noreferrer noopener">流量</a>，所有这些都可以与DNS故障转移相结合。</p><ol><li><strong>地理位置路由策略</strong>:当您希望根据用户的位置路由流量时使用。</li><li><strong>地理邻接路由策略</strong>:当您希望根据资源的位置路由流量时使用，并且可以选择将流量从一个位置的资源转移到另一个位置的资源。</li><li><strong>延迟路由策略</strong>:当您在多个位置拥有资源，并且希望将流量路由到提供最佳延迟的资源时使用。</li><li><strong>多值应答路由策略</strong>:当您希望Route 53使用随机选择的多达八个健康记录来响应DNS查询时使用。</li><li><strong>加权路由策略</strong>:用于按照您指定的比例将流量路由到多个资源。</li></ol><p class="has-text-align-center">Route53的路由策略(地理邻近和延迟)。</p><h2 id="51a5">破败不堪</h2><p id="ca62">在这篇文章中，我们了解到，为了构建多区域主动-主动架构，客户端请求路径上的所有服务必须跨多个AWS区域部署，我们必须采用<strong>异步</strong> <strong>设计和架构</strong>，并且我们必须构建完全<strong/><strong>无状态</strong>的应用程序。</p><p id="303c">当然，我们应该利用像亚马逊S3或DynamoDB这样的高可用性服务，并从亚马逊在全球建立的全球网络中获益，以获得可靠的数据复制。最后，我们还讨论了如何使用流量来支持AWS区域之间的不同路由策略。</p><p id="285d">这部分就讲到这里了。我希望你喜欢它。我要感谢<a href="https://medium.com/u/eed29d74b3fb?source=post_page-----6d81acb7d208--------------------------------" target="_blank" rel="noreferrer noopener">阿德里安·科克罗夫特</a>和<a href="https://medium.com/u/4ffe14103b7a?source=post_page-----6d81acb7d208--------------------------------" target="_blank" rel="noreferrer noopener">朱利安·西蒙</a>提供的宝贵反馈！</p><p id="9bb5">请不要犹豫给出反馈，分享你自己的观点或只是拍手。在下一部分中，我将继续构建一个多区域、主动-主动后端——但将采用无服务器的方式🙂敬请期待！</p></div></div>    
</body>
</html>