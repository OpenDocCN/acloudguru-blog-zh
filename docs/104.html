<html>
<head>
<title>Use Lambda Dead Letter Queues to Retry Failed Kinesis | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Lambda死信队列重试失败的Kinesis |云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/use-sns-to-retry-failed-kinesis-events#0001-01-01">https://acloudguru.com/blog/engineering/use-sns-to-retry-failed-kinesis-events#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>在之前的帖子中，我讨论了用Lambda 处理Kinesis事件的<a href="https://acloudguru.com/blog/engineering/aws-lambda-3-pro-tips-for-working-with-kinesis-streams?utm_source=medium_blog&amp;utm_medium=redirect&amp;utm_campaign=medium_blog">挑战。博客分享了我的一些经验教训和部分失败的技巧，使用死信队列，避免热流。</a></p><p id="1582">关于失败的记录，我讨论过，虽然Lambda对死信队列的支持扩展到了异步调用，如<em> SNS </em>和<em> S3 </em>，但它不支持基于轮询的调用，如<em> Kinesis </em>和<em> DynamoDB </em>流。这意味着开发者仍然需要为Kinesis功能实现重试策略——潜在地利用SNS的重试流程。</p><p id="1582">由于SNS已经提供了DLQ支持，您可以通过将失败事件发送到SNS主题来简化设置。Lambda会再处理3次，然后将其传递给指定的DLQ。</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/4a2e545b8db74bf40df4e203fbccd48d.png" alt="Treat Kinesis and SNS as different entries" class="wp-image-42810" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_RrSXb7Kiep3OX5KIMVoqBg.png"/><figcaption>Treat Kinesis and SNS as different entries points to some business logic that reacts to an event in your domain.</figcaption></figure></div><p id="9918">在博客中，我将提供一些具体的例子来说明这是多么容易实现。如果你想自己尝试一下，这篇博客中的例子的代码可以在<a href="https://github.com/theburningmonk/lambda-kinesis-retry-with-sns-demo?opt_id=oeu1606941838236r0.28011037357183466" target="_blank" rel="noreferrer noopener"> github </a>获得。</p><h2 id="cc98">运动机能</h2><p id="101a">在我们的运动功能中，我们需要记录我们未能处理的事件。在函数结束时，我们可以将它们发布到SNS进行进一步的重试，并利用SNS与Lambda内置的“重试然后死信队列”流。</p><p id="4c3a">正如在上一篇文章中提到的，保持系统实时处理事件通常比确保每个事件都被成功处理更重要，但是你仍然希望在放弃之前给失败的事件一些重试的机会。</p>  <p>作为演示项目的一部分，我还为您提供了一个API端点，用于<a href="https://acloudguru.com/blog/engineering/deep-dive-into-aws-kinesis-at-scale">将事件触发到Kinesis </a>。一旦部署完毕，如果您使用查询字符串参数<code>?fail=true</code>点击端点，那么您可以观察到Kinesis由于一个错误而无法处理记录:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/8448ade444fbd1cfe46dcec0e7a41648.png" alt="Kinesis failing to process the record due to an error" class="wp-image-42807" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_O3rZDHnHMzxCX_bQQTepkw.png"/></figure><p id="62db">该事件然后将被发布到社交网站。</p><h2 id="32af">社交网络发布</h2><p id="5c9d">在SNS函数中，我们将提取发布到Kinesis的原始事件对象，并尝试使用与Kinesis函数相同的业务逻辑再次处理它。</p><p>开箱即用，我们得到3次尝试，再次用SNS事件源处理失败的Kinesis事件。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/df15eca591ef971e4885c2dfbcb28e5e.png" alt=" 3 attempts at processing the failed Kinesis event" class="wp-image-42811" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_UBRPeXqiVF2frWwAGhdSeg.png"/></figure><p id="9a34">在所有3次尝试都用尽之后，还有一次机会用<a href="http://docs.aws.amazon.com/lambda/latest/dg/dlq.html" target="_blank" rel="noreferrer noopener">死信队列(DLQ)支持</a>保存数据——这仅适用于SNS等异步事件源。</p><p id="db93">从<a href="https://serverless.com/framework/" target="_blank" rel="noreferrer noopener">无服务器</a>框架的1.22.0版本开始，不支持添加<a href="https://www.serverless.com/framework/docs/providers/aws/guide/serverless.yml/"> SQS作为死信队列资源</a>(通过<code>onError</code>属性)。</p><p id="73b4">还有<a href="https://www.npmjs.com/package/serverless-plugin-lambda-dead-letter" target="_blank" rel="noreferrer noopener">无服务器插件-lambda-dead-letter </a>插件，但我从未设法让它工作。因此，与此同时，如果您想使用SQS，您可能需要手动设置DLQ资源。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/e22f0e1e86e751914091ec3ae40b7ebb.png" alt="AWS service after exceeding maximum retries " class="wp-image-42812" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_VOpdtQgKpeOpug7C0FG7YQ.png"/></figure><p>在我们的Kinesis事件被SNS处理了3次之后，我们可以看到SNS事件已经被推送到指定的SQS队列…</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/d6598af9fc0f2a547c2ea5d8e953ca68.png" alt="Kinesis SQS" class="wp-image-42805" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_1CvxadolFDpjAtojok5GUA.png"/><figcaption>…with the entire event payload for the SNS function as message.</figcaption></figure></div><p>SNS消息还有一些额外的消息属性，尽管它们可能对你没用，尤其是我知道的200 <code>ErrorCode.</code>消息，我也被它弄糊涂了！</p><p id="4d91">因此，这是一种简单的方法，可以让Lambda借用SNS错误处理流来重试几次失败的Kinesis事件，同时在带外完成，以允许流继续进行，并保持系统的实时性。</p><h4 id="4e64"><strong>用一致性换取实时性</strong></h4><p id="055d">使用Kinesis的一个主要好处是给定分区键的事件顺序得以保留。例如，对于一个给定的用户ID，这意味着我们可以按照Kinesis接收事件的顺序来处理与该用户相关的事件。我们甚至可以通过在<a href="http://docs.aws.amazon.com/kinesis/latest/APIReference/API_PutRecord.html#API_PutRecord_RequestSyntax" target="_blank" rel="noreferrer noopener">腐败记录</a>请求中设置<code>SequenceNumberForOrdering</code>属性来加强事件的排序。</p><p id="17f4"><strong>我在这里概述的方法牺牲了这种一致性</strong>,因为它将重试推迟到后台进程，因此重试的事件可以相对于同一个分区键的其他事件无序处理。</p><p id="884f">这是一个有意识的权衡，允许Kinesis处理在处理一些事件时持续失败，并保持系统的整体实时性，正如我在以前的帖子中所述:</p><p>我们发现保持系统运行比暂停任何失败事件的处理更重要，即使只有一分钟。</p><p id="563b">需要记住的另一件事是，除非您能够设计出有害消息(当然，这是完全可行的)，否则当持续失败的事件从流中过期时，最终将会为您做出丢弃这些事件的决定。</p><h4 id="88c8">考虑SNS重试对下游系统的影响</h4><p id="3bdf">正如我在关于发布-订阅和推拉消息模式的文章中所讨论的,<a href="https://acloudguru.com/blog/engineering/auto-scaling-kinesis-streams-with-aws-lambda">将Kinesis与Lambda </a>结合使用的另一个好处是，它允许您控制传递给下游系统的负载量。</p><p id="7c46">如果突然出现大量失败事件，通过SNS进行的<strong>重试可能会淹没您的下游系统，进而导致更多失败事件</strong>并进一步升级糟糕的情况。</p><h4 id="0920">总之——保持真实</h4><p id="71f8">由于Kinesis的工作方式，并发和重试的级别是在每个分片的级别，这迫使我们在以下两者之间做出选择:</p><ol><li>保持整个系统的实时性，并丢弃持续失败的事件</li><li>确保所有活动都成功进行</li></ol><p id="dd65">在一个重试直到成功的行为可以被缩小到每个分区键级别的世界里，那么也许我们不需要进行这种权衡。</p><p id="0fc2">就目前的情况来看，我认为所有的实时事件处理系统都应该选择选项1——否则，你就不能真正构建一个“实时”系统。</p><p id="a1f0">如果这是你的决定，那么这里概述的方法使你更容易实现重试三次，然后DLQ流程，因为它搭载了Lambda的SNS内置重试行为。</p><p id="3d0e">如果您选择选项2来确保成功处理所有事件，那么这种方法绝对不适合您！相反，您应该专注于监控和警报，以便快速发现这些有害消息，并将您的系统设计为能够更好地处理它们。</p><p id="a743">如果，事实证明，你对有害信息的唯一防御是“丢弃它们”——那么你可以首先选择选项1。</p><hr class="wp-block-separator"/><h2 class="has-text-align-center" id="h-level-up-your-cloud-career">提升您的云计算职业生涯</h2><p class="has-text-align-center">无论您是云新手还是经验丰富的专家，云专家都能让您轻松(而且非常棒)地获得认证并掌握现代技术技能。查看ACG目前的免费课程或立即开始免费试用。</p><hr class="wp-block-separator"/></div></div>    
</body>
</html>