<html>
<head>
<title>How to audit and secure an AWS account | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何审计和保护AWS帐户|云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/how-to-audit-and-secure-an-aws-account#0001-01-01">https://acloudguru.com/blog/engineering/how-to-audit-and-secure-an-aws-account#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>据Statista 称，数据泄露和暴露的凭据:这只是让网络安全专家夜不能寐的几个云安全问题。确实很可怕。这就是为什么对于任何重视自身持续存在的组织来说，投入时间对云环境进行适当的审计和保护仍然是重中之重。在本帖中，我们将讨论如何审计和保护AWS帐户</p><p>但是，当涉及到保护您的AWS帐户时，您应该从哪里开始呢？</p><p>我们可以从几个基本问题开始，我们将在这篇博文中回答这些问题:</p><ul><li>我们如何审计AWS账户？</li></ul><ul><li>我们如何保护AWS帐户的安全？</li></ul><ul><li><span>我们的工具箱里有哪些AWS原生工具？</span></li></ul><p>以下提示和见解由杰出的安全工程师唐·麦咭提供。唐是一位爱猫人士，是一位拥有20多年IT经验的资深<a href="https://acloudguru.com/blog/engineering/what-is-a-cloud-architect-and-how-do-you-become-one" target="_blank" rel="noreferrer noopener">云架构师</a>，也是<a href="https://www.stedi.com/" target="_blank" rel="noreferrer noopener"> Stedi </a>的云安全主管，Stedi是一家100%远程、完全无服务器的B2B SaaS提供商。</p><p/><p class="has-text-align-center"><em>本内容基于我们的</em> <a href="https://get.acloudguru.com/securing-aws-environment-webinar?&amp;ajs_aid=8b2cc73f-c0e0-442b-ba6d-0eb362250ebb" target="_blank" rel="noreferrer noopener"> <em>保护您的AWS环境</em> </a> <em> ACG网络研讨会。任何错误都是编辑的责任。</em></p><p>保护AWS帐户的大部分工作都可以通过AWS原生工具来完成。</p><p>以下并不是一个完整的列表，但是这些是Don在Stedi的工作中发现的最有影响力的AWS原生工具。我们将在下面详细讨论其中的一些工具。</p><ul><li><strong>账户和组织</strong> —这提供了最强的<a href="https://acloudguru.com/blog/engineering/ransomware-and-aws-6-ways-to-reduce-your-blast-radius" target="_blank" rel="noreferrer noopener">爆炸半径</a>来限制安全事件的影响。</li></ul><ul><li><strong>访问和身份管理(IAM)——</strong>通过角色、策略和用户管理对服务和资源的访问</li></ul><ul><li><strong>日志记录— </strong> Cloudtrail、S3访问日志、流量日志、CloudWatch日志</li></ul><ul><li><strong>基础设施和数据保护— </strong> VPC、神盾局、WAF、网络防火墙、马西、KMS、证书管理器、机密管理器</li></ul><ul><li><strong>安全评估、事件响应、数据保护和威胁检测— </strong>警卫、检查员、Confi、侦探、工件、安全中心</li></ul><hr class="wp-block-separator"/><p class="has-text-align-center"><a href="https://acloudguru.com/blog/engineering/12-aws-config-rules-that-every-account-should-have" target="_blank" rel="noreferrer noopener"> <strong> 12 AWS配置规则每个账户都应该有</strong> </a> <br/>在<a href="https://acloudguru.com/blog/engineering/12-aws-config-rules-that-every-account-should-have" target="_blank" rel="noreferrer noopener">这篇博文</a>中，看到了AWS配置规则，应该被认为是任何账户的最低要求。</p><hr class="wp-block-separator"/><h2><strong>如何审计AWS账户</strong></h2><p>当我们深入探讨如何审计和保护AWS帐户时，让我们从审计开始。通过审计AWS帐户，您可以查看IAM用户、角色、组和策略，并查看是否有任何用户或工具拥有过多的权限。</p><p>审计是至关重要的，因为你不能保护你没有跟踪的东西。审计是确保AWS帐户安全的最基本的工具之一，但是大部分安全工作都是做基本的事情。(但是，当然，基础的东西可能很难。)</p><p>在您的环境中，从第一天开始，以下内容都是可以访问的。</p><h3><strong> 1。生成并维护一份完整的资产清单</strong></h3><p>什么是资产？在AWS领域，资产是任何有标识符的东西。这可能是策略、角色和服务器。我们需要这些东西的清单。一旦我们有了一个列表，那么我们就可以开始弄清楚这些东西是做什么的，我们如何保护这些资源，以及它们是否有任何配置错误。</p><h4>如何创建资产库存</h4><p>建立资产清单有不同的方法。您可以使用第三方工具或CLI脚本，但是有一种快速简单的方法:AWS Config。AWS Config允许您记录和评估AWS资源的配置。</p><p>查看<a href="https://acloudguru.com/blog/engineering/12-aws-config-rules-that-every-account-should-have">这篇文章</a>了解更多关于使用AWS配置创建资产清单的详细信息，以及<a href="https://acloudguru.com/blog/engineering/12-aws-config-rules-that-every-account-should-have"> 12个AWS配置规则，每个帐户都应该有</a>。</p><h3><strong> 2。安全IAM </strong></h3><p>作为审计的一部分，请看一下IAM。IAM经常被赋予过多的特权，所以我们希望确保我们有一个坚实的战略来解决这个问题。</p><h4>身份和访问管理(IAM)基础知识</h4><p>与资源类似，用户和角色经常被授予过度特权。以下是你应该考虑的一些基本事项，作为最低限度的要求:</p><ul><li>确保您配置了密码要求。</li><li>对所有用户实施MFA尤其是根帐户！</li><li>停止说话…停止使用根帐户。除了设置计费计划和更改自己的地址之外，它没有任何实际IAM用户或角色无法完成的有用功能。</li><li>使用访问分析器查找意外访问。您可能会看到有能力由外部实体承担的角色，这可能是您不希望看到的…尤其是如果是您不认识的客户。</li><li>尽可能限制IAM用户的使用。它们带来了额外的风险。</li><li>使用AWS SSO进行人工访问。并为人类建立特定的工作角色。它让开发者的生活变得更加容易。</li><li>根据工作角色而非人员授予用户访问权限。</li><li>禁用任何90天或更长时间未使用的角色。如果另一个90没人投诉，就删了。</li><li>利用开源/第三方工具进行IAM分析。</li></ul><hr class="wp-block-separator"/><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/e66a98be16296610f6a293dee3114286.png" alt="aws iam errors" class="wp-image-29072" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1655/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/06/a-w-s-i-a-m-errors-blog-headers.jpg 1655w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/06/a-w-s-i-a-m-errors-blog-headers.jpg 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/06/a-w-s-i-a-m-errors-blog-headers.jpg 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/06/a-w-s-i-a-m-errors-blog-headers.jpg 768w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1536/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/06/a-w-s-i-a-m-errors-blog-headers.jpg 1536w" sizes="(max-width: 1655px) 100vw, 1655px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/06/a-w-s-i-a-m-errors-blog-headers.jpg"/></figure><p class="has-text-align-center"><a href="https://acloudguru.com/blog/engineering/fixing-5-common-aws-iam-errors" target="_blank" rel="noreferrer noopener"> <strong>了解如何修复5个常见的AWS IAM错误</strong> </a> <br/> AWS IAM错误很常见。别担心！在<a href="https://acloudguru.com/blog/engineering/fixing-5-common-aws-iam-errors" target="_blank" rel="noreferrer noopener">这篇博文</a>中，我们深入探讨了5种常见AWS IAM错误的原因和解决方法。</p><hr class="wp-block-separator"/><h3><strong> 3。寻找公共资源</strong></h3><p>一旦你有了资产清单，并在IAM上浏览了一遍，你就需要开始处理公共资源。</p><p>这些都是我们已经确定为公开的，因此是风险点。这些可以包括S3、EBS快照、SNS、数据库等等。</p><p>我们看到像S3错误配置这样的事情，但还有其他可能是公开的危险但被忽视的事情。例如，有时人们拍摄服务器的快照，并意外地将它们配置为公共的。我们需要检查这些东西！</p><p>公开可用的资源可能会导致数据泄露、数据丢失以及对帐户和服务的意外访问。(那些不好。)这就是为什么我们需要确定公开可用的资源。</p><p>非故意公开的常见资源包括:</p><ul><li>S3桶或物体</li><li>快照</li><li>社交网络话题</li><li>数据库</li><li>EC2实例</li></ul><p>“我要做一个非常不受欢迎的声明:没有任何好的理由，S3水桶应该是公开的，”唐说。“从来没有人给过我一个好的理由。”</p><p>要查找公共资源，可以使用开源工具，第三方工具，或者<a href="https://acloudguru.com/blog/engineering/12-aws-config-rules-that-every-account-should-have" target="_blank" rel="noreferrer noopener"> AWS Config </a>。但是<em>你</em>必须去补救它们。</p><p>这里有一些你可以立即完成的快速简单的胜利。这些是唐最起码的要求:</p><ul><li>在帐户级别启用S3公共访问阻止</li><li>打开警戒</li><li>使用AWS防火墙管理器将通用IP安全规则应用于所有VPC</li><li>利用托管配置规则，但不要害怕编写自己的规则！</li></ul><h3><strong> 4。使用AWS组织</strong></h3><h4>推荐的AWS组织结构</h4><p>AWS组织是一个最被低估的安全领域。这是您的安全工具箱中最强大的工具之一。</p><p>账户就是边界。你必须允许东西进出账户。你不能用AWS中的其他任何东西来说。即使有了VPCs，您也必须采取额外的步骤来使它比开箱即用更加安全。默认情况下，除非您允许，否则没有任何东西可以进出帐户。</p><p>我们将这些用作我们技术体系中特定部分的服务帐户。每个团队或服务都有一个帐户。</p><ul><li><strong> Root /管理帐户—托管组织</strong><ul><li>生产OU、生产前OU、构建OU、开发OU<ul><li>每个人对每项服务都有一个帐户</li></ul></li><li>运营OU<ul><li>公司系统账户(账单、内部IT等。)</li><li>DNS帐户—将子域委派给其他帐户</li></ul></li><li>安全OU<ul><li>安全帐户—所有安全工具(警卫、SIEM、配置等)的所有者。)</li><li>日志记录帐户—安全部门使用的所有日志的真实来源</li></ul></li><li>暂停OU<ul><li>这是我们保存关闭或未使用账户的地方</li><li>有SCP来阻止采取任何行动</li></ul></li></ul></li></ul><hr class="wp-block-separator"/><p class="has-text-align-center"><strong> <a href="https://get.acloudguru.com/securing-aws-environment-webinar" target="_blank" rel="noreferrer noopener">保护您的AWS环境<br/> </a> </strong>在<a href="https://get.acloudguru.com/securing-aws-environment-webinar">这个免费的点播式网络研讨会</a>中，您将了解如何从零开始保护复杂的AWS环境，并了解如何审计和保护AWS帐户。</p><p class="wp-container-640f2a29da4a3 wp-block-buttons"/><hr class="wp-block-separator"/><h3><strong> 5。确保审计日志已启用</strong></h3><p>接下来，我们必须有审计日志。审核日志对于检测值得注意的事件至关重要，有助于您了解事件发生后的情况。</p><p>CloudTrail基本上是AWS中大多数情况下发生的每个动作的自动日志。但是，根据您的工作负载，您也可以考虑其他服务，包括VPC流日志(如果您使用服务器)或S3访问日志(如果您公开使用存储桶)。</p><h4>AWS审计日志记录基础</h4><ul><li>确保启用了CloudTrail并在S3中存储日志。<ul><li>S3存储桶应该具有高度受限的访问权限</li><li>最佳做法是将所有日志存储在专用帐户中</li><li>如果使用AWS组织，请打开全局CloudTrail</li></ul></li><li>其他值得注意的日志有S3访问日志、CloudWatch日志、WAF日志和VPC流日志</li><li>没有SIEM工具，日志几乎毫无用处。</li><li>只要有用，就只储存多头。</li></ul><p>CloudTrail很快就会变得昂贵，尤其是如果你在S3存储的话。你只需要保留你需要的东西。但是你需要它。如果您没有打开CloudTrail，您就无法检测事件。</p><h4>如何通过CLI打开全局CloudTrail</h4><p>创建一个S3存储桶来存储日志，并确保该存储桶尽可能被锁定。然后，通过CLI启用全局CloudTrail:</p><ul><li><code>aws organizations enable-all-features</code></li><li><code>aws organizations enable-aws-service-access --service-principal <a href="http://cloudtrail.amazonaws.com" target="_blank" rel="noreferrer noopener">cloudtrail.amazonaws.com</a></code></li><li><code>aws cloudtrail create-trail --name my-trail --s3-bucket-name my-bucket --is-organization-trail —is-multi-region-trail</code></li></ul><p>如果使用SIEM，请配置S3存储桶和SIEM以使用日志。</p><hr class="wp-block-separator"/><h2 class="has-text-align-center">锁定您的云安全技能</h2><p class="has-text-align-center">学得更快。动作快点。<a href="https://acloudguru.com/pricing">从ACG开始</a>通过AWS、Microsoft Azure、Google Cloud等领域的课程和实际动手实验室改变你的职业生涯。</p><hr class="wp-block-separator"/><h3><strong> 6。打开安全控制</strong></h3><p>打开那些对齐的原生工具，如果适用的话，比如守卫职责和督察。</p><p>保持警惕总是好的，但是如果您正在运行EC2实例，并且您没有强大的漏洞管理程序，您可能希望打开Inspector来查找缺失的补丁和类似的东西。</p><h3><strong> 7。如果没有数据流图和网络图，则构建它们</strong></h3><p>我们想要所有东西的数据流图。如果你不知道一个开发者是如何使用系统的，你就不知道你能做什么。这可以帮助做出决定，如阻止S3公共访问。</p><h3><strong> 8。挑一个标准</strong></h3><p>安全不应该是你一路走来编造出来的。你不应该进入一个问题，只是决定实施一个规则。作为审核和保护您的AWS帐户的工作的一部分，您需要路标。这就是标准的作用。</p><p>唐推荐NIST CSF/800-53、CIS或CCM。但是请记住:这些不应该是规则。你应该利用它们来为你的决策提供信息。</p><h3><strong> 9。建立风险登记簿以跟踪调查结果</strong></h3><p>风险本身必须被跟踪，就像资产一样。我们不想玩打地鼠。建立风险登记册可以确保我们不是在救火，而是在防火。</p><p>风险登记簿可以像电子表格一样简单，至少应跟踪以下内容:</p><figure class="wp-block-table"><table><tbody><tr><td>身份证明</td><td>调查结果的专用标识符</td></tr><tr><td>优先</td><td>临界指示器</td></tr><tr><td>描述</td><td>风险有多大？</td></tr><tr><td>可能性</td><td>这种情况发生概率</td></tr><tr><td>影响</td><td>事件的后果</td></tr><tr><td>响应类型</td><td>接受、转移、减轻、避免</td></tr><tr><td>响应描述</td><td>可以做些什么来解决或减轻风险？</td></tr><tr><td>物主</td><td>谁负责？</td></tr><tr><td>状态</td><td>此风险的当前状态</td></tr></tbody></table></figure><p>风险登记册应该推动补救问题和故事。</p><h2><strong>如何保护AWS账户的安全</strong></h2><p>接下来，让我们以类似于Don在Stedi的方法来应用这些概念。</p><ul><li>将基础架构用作所有部署的代码</li><li>打开默认EBS加密</li><li>在帐户级别启用S3公共访问阻止</li><li>EC2实例需要IMDSv2</li><li>使用AWS组织</li><li>利用服务控制策略<ul><li>执行“禁止”和“禁止”的规定</li><li>保护关键资产</li><li>保持光线</li></ul></li><li>对IAM用户使用AWS SSO</li><li>使用基于工作的角色</li><li>关键帐户访问警报</li></ul><p>这是上面提到的一些事情以及如何在CloudFormation中实现它们的一个例子:</p><pre class="wp-block-code"><code>S3AccountPublicAccessBlock:
    Type: "Community::S3::PublicAccessBlock"
       Properties:
      BlockPublicAcls: true
      BlockPublicPolicy: true
      IgnorePublicAcls: true
      RestrictPublicBuckets: true
  EbsEncryptionDefaults:
    Type: "Community::Organizations::EbsEncryptionDefaults"
    Properties:
      EnableEbsEncryptionByDefault: true
IMDSv2LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
      Properties:
      LaunchTemplateName: IMDSV2
      LaunchTemplateData:
        MetadataOptions:
          HttpEndpoint: enabled
          HttpPutResponseHopLimit: 1
          HttpTokens: required</code></pre><h3>服务控制策略(SCP)</h3><p>服务控制策略(SCP)允许您对帐户应用限制性策略。这些可以在根级别或OU级别应用。根帐户不受scp的影响</p><h4>推荐的最低scp:</h4><ul><li>拒绝根用户访问</li><li>要求使用IMDSv2</li><li>拒绝创建IAM访问密钥的能力</li><li>拒绝离开组织的能力</li><li>拒绝扰乱守卫职责或阻止守卫职责失效能力</li><li>拒绝禁用S3公共访问阻止的能力</li><li>拒绝禁用EBS默认加密的能力</li><li>拒绝禁用AWS配置的能力</li></ul><h4>Optional SCPs:</h4><ul><li>禁用未使用的区域</li><li>需要资源上的标签</li><li>防止删除数据库、S3存储桶或生产中的其他敏感项目</li></ul><h3>服务控制策略示例</h3><p>下面的SCP示例阻止root帐户执行几乎所有操作。Don建议将此应用于所有孩子帐户，并创建一个移除时触发的警报。</p><pre class="wp-block-code"><code>DenyRootUserSCP:
    Type: OC::ORG::ServiceControlPolicy
    Properties:
      PolicyName: DenyRootUser
      Description: Deny using the root account
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: DenyRootUser
            Effect: Deny
            Action: "*"
            Resource: "*"
            Condition:
              StringLike:
                "aws:PrincipalArn": "arn:aws:iam::*:root"</code></pre><p>在https://asecure.cloud/p/scp_package/可以找到一个很棒的scp列表</p><h2>提高AWS环境的安全性</h2><p>除了以上关于如何审计和保护AWS账户的步骤之外，一个组织可以做的最大的事情之一就是<a href="https://acloudguru.com/blog/business/how-to-shift-aws-security-left-10-ways-to-empower-your-developers" target="_blank" rel="noreferrer noopener">通过授权给开发人员</a>来转移安全性。你可以在这里阅读更多关于T2的信息。</p><p>想了解有关保护您的云环境的更多信息吗？</p><p>ACG为您提供了保护<a href="https://acloudguru.com/blog/engineering/what-is-amazon-web-services-aws" target="_blank" rel="noreferrer noopener"> AWS </a>、<a href="https://acloudguru.com/blog/engineering/what-is-microsoft-azure" target="_blank" rel="noreferrer noopener"> Azure </a>和<a href="https://acloudguru.com/blog/engineering/what-is-google-cloud-platform-gcp" target="_blank" rel="noreferrer noopener"> GCP </a>环境所需的基本要素。查看我们的<a href="https://acloudguru.com/course/mastering-the-aws-well-architected-framework" target="_blank" rel="noreferrer noopener">掌握AWS良好架构的框架</a>课程。</p><p>或者，在八月份，查看以下免费课程，这些课程都是<a href="https://acloudguru.com/blog/news/whats-free-at-acg" target="_blank" rel="noreferrer noopener"> ACG免费课程</a>的一部分:</p><p>寻找更深入的安全培训？查看ACG的<a href="https://acloudguru.com/learning-paths/aws-security'" target="_blank" rel="noreferrer noopener"> AWS安全学习路径</a>并提升你的技能，无论你是完全的新手还是安全专家。</p><hr class="wp-block-separator"/><figure class="wp-block-image"><img loading="lazy" src="../Images/f0d20211f44c56a8f4211964b4a574aa.png" alt="Forrest Brazeal AWS Serverless Hero, Sr. Manager at A Cloud Guru and Mark Nunnikhoven VP, Cloud Research at Trend Micro" class="wp-image-38579" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_960/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/08/GammaResourcesWebinar_Security.jpg 960w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/08/GammaResourcesWebinar_Security.jpg 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/08/GammaResourcesWebinar_Security.jpg 768w" sizes="(max-width: 960px) 100vw, 960px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/08/GammaResourcesWebinar_Security.jpg"/></figure><p class="has-text-align-center"><strong> <a href="https://go.acloudguru.com/Leaders-Cloud-Security-Webinar?ajs_aid=8b2cc73f-c0e0-442b-ba6d-0eb362250ebb">看点:领导需要了解哪些关于云安全的知识</a> </strong> <br/>你的业务在云端安全吗？答案很大程度上取决于你。观看Mark Nunnikhoven的<a href="https://go.acloudguru.com/Leaders-Cloud-Security-Webinar">免费点播网络研讨会</a>，他将解决云安全的关键问题。</p></div></div>    
</body>
</html>