<html>
<head>
<title>8 steps to building your own serverless GraphQL API using AWS Amplify | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用AWS Amplify |云专家构建自己的无服务器GraphQL API的8个步骤</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/8-steps-to-building-your-own-serverless-graphql-api-using-aws-amplify#0001-01-01">https://acloudguru.com/blog/engineering/8-steps-to-building-your-own-serverless-graphql-api-using-aws-amplify#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><h2 id="h-"/><p id="4e1d">随着新的<a href="https://acloudguru.com/blog/engineering/create-a-serverless-python-api-with-aws-amplify-and-flask"> AWS Amplify </a> CLI的发布，开发人员现在能够从命令行移植<a href="https://acloudguru.com/course/introduction-to-aws-appsync">AWS app sync</a>graph QL API。</p><p id="deba">在这篇文章中，我们将学习如何使用CLI创建AWS AppSync API，以及如何将您的新API连接到客户端web或移动应用程序。</p><p id="2e09">CLI可以自动创建一个全功能的GraphQL API，包括数据源、解析器和用于变异、订阅和查询的附加模式。我们还可以直接从本地环境中更新和删除API中的模式、数据源和解析器。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/902d21faf325da7ab6008a05e24ff715.png" alt="" class="wp-image-41719" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_Uxinsykys6_R_o-GDq2SaQ.jpeg"/></figure><h3 id="94ba">放大GraphQL变换</h3><p id="1615">我们还能够在本地环境中直接从CLI使用<a href="https://github.com/aws-amplify/amplify-cli/blob/master/graphql-transform-tutorial.md#graphql-transformer-tutorial" target="_blank" rel="noreferrer noopener"> Amplify GraphQL Transform </a>库添加强大的功能，如弹性搜索、用户授权和数据关系。</p><p id="c55a">Amplify GraphQL Transform是一个库，用于简化开发、部署和维护GraphQL APIs的过程。通过它，您可以使用GraphQL模式定义语言(SDL)定义您的API，然后将它传递到库中，在那里它被转换并在AWS AppSync中实现您的API的数据模型。</p><blockquote class="wp-block-quote"><p>虽然该库附带了transformers来完成构建典型API所需的大部分工作，但是您甚至可以<a href="https://github.com/aws-amplify/amplify-cli/blob/master/how-to-write-a-transformer.md" target="_blank" rel="noreferrer noopener">编写自己的GraphQL Transformer </a>。</p></blockquote><p id="e893">例如，如果我们想要构建一个GraphQL API，创建一个数据源、解析器、模式，然后将所有数据流式传输到Elasticsearch，我们可以创建以下类型，并使用AWS Amplify CLI将它推上来:</p><pre class="wp-block-code"><code>type Pet @model @searchable {
  id: ID!
  name: String!
  description: String
}</code></pre><p id="f98b">在上面的模式中，注释<code>@model</code> &amp; <code>@searchable</code>将为我们自动创建数据源&amp;所有的资源。</p><p id="3ce9">还有一个<code>@connection</code>注释，允许您指定<code>@model</code>对象类型&amp;之间的关系；一个<code>@auth</code>注释，允许您指定GraphQL API中的授权模式。</p><p id="3dcc">让我们看看如何使用Amplify CLI和Amplify GraphQL转换库创建一个新的AWS Appsync API，并将其连接到客户端React应用程序。</p><h3 id="9c1e">1.安装和配置CLI</h3><p id="724f">首先，我们将安装AWS Amplify CLI:</p><pre class="wp-block-code"><code>npm i -g @aws-amplify/cli</code></pre><p>安装了AWS Amplify CLI后，我们现在需要使用IAM用户对其进行配置:</p><pre class="wp-block-code"><code>amplify configure</code></pre><blockquote class="wp-block-quote"><p>有关如何配置AWS Amplify CLI的视频演示，请单击此处的<a href="https://www.youtube.com/watch?v=fWbM5DLh25U"/>。</p></blockquote><h3 id="16dc">2.将API连接到客户端应用程序</h3><p id="00d6">接下来，我们将创建一个新的React应用程序，并进入新目录:</p><pre class="wp-block-code"><code>npx create-react-app blog-app
cd blog-app</code></pre><p>现在我们需要安装AWS Amplify客户端库:</p><pre class="wp-block-code"><code>yarn add aws-amplify aws-amplify-react
# or
npm install --save aws-amplify aws-amplify-react</code></pre><h3 id="3042">3.初始化AWS Amplify项目</h3><p id="c4b0">从根目录或新创建的React应用程序中，让我们初始化一个新的AWS Amplify项目:</p><pre class="wp-block-code"><code>amplify init</code></pre><blockquote class="wp-block-quote"><p>当询问您是否想要使用AWS概要文件时，选择Yes，使用我们在前面配置项目时创建的概要文件。</p></blockquote><p id="65c2">一旦项目被初始化，我们将把GraphQL API特性添加到我们的Amplify项目:</p><pre class="wp-block-code"><code>amplify add api</code></pre><p id="382d">这将引导我们完成创建AWS AppSync GraphQL API的以下步骤:</p><ul><li><span class="has-inline-color has-dark-gray-color">请从下列服务中选择一项:<strong>graph QL</strong>T3】</span></li><li><span class="has-inline-color has-dark-gray-color">提供API名称:<strong>blogapp</strong>T3】</span></li><li><span class="has-inline-color has-dark-gray-color">选择API的授权类型:<strong>API _ KEY</strong>T3】</span></li><li>你有带注释的GraphQL模式吗？:<strong>N</strong>T3】</li><li>您想要一个引导式模式创建吗？<strong>Y</strong>T3】</li><li><span class="has-inline-color has-dark-gray-color">什么最能描述你的项目:<strong>一对多关系(例如，“博客”与“帖子”和“评论”)</strong> </span></li><li><span class="has-inline-color has-dark-gray-color">您想现在编辑模式吗？<strong>Y</strong>T3】</span></li></ul><p id="b7c8">这将在您选择的编辑器中打开一个预先填充的模式，并为您提供所创建的新模式的本地文件路径。</p><p id="3e9b">让我们来看看这个模式。我们还将通过向<code>Post</code>类型添加<code>content</code>字段来做一个小小的更新。更新模式后，继续保存文件:</p><pre class="wp-block-code"><code>type Blog @model {
  id: ID!
  name: String!
  posts: [Post] @connection(name: "BlogPosts")
}
type Post @model {
  id: ID!
  title: String!
  content: String!
  blog: Blog @connection(name: "BlogPosts")
  comments: [Comment] @connection(name: "PostComments")
}
type Comment @model {
  id: ID!
  content: String
  post: Post @connection(name: "PostComments")
}</code></pre><p id="9c76">在上面的模式中，我们看到<code>Post</code> &amp; <code>Blog</code>类型有<code>@model </code>注释。用<code>@model </code>标注的对象类型是生成的API中的顶级实体。当被推动时，它们将创建DynamoDB表以及附加的Schema &amp;解析器，以将所有内容连接在一起。</p><blockquote class="wp-block-quote"><p>要了解更多关于@model注释的信息，请点击<a href="https://github.com/aws-amplify/amplify-cli/blob/master/graphql-transform-tutorial.md#model" target="_blank" rel="noreferrer noopener">此处</a>。</p></blockquote><p id="59fe">我们还看到了在类型中使用的<code>@connection</code>注释。<code>@connection </code>注释使您能够指定<code>@model</code>对象类型之间的关系。目前，<code>@connection</code>支持一对一、一对多、多对一的关系。如果您尝试配置多对多关系，则会引发错误。</p><blockquote class="wp-block-quote"><p>要了解更多关于<code>@connection</code>型的信息，点击<a href="https://github.com/aws-amplify/amplify-cli/blob/master/graphql-transform-tutorial.md#connection" target="_blank" rel="noreferrer noopener">这里</a>。</p></blockquote><p id="a0db">模式准备就绪后，我们现在可以推动一切来执行资源的创建:</p><pre class="wp-block-code"><code>amplify push</code></pre><p id="fbf2">一旦创建了资源，我们就可以创建应用程序了&amp;开始与API交互。</p><p id="759c">我们现在还可以通过点击新的API名称在<a href="https://console.aws.amazon.com/appsync/home" target="_blank" rel="noreferrer noopener"> AWS AppSync仪表板</a>中查看API。</p><p id="7e66">从<a href="https://console.aws.amazon.com/appsync/home" target="_blank" rel="noreferrer noopener"> AWS AppSync仪表板</a>中，我们也可以通过点击左侧菜单中的<strong>查询</strong>来开始执行查询&amp;突变:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/d31e67d8730420fd1b90a72839b0125f.png" alt="" class="wp-image-41718" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_QQ22ZPvUvWWD_lBw4n56_A.png"/></figure><p id="263a">让我们试着创建一个包含帖子和评论的新博客，然后查询博客数据。</p><p id="a4b5">在<a href="https://console.aws.amazon.com/appsync/home" target="_blank" rel="noreferrer noopener"> AWS AppSync仪表盘</a>中，点击<strong>查询</strong>。</p><p id="1153">首先，我们将创建一个新的博客:</p><pre class="wp-block-code"><code>mutation createBlog {
  createBlog(input: {
    name: "My Programming Blog"
  }) {
    id
    name
  }
}</code></pre><p>接下来，我们将在这个博客中创建一个新帖子(用从上面的变异中返回的id替换<code>postBlogId</code>):</p><pre class="wp-block-code"><code>mutation createPost {
  createPost(input: {
    title: "Hello World from my programming blog"
    content: "Welcome to my blog!"
    postBlogId: "bcb298e6-62ec-4614-9ab7-773fd811948e"
  }) {
    id
    title
  }
}</code></pre><p>现在，让我们为这篇文章创建一个评论(用上述变异返回的ID替换<code>commentPostId</code>):</p><pre class="wp-block-code"><code>mutation createComment {
  createComment(input: {
    content: "This post is terrible"
    commentPostId: "ce335dce-2c91-4fed-a953-9ca132f129cf"
  }) {
    id
  }
}</code></pre><p>最后，我们可以查询博客以查看所有文章和评论(用你博客的<strong> id </strong>替换<strong> ID </strong>):</p><pre class="wp-block-code"><code>query getBlog {
  getBlog(id: "bcb298e6-62ec-4614-9ab7-773fd811948e") {
    name
    posts {
      items {
        comments {
          items {
            content
          }
        }
        title
        id
        content
        blog {
          name
        }
      }
    }
  }
}</code></pre><h3 id="7ccd">4.从React连接到API</h3><p id="a48a">为了连接到新的API，我们首先需要用我们的Amplify项目凭证来配置React项目。您会注意到src目录中有一个名为<code>aws-exports.js</code>的新文件。这个文件包含了我们的本地项目需要了解的关于我们的云资源的所有信息。</p><p id="40e0">要配置项目，打开<code>src/index.js</code> &amp;在最后一次导入下面添加以下内容:</p><pre class="wp-block-code"><code>import Amplify from '@aws-amplify/core'
import config from './aws-exports'
Amplify.configure(config)</code></pre><p id="0b47">现在，我们可以开始对API执行变异、查询和搜索。</p><p id="18fd">我们将要执行的GraphQL变异的定义如下所示:</p><pre class="wp-block-code"><code>// Create a new blog
const CreateBlog = `mutation($name: String!) {
  createBlog(input: {
    name: $name
  }) {
    id
  }
}`
// Create a post and associate it with the blog via the "postBlogId" input field
const CreatePost = `mutation($blogId:ID!, $title: String!, $content: String!) {
  createPost(input:{
    title: $title, postBlogId: $blogId, content: $content
  }) {
    id
  }
}`
// Create a comment and associate it with the post via the "commentPostId" input field
const CommentOnPost = `mutation($commentPostId: ID!, $content: String) {
  createComment(input:{
    commentPostId: $commentPostId, content: $content
  }) {
    id
  }
}`</code></pre><p>我们将执行的GraphQL查询的定义如下所示:</p><pre class="wp-block-code"><code>// Get a blog, its posts, and its posts comments
const GetBlog = `query($blogId:ID!) {
  getBlog(id:$blogId) {
    id
    name
    posts {
      items {
        id
        title
        content
        comments {
          items {
            id
            content
          }
        }
      }
    }
  }
}`</code></pre><h3 id="1446">5.配置客户端应用程序</h3><p id="79a3">首先要做的是用您的web应用程序配置Amplify。在您的应用程序的根目录下(在React中这将是<code>src/index.js</code>)，在最后一次导入的下面，添加以下代码:</p><pre class="wp-block-code"><code>import Amplify from 'aws-amplify'
import config from './aws-exports'
Amplify.configure(config)</code></pre><p id="fe78">现在，我们可以开始对API执行操作了。</p><h3 id="356c">6.从客户端执行突变</h3><p id="55e4">创建新博客:</p><pre class="wp-block-code"><code>// import the API &amp; graphqlOperation helpers as well as the mutation
import { API, graphqlOperation } from 'aws-amplify'
import { CreateBlog } from './your-graphql-definition-location'
// next, we create a function to interact with the API
state = { blogName: '' }
createBlog = async () =&gt; {
  const blog = { name: this.state.blogName }
  await API.graphql(graphqlOperation(CreateBlog, blog))
  console.log('blog successfully created')
}</code></pre><p>为博客创建帖子:</p><pre class="wp-block-code"><code>// import the API &amp; graphqlOperation helpers as well as the mutation
import { API, graphqlOperation } from 'aws-amplify'
import { CreatePost } from './your-graphql-definition-location'
// next, we create a function to interact with the API
state = { postTitle: '' , postContent: '' }
createBlog = async () =&gt; {
  const post = {
    title: this.state.postTitle,
    content: this.state.postContent,
    postBlogId: this.props.blogId // Or where your blogId data lives
  }
  await API.graphql(graphqlOperation(CreatePost, post))
  console.log('post successfully created')
}</code></pre><p>对帖子发表评论:</p><pre class="wp-block-code"><code>// import the API &amp; graphqlOperation helpers as well as the mutation
import { API, graphqlOperation } from 'aws-amplify'
import { CommentOnPost } from './your-graphql-definition-location'
// next, we create a function to interact with the API
state = { content: '' }
createBlog = async () =&gt; {
  const comment = {
    content: this.state.content,
    commentPostId: this.props.commentPostId // Or where your commentPostId data lives
  }
  await API.graphql(graphqlOperation(CommentOnPost, comment))
  console.log('comment successfully created')
}</code></pre><h3 id="9545">7.从客户端执行查询</h3><p id="6caa">列出包含帖子和帖子评论的博客:</p><pre class="wp-block-code"><code>// import the API &amp; graphqlOperation helpers as well as the query
import { API, graphqlOperation } from 'aws-amplify'
import { GetBlog } from './your-graphql-definition-location'
// next, we create a function to interact with the API
getBlog = async () =&gt; {
  const data = await API.graphql(graphqlOperation(GetBlog, { id: this.props.blogId }))
  console.log('blog successfully fetched', data)
}</code></pre><h3 id="aa77">8.修改s <strong>方案</strong></h3><p id="4acd">如果您想随时修改模式以添加、更新或删除任何内容，您可以打开模式所在的文件，进行编辑，然后运行<code>amplify push</code>来更新您的AWS AppSync API。</p><hr class="wp-block-separator"/><h2 id="671f">视频漫游</h2><p id="1dc9">在本视频演练中，我们使用Amplify CLI创建一个AWS AppSync GraphQL API，并将其连接到React应用程序。</p><figure class="wp-block-embed is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio"><p class="wp-block-embed__wrapper"> </p></figure><p/><hr class="wp-block-separator is-style-dots"/><p id="b9fd">如果您有兴趣了解更多关于使用AWS AppSync构建GraphQL APIs的信息，请关注<a href="https://medium.com/u/f3a20aa7b323?source=post_page-----42c21770424d--------------------------------" target="_blank" rel="noreferrer noopener">阿德里安·霍尔</a> &amp;查看他的帖子<a href="https://medium.com/open-graphql/build-a-graphql-service-the-easy-way-with-aws-amplify-model-transforms-b3929b4f24c3" target="_blank" rel="noreferrer noopener">使用AWS Amplify Model Transforms以简单的方式构建GraphQL服务</a>。</p><p id="73ea">要了解更多关于AWS Amplify的信息，请查看文档或<a href="https://github.com/aws-amplify/amplify-cli" target="_blank" rel="noreferrer noopener"> Github </a>。</p><p id="3e8a"><em>我的名字是</em> <a href="https://twitter.com/dabit3" target="_blank" rel="noreferrer noopener"> <em>纳德达比特</em> </a> <em>。我是一名开发者，在AWS Mobile从事类似项目的工作，比如:AWS AppSync、AWS、AWS Amplify、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、AWS、</em></p></div></div>    
</body>
</html>