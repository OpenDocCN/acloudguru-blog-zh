<html>
<head>
<title>Exploring SELinux: Context | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>探索SELinux:环境|云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/exploring-selinux-context#0001-01-01">https://acloudguru.com/blog/engineering/exploring-selinux-context#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>SELinux的一个关键部分是理解和使用SELinux <em>上下文</em>。系统中的一切都包含一个上下文，这些上下文用于确定哪些用户、应用程序和服务可以访问哪些文件、目录和应用程序。即使不了解详细的策略创建，大多数SELinux用户也可以通过使用和改变上下文来管理他们的系统。SELinux中有三种类型的上下文，通过查看SELinux对文件的权限可以很好地解释这三种上下文。要查看一个目录的SELinux上下文，请使用带有<code>-Z</code>标志的<code>ls</code>命令。这是为<code>/var/www/</code>准备的目录:</p><pre><code>[vagrant@centos www]$ ls -Zdrwxr-xr-x. root root system_u:object_r:httpd_sys_script_exec_t:s0 cgi-bindrwxr-xr-x. root root system_u:object_r:httpd_sys_content_t:s0 html</code></pre><p>我们想从权限输出中看到的是类似于<code>system_u:object_r:httpd_sys_script_exec_t</code>的部分。这是文件的三个上下文。让我们深入了解一下:</p><h3><a target="_blank" rel="attachment noopener noreferrer" href="https://blog.linuxacademy.com/blog/wp-content/uploads/2016/11/selinuxcontext.png"> <img loading="lazy" class="aligncenter size-large wp-image-7460" src="../Images/e80bd79574f0135452c53fdc0ce32f67.png" alt="SELinux contexts" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/06/selinuxcontext-1024x92.png"/> </a>用户上下文</h3><p>第一个蓝色部分是<em>用户上下文</em>。这有三个可用值:<code>user_u</code>、<code>system_u</code>和<code>root</code>。其中每一个都表示哪种类型的用户可以访问该文件，而不是具体哪个用户。在用户上下文为<code>user_u</code>的情况下，普通登录用户可以访问文件(关于普通文件权限)；值<code>system_u</code>表示系统用户——如上例所示；最后，<code>root</code>表示只有系统的root用户才能访问该文件。</p><h3 id="role-context">角色上下文</h3><p>角色上下文，在上面的例子中是洋红色的，主要用于流程和域。普通SELinux用户可能不需要担心这个上下文。对于文件和目录，这总是<code>object_u</code>。</p><h3 id="type-context">类型上下文</h3><p>紫色的类型上下文可以说是在设置SELinux权限和解决SELinux问题时最重要的上下文。类型上下文提供了与SELinux相关的细粒度控制。您的系统，即使只启用了缺省的SELinux并且没有做任何更改，也有许多类型上下文。使用<code>semanage fcontext -l</code>命令查看所有可用类型。当查看特定文件或服务的上下文时，您可能希望通过管道连接到<code>grep</code>。输出使用正则表达式来表示给定的上下文是否是递归的。例如，以下是CentOS 7安装中类型上下文为<code>httpd_sys_content_t</code>的所有目录:</p><pre><code>[vagrant@centos ~]$ sudo semanage fcontext -l | grep "httpd_sys_content"/srv/([^/]*/)?www(/.*)?                            all files          system_u:object_r:httpd_sys_content_t:s0/var/www(/.*)?                                     all files          system_u:object_r:httpd_sys_content_t:s0/etc/htdig(/.*)?                                   all files          system_u:object_r:httpd_sys_content_t:s0/srv/gallery2(/.*)?                                all files          system_u:object_r:httpd_sys_content_t:s0/var/lib/trac(/.*)?                                all files          system_u:object_r:httpd_sys_content_t:s0/var/lib/htdig(/.*)?                               all files          system_u:object_r:httpd_sys_content_t:s0/var/www/icons(/.*)?                               all files          system_u:object_r:httpd_sys_content_t:s0/usr/share/glpi(/.*)?                              all files          system_u:object_r:httpd_sys_content_t:s0/usr/share/htdig(/.*)?                             all files          system_u:object_r:httpd_sys_content_t:s0/usr/share/drupal.*                                all files          system_u:object_r:httpd_sys_content_t:s0/usr/share/z-push(/.*)?                            all files          system_u:object_r:httpd_sys_content_t:s0/var/www/svn/conf(/.*)?                            all files          system_u:object_r:httpd_sys_content_t:s0/usr/share/icecast(/.*)?                           all files          system_u:object_r:httpd_sys_content_t:s0/var/lib/cacti/rra(/.*)?                           all files          system_u:object_r:httpd_sys_content_t:s0/usr/share/ntop/html(/.*)?                         all files          system_u:object_r:httpd_sys_content_t:s0/usr/share/doc/ghc/html(/.*)?                      all files          system_u:object_r:httpd_sys_content_t:s0/usr/share/openca/htdocs(/.*)?                     all files          system_u:object_r:httpd_sys_content_t:s0/usr/share/selinux-policy[^/]*/html(/.*)?          all files          system_u:object_r:httpd_sys_content_t:s0</code></pre><h2 id="altering-context">改变上下文</h2><p>如果我们愿意，我们可以改变某些目录的上下文。这可能是因为我们需要更改权限，或者因为我们在不同位置之间移动了一个文件——虽然在一个文件夹内创建的所有文件<em>都继承了上下文，但移动的文件保留了它们的原始上下文。假设我们将新的<em>index.html</em>文件移动到我们的<code>/var/www/html</code>目录中:</em></p><pre><code>[vagrant@centos ~]$ sudo mv index.html /var/www/html/[vagrant@centos ~]$ cd /var/www/html/[vagrant@centos html]$ ls -Z-rw-rw-r--. vagrant vagrant unconfined_u:object_r:user_home_t:s0 index.html</code></pre><p>这个例子特别合适，因为我们可以在实践中看到SELinux的效果。如果我们试图通过网络浏览器查看我们的<em>index.html</em>文件，我们会收到一个<em>禁止</em>错误。这是因为，如上所示，它保留了它原来的<code>user_home_t</code>类型，而不是它需要的<code>httpd_sys_content_t</code>上下文。这可以用<code>restorecon</code>命令改变:</p><pre><code>[vagrant@centos html]$ restorecon index.html[vagrant@centos html]$ ls -Z-rw-rw-r--. vagrant vagrant unconfined_u:object_r:httpd_sys_content_t:s0 index.html</code></pre><p>使用SELinux的默认上下文来确保所有文件都是适当的类型。在这种情况下，它看到index.html的<em>是<code>/var/www(/.*)?</code>目录的一部分，并确保它继承了适当的上下文。或者，假设我们移动了整个<code>html/</code>目录，并需要改变SELinux上下文。假设，不管出于什么原因，我们的服务器没有Apache必需的缺省SELinux策略。为此，我们可以使用<code>semanage</code>来改变类型上下文:</em></p><pre><code>semanage fcontext -a -t httpd_sys_content_t '/var/www/html(/.*)?'</code></pre><p><code>-t</code>标志表示类型。另外，注意包含了<code>(/.*)?</code>——这告诉SELinux在<code>/var/www/html</code>目录下的文件和目录也继承了这种风格。如果需要，我们还可以删除目录的上下文:</p><pre><code>semanage fcontext -d "/var/www/html(/.*)?"</code></pre><p>即使通过管理SELinux上下文和权限，我们也只是触及了这个深入工具的表面。回来看看博客，了解更多关于SELinux的内容，或者去LinuxAcademy.com的T2了解更多关于SELinux和其他系统管理和安全主题的课程。</p></div></div>    
</body>
</html>