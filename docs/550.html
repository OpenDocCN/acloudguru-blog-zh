<html>
<head>
<title>Serverless browser automation with AWS Lambda and Puppeteer | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>借助AWS Lambda和Puppeteer实现无服务器浏览器自动化|云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/serverless-browser-automation-with-aws-lambda-and-puppeteer#0001-01-01">https://acloudguru.com/blog/engineering/serverless-browser-automation-with-aws-lambda-and-puppeteer#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>使用API操作web浏览器环境为开发人员提供了广泛的自动化功能。它允许你生成PDF文件，截屏网页，或在网站上运行健康检查，所有这些都来自代码。它还可以让您自动提交表单、构建UI测试或诊断性能问题。无头Chromium是一个流行的以编程方式操作浏览器的包。无论您是对网站进行负载测试还是定期获取内容，都可以用最少的代码进行配置。</p><p>您可以在本地开发机器或远程服务器上运行无头浏览器。然而，许多典型的浏览器自动化任务非常适合AWS Lambda。您可以将Lambda函数配置为按计划启动，或者响应某个事件。您还可以配置Lambda来扩展负载测试操作，使其成为管理大量实例的一种经济有效的替代方法。</p><p>在这篇博文中，我展示了如何将浏览器自动化任务部署到Lambda。这个例子使用了<a href="https://aws.amazon.com/serverless/sam/" target="_blank" rel="noreferrer noopener"> AWS无服务器应用模型</a> (AWS SAM)来简化云资源的部署。你可以从配套的<a href="https://github.com/aws-samples/scheduled-website-screenshot-app" target="_blank" rel="noreferrer noopener"> GitHub库</a>下载这篇博文的代码。要部署到您的AWS帐户，请遵循<a href="https://github.com/aws-samples/scheduled-website-screenshot-app/blob/main/README.md" target="_blank" rel="noreferrer noopener">自述文件</a>中的说明。</p><hr class="wp-block-separator"/><h2 class="has-text-align-center" id="h-accelerate-your-career">加速您的职业发展</h2><p class="has-text-align-center"><a href="https://acloudguru.com/pricing">从ACG开始</a>通过AWS、Microsoft Azure、Google Cloud等领域的课程和实际动手实验室改变你的职业生涯。</p><hr class="wp-block-separator"/><h2 id="h-overview-how-to-deploy-a-browser-automation-task-to-aws-lambda">概述:如何将浏览器自动化任务部署到AWS Lambda</h2><p>在示例应用程序中，每隔15分钟就调用一次Lambda函数来获取网页的屏幕截图，并将图像保存到S3桶中。架构看起来是这样的:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/f031e1a85c6c9758e69621a2e772fad7.png" alt="" class="wp-image-45581" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_622/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image001.png 622w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image001.png 300w" sizes="(max-width: 622px) 100vw, 622px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image001.png"/></figure><ol><li>一个<a href="https://aws.amazon.com/eventbridge/" target="_blank" rel="noreferrer noopener"> Amazon EventBridge </a>规则使用一个<a href="https://docs.aws.amazon.com/eventbridge/latest/userguide/scheduled-events.html" target="_blank" rel="noreferrer noopener">调度表达式</a>调用Lambda函数。</li><li>Lambda函数使用Chromium来加载目标网页。一旦页面被加载并呈现，它就会截图。</li><li>截图被保存到一个<a href="https://aws.amazon.com/s3/">亚马逊S3 </a>桶中。</li></ol><h2 id="h-how-the-code-works">代码如何工作</h2><p>这个Node.js示例使用了一个名为<a href="https://github.com/puppeteer/puppeteer" target="_blank" rel="noreferrer noopener">puppeter</a>的npm包，它公开了一个高级API来控制Chromium浏览器。<a href="https://github.com/aws-samples/scheduled-website-screenshot-app/blob/main/src/app.js" target="_blank" rel="noreferrer noopener">λ函数</a>的一个片段展示了它是如何工作的:</p><div class="wp-container-640f2ad9bd71e wp-block-group"><div class="wp-block-group__inner-container"><div class="wp-container-640f2ad9bd520 wp-block-group"><div class="wp-block-group__inner-container"><pre class="wp-block-preformatted">browser = await chromium.puppeteer.launch({
     args: chromium.args,
     defaultViewport: chromium.defaultViewport,
     executablePath: await chromium.executablePath,
     headless: chromium.headless,
     ignoreHTTPSErrors: true,
});

let page = await browser.newPage()
await page.goto(pageURL)
const buffer = await page.screenshot()</pre></div></div></div></div><p>这使用JavaScript <a href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Async_await" target="_blank" rel="noreferrer noopener"> async/await </a>语法来避免回调并使用顺序代码流。一旦定义了browser对象，代码就会指示Chromium(通过Puppeteer)获取网页。在页面被加载并且<a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model/Introduction" target="_blank" rel="noreferrer noopener"> DOM </a>被呈现在headless Chromium实例中之后，它将页面的截图存储在一个缓冲变量中。最后，图像被写入S3桶:</p><pre class="wp-block-preformatted">const s3result = await s3
   .upload({
      Bucket: process.env.S3_BUCKET,
      Key: `${Date.now()}.png`,
      Body: buffer,
      ContentType: 'image/png',
      ACL: 'public-read'
    })
    .promise()

console.log('S3 image URL:', s3result.Location) </pre><p>这使用了JavaScript 的<a href="https://aws.amazon.com/sdk-for-javascript/" target="_blank" rel="noreferrer noopener"> AWS SDK中的</a><a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#upload-property" target="_blank" rel="noreferrer noopener"> S3上传方法</a>。它定义bucket和key，将内容类型设置为PNG，然后配置访问控制列表(ACL ),以便公开查看该对象。最后，它记录存储对象的公共URL。</p><h2 id="h-packaging-puppeteer-for-the-lambda-function">为Lambda函数打包木偶</h2><p>AWS Lambda允许您将依赖项和代码打包成一个zip文件。部署包最大可达<a href="https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html" target="_blank" rel="noreferrer noopener"> 250 MB(解压缩)</a>或50 MB(压缩，用于直接上传)。对于更大的包，建议您对Lambda函数使用<a href="https://acloudguru.com/blog/engineering/packaging-aws-lambda-functions-as-container-images">容器打包格式</a>，它允许包达到10 GB。</p><p>如果你使用像AWS SAM或<a href="https://www.serverless.com/" target="_blank" rel="noreferrer noopener">无服务器框架</a>这样的工具，包会在你的开发机器上创建，然后压缩并上传到Lambda服务。在运行时，当函数运行时，这些文件在Lambda执行环境中被解压缩。这些工具可以简化打包过程，并有助于简化您的部署。</p><p>但是，当您使用包含二进制文件的依赖项时，您必须确保您打包的二进制文件版本与Lambda使用的操作系统兼容。Puppeteer包包含一个捆绑到部署中的完整Chromium浏览器。由于浏览器依赖于二进制文件，npm会安装与本地开发机器的操作系统相匹配的二进制文件。但是，Lambda需要与其底层操作系统相匹配的二进制文件，也就是Amazon Linux 2。</p><p>为了帮助解决这个问题，许多流行的软件包已经被社区转换成了λ层。每个Lambda函数最多可以定义五层，当您创建或更新函数时，这些层会被复制到您的部署包中。对于Chromium，这使得在开发中运行一个二进制版本，在运行时使用另一个二进制版本变得更加容易。了解更多关于<a href="https://aws.amazon.com/blogs/compute/using-lambda-layers-to-simplify-your-development-process/" target="_blank" rel="noreferrer noopener">创建和使用Lambda层</a>来简化你的开发过程。</p><h2 id="h-using-a-community-maintained-lambda-layer">使用社区维护的Lambda层</h2><p>一名开发人员为AWS Lambda 打包了一个<a href="https://github.com/alixaxel/chrome-aws-lambda" target="_blank" rel="noreferrer noopener"> Chromium二进制文件，并将其发布到GitHub。您可以在Lambda函数中使用Puppeteer安装它，方法是将库包含在package.json中。您也可以将两者与现有的公共Lambda层捆绑在一起。</a><a href="https://github.com/shelfio/chrome-aws-lambda-layer" target="_blank" rel="noreferrer noopener">这个GitHub repo </a>经常发布新版本的<em> chrome-aws-lambda </em>包，你可以把它直接包含在你的lambda函数中。</p><p>图层仅在发布它们的AWS区域中可用。该公共回购的维护者已经将该层发布到16个地区，并在<a href="https://github.com/shelfio/chrome-aws-lambda-layer/blob/master/readme.md" target="_blank" rel="noreferrer noopener">自述文件</a>中提供了层ARNs。这些ARNs是公共的，你可以在任何AWS账户的这些区域中的任何Lambda函数中包含它们。</p><p>有许多流行的库被社区捆绑到Lambda层中。<a href="https://github.com/mthenw/awesome-layers" target="_blank" rel="noreferrer noopener">这个GitHub repo </a>聚集了常用工具的层，如GeoIP、MySQL、OpenSSL、Pandas、scikit-learn和许多其他工具。要在兼容运行时的Lambda函数中使用这些，只需在支持的区域中包含ARN图层。</p><h2 id="h-understanding-the-aws-sam-template">了解AWS SAM模板</h2><p>本例中的Lambda函数可以直接在AWS管理控制台中定义。然而，通过使用AWS SAM，您可以定义与代码相同的基础结构。这有助于快速创建可重复的部署，并减少因点击控制台而导致的人为错误。</p><p><a href="https://github.com/aws-samples/scheduled-website-screenshot-app/blob/main/template.yaml" target="_blank" rel="noreferrer noopener"> AWS SAM模板</a>定义了应用程序使用的所有AW资源。首先，它声明了一个S3桶:</p><pre class="wp-block-preformatted">  S3Bucket:
    Type: AWS::S3::Bucket  </pre><p>接下来，模板定义了Lambda函数以及在哪里可以找到代码。因为它在函数中运行整个浏览器，所以内存被设置为4096 MB。超时被配置为15秒，以确保如果目标网页没有响应，则该功能结束。</p><pre class="wp-block-preformatted">SnapshotFunction:
     Type: AWS::Serverless::Function
     Description: Invoked by EventBridge scheduled rule
     Properties:
       CodeUri: src/
       Handler: app.handler
       Runtime: nodejs12.x
       Timeout: 15
       MemorySize: 4096 </pre><p>该模板包含对公开可用的Chromium层的引用，并在部署时替换区域代码。假设示例部署在图层可用的16个区域之一，则图层ARN有效:</p><pre class="wp-block-preformatted">Layers:
  - !Sub 'arn:aws:lambda:${AWS::Region}:764866452798:layer:chrome-aws-lambda:22'</pre><p>环境变量用于设置目标网站URL并定义存储图像的桶名。最后，由于该函数只将数据写入S3，因此它使用AWS SAM <a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-policy-templates.html" target="_blank" rel="noreferrer noopener">策略模板</a>为单个存储桶提供写权限。这遵循了最小特权的<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege" target="_blank" rel="noreferrer noopener">原则:</a></p><pre class="wp-block-preformatted">Environment:
  Variables:
   TARGET_URL: 'https://serverlessland.com'
   S3_BUCKET: !Ref S3Bucket
 Policies:
   - S3WritePolicy:
       BucketName: !Ref S3Bucket </pre><p>Lambda函数在响应事件时被调用。在这种情况下，该函数按定时间隔运行，由EventBridge管理。模板使用计划表达式将函数配置为每15分钟运行一次:</p><pre class="wp-block-preformatted">Events:
  CheckWebsiteScheduledEvent:
    Type: Schedule
    Properties:
      Schedule: rate(15 minutes) </pre><p>每当您对Lambda函数或该模板中的资源进行更改时，请再次运行<em> sam deploy </em>以将新版本部署到AWS Cloud。AWS SAM CLI检测版本之间的差异，并自动部署新代码和资源。</p><h2 id="h-testing-the-function">测试功能</h2><p>部署示例应用程序后，导航到<a href="https://console.aws.amazon.com/lambda/home" target="_blank" rel="noreferrer noopener"> Lambda控制台</a>。打开AWS SAM部署的<em>快照功能</em>。该功能每15分钟自动调用一次，但是您可以通过选择<em>测试</em>来触发该功能:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/340a25d4290784d036093e14febaae08.png" alt="" class="wp-image-45582" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1008/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image002.png 1008w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image002.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_150/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image002.png 150w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image002.png 768w" sizes="(max-width: 1008px) 100vw, 1008px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image002.png"/></figure><p><em>日志输出</em>包含生成并存储在S3桶中的图像的函数持续时间和公共URL的细节。在浏览器中导航到此URL以查看屏幕截图:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/e02cbdec2952dca49dd4ec870281166a.png" alt="" class="wp-image-45583" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_874/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image004.png 874w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image004.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image004.png 768w" sizes="(max-width: 874px) 100vw, 874px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image004.png"/></figure><p>在部署该函数几个小时后，它被预定事件调用了多次。您可以使用<a href="https://aws.amazon.com/cloudwatch/" target="_blank" rel="noreferrer noopener"> Amazon CloudWatch </a>指标来监控它的性能。从Lambda函数中，选择<em> Monitoring </em>来查看调用次数、平均持续时间和任何错误:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/a4f1c5d08181c6db6ea2711a4ee3af18.png" alt="" class="wp-image-45584" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1122/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image006.png 1122w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image006.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image006.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image006.png 768w" sizes="(max-width: 1122px) 100vw, 1122px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image006.png"/></figure><p>从<a href="https://s3.console.aws.amazon.com/s3/buckets/" target="_blank" rel="noreferrer noopener"> S3控制台</a>，打开由AWS SAM部署创建的S3存储桶，查看由每个Lambda调用创建的带有日期戳的对象:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/2d5c3a321f479b3ba30bb132a471b9b1.png" alt="" class="wp-image-45585" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_985/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image008.png 985w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image008.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image008.png 768w" sizes="(max-width: 985px) 100vw, 985px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/02/image008.png"/></figure><h2 id="h-conclusion">结论</h2><p>以编程方式控制web浏览器使您能够用代码自动完成许多有用的任务。对于其中的许多问题，您可以使用AWS Lambda来最小化基础设施开销并简化伸缩。这篇博文展示了如何部署一个示例应用程序，该应用程序使用一个无头浏览器定期对网页进行截图。</p><p>对于带有特定于操作系统的二进制文件的常用库或包，Lambda层有助于简化部署。许多库都有公开维护的层，您可以将它们包含在Lambda函数中。有了AWS SAM这样的基础设施作为编码工具，您可以在YAML一起定义您的代码和层，以帮助创建可重复的部署并加速开发。</p><p>如需更多无服务器学习资源，请访问<a href="https://serverlessland.com" target="_blank" rel="noreferrer noopener">无服务器世界</a>并查看下面的无服务器对比。</p><figure class="wp-block-embed is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio"><p class="wp-block-embed__wrapper"> </p></figure><p/></div></div>    
</body>
</html>