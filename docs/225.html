<html>
<head>
<title>Building a Three-Node Kubernetes Cluster | Quick Guide | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>构建三节点Kubernetes集群|快速指南|云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/building-a-three-node-kubernetes-cluster-quick-guide#0001-01-01">https://acloudguru.com/blog/engineering/building-a-three-node-kubernetes-cluster-quick-guide#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>构建Kubernetes集群有很多方法。其中之一是使用一种叫做kubeadm的工具。<a href="https://acloudguru.com/hands-on-labs/building-a-kubernetes-cluster-with-kubeadm"> Kubeadm </a>是创建第一个Kubernetes集群时的官方工具。由于启动和运行起来很容易，我想我应该整理一下使用kubeadm安装Kubernetes集群的快速指南！如果你已经是Linux学院的学生，<a href="https://linuxacademy.com/login?utm_source" target="_blank" rel="nofollow noopener noreferrer">在这里登录</a>继续学习，或者你可以注册<a href="https://linuxacademy.com/pricing?utm_source" target="_blank" rel="nofollow noopener noreferrer">7天免费试用</a>开始学习。<strong>立即启动服务器</strong> Linux Academy云服务器是构建您的集群的最佳方式，因为如果您搞砸了，很容易删除服务器并在几分钟内重新创建它。因此，让我们去我们的Linux学院<a href="https://wpengine.linuxacademy.com/linux-academy/introducing-cloud-playground-even-more-hands-on-training-features/?utm_source" target="_blank" rel="nofollow noopener noreferrer">云操场</a>并启动一些服务器。从Linux academy导航栏中选择<strong>云服务器</strong>，然后选择<strong>游乐场</strong>。</p><div class="wp-block-image"><figure class="aligncenter"><a href="https://linuxacademy.com" rel="nofollow noopener noreferrer"><img loading="lazy" src="../Images/5aabbc372da60e79d4af108498912893.png" alt="linux-academy-cloud-playground" class="wp-image-24078" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/06/linuxacademy-home-open-playground-screenshot-1024x576.png"/></a><figcaption>Finding the Linux Academy Cloud Playground Servers</figcaption></figure></div><p>让我们启动三台服务器，都是相同的类型，使用Ubuntu 16.04 Xenial LTS发行版，中等大小。作为您的帐户访问的一部分，您总共有九个单元，因此创建三个中型服务器将足以达到该容量。三节点集群对于大多数实践集群来说已经足够，并且允许您创建所有想要的资源。我们将为服务器添加一个标签，这不会改变机器本身的任何内容，它只是一个帮助您组织云服务器的名称，以便您可以区分它们。特别是当您创建具有相同分布和大小的服务器时，这将有助于我们理解主服务器和工作节点之间的区别。让我们为其中一个输入“Kube Master”的名称，将另外两个称为“Kube Worker 0”和“Kube Worker 1”。以下是它们全部贴上标签后的样子:</p><div class="wp-block-image"><figure class="aligncenter"><a href="https://linuxacademy.com" rel="nofollow noopener noreferrer"><img loading="lazy" src="../Images/746de9f95d1a37d9960a3ecb0b611b0e.png" alt="cloud playground - linux academy" class="wp-image-12680" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/06/starting-up-linux-academy-cloud-playground-servers-1024x576.png"/></a><figcaption>Creating Linux Academy Cloud Playground Servers</figcaption></figure></div><p><strong>登录并开始构建</strong>一旦服务器显示“就绪”状态，让我们继续登录。单击服务器以展开并显示每台服务器的详细信息。点击临时密码旁边的页面图标，点击<strong>终端</strong>，在新的浏览器标签中打开终端。输入用户名并粘贴提供的临时密码。</p><div class="wp-block-image"><figure class="aligncenter"><a href="https://linuxacademy.com" rel="nofollow noopener noreferrer"><img loading="lazy" src="../Images/00290037a3d1d2b7df4e89ca1d09bc0a.png" alt="cloud playground - linux academy" class="wp-image-12679" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/06/log-in-logging-in-into-linux-academy-playground-servers-1024x576.png"/></a><figcaption>Log in to your Linux Academy Cloud Playground servers.</figcaption></figure></div><p>让我们同时登录三台服务器。这将使在每台服务器上执行命令变得更加容易，只需切换到下一个浏览器选项卡并粘贴命令即可。我们在每台服务器上要做的第一件事是为docker存储库添加gpg密钥。Docker是我们将要使用的容器运行时。</p><pre class="wp-block-code"><code>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</code></pre><p>现在，在所有三台服务器上，让我们将Docker添加到我们的存储库中。</p><pre class="wp-block-code"><code>sudo add-apt-repository    "deb [arch=amd64] https://download.docker.com/linux/ubuntu    $(lsb_release -cs)    stable"</code></pre><p>仍然应用于三个服务器中的每一个，为Kubernetes添加我们的gpg密钥，然后添加存储库。</p><pre class="wp-block-code"><code>curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -</code></pre><pre class="wp-block-code"><code>cat &lt;&lt; EOF | sudo tee /etc/apt/sources.list.d/kubernetes.listdeb https://apt.kubernetes.io/ kubernetes-xenial mainEOF</code></pre><p>现在我们已经锁定了我们的库，让我们更新我们的包。</p><pre class="wp-block-code"><code>sudo apt-get update</code></pre><p><strong>安装Docker、kubelet、kubeadm和kubectl </strong>现在，让我们在所有三台Linux Academy服务器上安装Docker、kubelet、kubeadm和kubectl。</p><pre class="wp-block-code"><code>sudo apt-get install -y docker-ce kubelet kubeadm kubectl</code></pre><pre class="wp-block-code"><code>sudo apt-mark hold docker-ce kubelet kubeadm kubectl</code></pre><p>kubelet是节点代理，它将为我们运行所有的舱，包括kube系统舱。kubeadm是用于部署多节点kubernetes集群的工具。kubectl是与Kubernetes交互的命令行工具。我们已经安装了特定的版本并标记为保留，这样Kubernetes和Docker就不会自动更新并变得不兼容。好了，现在我们已经安装了Docker、kubelet、kubeadm和kubectl，我们现在将只在主服务器上安装命令。以下命令将仅在主服务器<em>上完成</em>。让另外两个服务器终端保持打开状态，但是在我们最终将它们加入集群之前，我们不会使用它们。所以，继续前进，到达代表您的主服务器的终端。如果需要，请返回到“云游乐场”屏幕，检查您标记的是哪一个。专业提示:如果这是你创建的第一个服务器，它将以“1c”结尾。<strong>初始化集群</strong>让我们使用这个命令初始化集群，使用kubeadm(这可能需要几分钟)。</p><pre class="wp-block-code"><code>sudo kubeadm init --pod-network-cidr=10.244.0.0/16</code></pre><p>完成后，您会注意到它给出了一个输出，对于我们接下来需要做的步骤非常有帮助。因此，我们将按照这里的说明创建<code>.kube</code>目录，我们将复制kube配置，并更改配置的所有权。最后，我们将复制kubeadm join命令，并将其粘贴到worker节点的终端。</p><pre class="wp-block-code"><code>mkdir -p $HOME/.kube</code></pre><pre class="wp-block-code"><code>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</code></pre><pre class="wp-block-code"><code>sudo chown $(id -u):$(id -g) $HOME/.kube/config</code></pre><p>在我们将它粘贴到两个工人节点之前，让我们应用我们的法兰绒CNI。法兰绒是我们的网络覆盖层，所以我们的节点可以互相通信。</p><pre class="wp-block-code"><code>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</code></pre><p>一旦我们安装了法兰绒，我们就可以将kubeadm join命令(确保包含sudo)复制并粘贴到两个worker节点的终端中。</p><pre class="wp-block-code"><code>sudo kubeadm join [your unique string from the kubeadm init command]</code></pre><p>既然节点已经成功加入，让我们运行第一个<code>kubectl</code>命令来查看我们的集群节点状态。</p><pre class="wp-block-code"><code>kubectl get nodes</code></pre><p>我们已经成功设置了三节点集群，让我们开始探索集群。也许运行一些豆荚？这里有一些有趣的练习让你开始。<strong>运行busybox Pod</strong>busybox Pod是一个容器映像，允许您运行nslookup之类的实用程序来查找Kubernetes集群中的默认主机名。从1.13版开始，CoreDNS已经取代kube-dns成为默认的集群DNS服务器。它是用Go编写的，由于其灵活性，可以在多种环境中使用。CoreDNS通过Kubernetes插件与Kubernetes集成，或者通过etcd插件直接与etcd集成。核心DNS作为具有两个副本的部署运行。你可以通过运行<code>kubectl get deployments -n kube-system</code>看到这一点。kube-dns是作为服务运行的(没错，1.13版本还是叫kube-dns)。这样做是为了提高工作负载的互操作性，这些工作负载依赖传统的kube-dns服务名称来解析集群内部的地址。您可以通过在旧的kube-dns中运行<code>kubectl get svc -n kube-</code>看到这一点，在一个pod中使用了几个容器:kubedns、dnsmasq和sidecar。kubedns容器监视Kubernetes API并根据Kubernetes dns规范提供DNS记录，dnsmasq提供缓存和存根域支持，sidecar提供度量和健康检查。随着时间的推移，这种设置导致了一些问题。首先，dnsmasq中的安全漏洞在过去导致了对Kubernetes安全补丁发布的需求。此外，因为dnsmasq处理存根域，而kubedns处理外部服务，所以您不能在外部服务中使用存根域，这对功能有很大的限制。所有这些功能都是在CoreDNS的一个容器中完成的，这个容器正在运行一个用Go编写的进程。启用的不同插件复制(并增强)了kube-dns中的功能。这里有一个busybox pod用于dns查找，只需一个命令就可以运行。</p><pre class="wp-block-code"><code>kubectl run busybox --image=busybox:1.28.4 --generator=run-pod/v1 --command -- sleep 99999</code></pre><p>创建busybox pod后，运行以下命令:</p><pre class="wp-block-code"><code>kubectl exec busybox -- cat /etc/resolv.conf</code></pre><pre class="wp-block-code"><code>kubectl exec busybox -- nslookup kubernetes</code></pre><p>我希望你喜欢这个有趣的练习。如果你想跟进，请<a href="https://linuxacademy.com/login?utm_source" target="_blank" rel="nofollow noopener noreferrer">在这里登录</a>或者注册一个<a href="https://linuxacademy.com/pricing?utm_source" target="_blank" rel="nofollow noopener noreferrer">的7天免费试用</a>来开始。如果你想发现更多使用Kubernetes的方法，请查看我们所有伟大的<a href="https://linuxacademy.com/containers/courses?utm_source" target="_blank" rel="nofollow noopener noreferrer"> Kubernetes课程</a>，包括:</p><p>点击了解更多关于Kubernetes <a href="https://linuxacademy.com/blog/?s" target="_blank" rel="noopener noreferrer">的信息。</a></p></div></div>    
</body>
</html>