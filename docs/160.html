<html>
<head>
<title>How to add file upload features to your website with AWS Lambda and S3 | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何使用AWS Lambda和云专家S3为您的网站添加文件上传功能</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/how-to-add-file-upload-features-to-your-website-with-aws-lambda-and-s3#0001-01-01">https://acloudguru.com/blog/engineering/how-to-add-file-upload-features-to-your-website-with-aws-lambda-and-s3#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p id="h-file-uploading-presents-a-scalability-problem-that-s-easy-to-fix-with-serverless-without-taxing-your-pocketbook"><em>文件上传带来了一个可扩展性问题，使用无服务器很容易解决——而不会增加您的钱包负担</em>。</p><p id="be50">从浏览器上传文件的机制在互联网早期就已经存在了。在全服务器环境中，很容易使用Django、Express或任何其他流行的框架。这不是一个令人兴奋的话题——除非你经历了伸缩问题。</p><p id="8ba9">想象一下这个场景—您有一个上传文件的应用程序。一切都很好，直到网站突然流行起来。在纳税日之前的一个月，每小时的使用量增长到了100Gb，而不是每月处理1gb的上传量。之后，使用量会在下一年再次下降。这正是我们要解决的问题。</p><p id="1b3d">大规模的文件上传会吞噬你的资源——网络带宽、CPU、存储。所有这些数据都是通过您的web服务器获取的，然后您必须对其进行扩展——如果您幸运的话，这意味着AWS中的自动扩展，但是如果您不在云中，您还必须应对物理网络瓶颈问题。</p><p id="b39f">如果您的服务器在处理上传文件的过程中失败，您还可能面临一些困难的竞争条件。文件到达最终目的地了吗？处理的状态如何？当服务器过载时，很难重放失败的步骤或知道事务的状态。</p><p id="7665">幸运的是，这个特殊的问题被证明是无服务器的一个很好的用例——因为您可以完全消除伸缩性问题。对于需求不可预测的移动和web应用程序，您可以简单地允许应用程序将<a href="https://acloudguru.com/hands-on-labs/introduction-to-amazon-s3">文件直接上传到S3 </a>。这有一个额外的好处，即启用https端点进行上传，这对于在传输过程中保持文件内容的安全至关重要。</p><p id="35c5">所有这些听起来都很棒——但是当服务器不再做身份验证和中间的跑腿工作时，这在实践中如何工作呢？</p><h3 id="b895">S3上传程序演示应用程序</h3><p id="5de6">我在<a href="https://serverlessrepo.aws.amazon.com/applications/arn:aws:serverlessrepo:us-east-1:526237104669:applications~Serverless-S3-Uploader" target="_blank" rel="noreferrer noopener"> AWS无服务器应用程序库</a>中设置了一个应用程序，您可以将其部署到自己的AWS帐户中。尝试安装应用程序并在文档中部署Gist homepage，然后我们将介绍解决方案:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/10368b8e6e29eb595d871a1d9bc5f89f.png" alt="Setting up an app in the AWS Application Repository that you can deploy to your AWS account." class="wp-image-42051" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_vZq6X42lMjivHBo2EQRDhg.png"/></figure><p>幕后发生的是一个两步过程——首先，网页调用一个Lambda函数来请求上传URL，然后它将JPG文件直接上传到S3:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/ca0c82182fc8f73af180b37640f99670.png" alt="The behind the scenes two step process, first the web page calls a Lambda function to request the upload URL, and then it uploads the JPG file directly to S3." class="wp-image-42048" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_9I2IEa-9TUFG76EBiBpUpQ.png"/></figure><p id="3369">URL是该过程的关键部分，它在授权传输的查询参数中包含一个密钥、签名和令牌。没有这些，传输将会失败。</p><p id="c9b9"><em>随意克隆<a href="https://github.com/jbesw/askjames-s3uploader"> Github repo。</a>面向公众的演示应用程序会在24小时内删除所有文件，并启用节流功能以防止滥用，正如您所知。</em></p><h3 id="eb4f">为什么要使用Lambda函数？</h3><p id="7b1b">有可能<a href="https://docs.aws.amazon.com/AmazonS3/latest/API/sigv4-authentication-HTTPPOST.html" target="_blank" rel="noreferrer noopener">取消Lambda函数</a>并从客户端浏览器做所有事情——但是有许多好的理由来避免这种方法。除了向web页面添加更多的代码之外，Lambda函数还允许您控制这个过程，避开任何潜在攻击者的窥探。</p><p id="56bb">例如，如果您想先授权用户，也许只有付费用户可以上传，而免费试用版是只读的，该怎么办？或者您可能需要在流程中添加额外的挂钩来触发其他工作流、日志记录，或者在上传太多的情况下添加一个中断器。或者您可能不愿意在客户端代码中透露存储桶名称或其他信息。</p><p id="e5bd">请求签名URL的Lambda函数——演示应用程序的第一步——相当简单:</p><pre class="wp-block-code"><code>const uuidv4 = require('uuid/v4')
const AWS = require('aws-sdk')
AWS.config.update({ region: process.env.REGION || 'us-east-1' })
const s3 = new AWS.S3();
exports.handler = async (event) =&gt; {
  return await getUploadURL()
}
const getUploadURL = async () =&gt; {
  const actionId = uuidv4()
  const s3Params = {
    Bucket: '&lt;&lt; ENTER YOUR BUCKET NAME HERE &gt;&gt;',
    Key:  `${actionId}.jpg`,
    ContentType: 'image/jpeg',
    ACL: 'public-read',
  }
  return new Promise((resolve, reject) =&gt; {
    let uploadURL = s3.getSignedUrl('putObject', s3Params)
    resolve({
      "statusCode": 200,
      "isBase64Encoded": false,
      "headers": { "Access-Control-Allow-Origin": "*" },
      "body": JSON.stringify({
        "uploadURL": uploadURL,
        "photoFilename": `${actionId}.jpg`
      })
    })
  })
})</code></pre><p id="84db">尽管这个函数很简单，但是在请求签名的URL之前，可以很容易地在这个阶段添加各种逻辑。一旦函数就绪，接下来的事情就是设置API Gateway并创建一个GET方法来创建端点。或者，您可以使用<a href="https://serverless.com/" target="_blank" rel="noreferrer noopener">无服务器框架</a>进行部署，并自动执行这一步骤。</p><h3 id="7ad5">构建前端</h3><p id="c8de">该项目基于一个<a href="https://vuejs.org/v2/guide/" target="_blank" rel="noreferrer noopener">样板Vue模板</a>，但是演示该功能的所有重要工作都发生在s3uploader.vue中。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/da0bff34ec421f0c9b7180819b97de54.png" alt="Step one is to request the upload URL and step two is to upload directly to S3. " class="wp-image-42050" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_EphViVWOON4QH_DWTEmL4A.png"/><figcaption>s3uploader.vue</figcaption></figure><p id="3daf">同样，这是最少的代码，没有错误处理或细节以保持示例的简单，但是您可以看到实现这一点所需的代码只有几行。如果你打开Chrome开发者控制台(按F12)，你可以在整个过程中看到console.log输出。</p><h3 id="6d1a">设置您的权限</h3><p id="ab0c">最后，谈谈权限——当您请求签名的URL时，请求函数需要适当的IAM权限来请求和上传文件。</p><p id="df18">一些管理政策包括过于慷慨的S3:*许可。这些功能在开发中工作而在生产中失败是很常见的，因为当提升到生产时，IAM角色被切换到一组更窄的特权。函数使用的IAM角色必须能够写入桶中，否则无法工作。</p><h3 id="5616">回到可伸缩性</h3><p id="386e">这一切之所以值得，是因为可伸缩性。如果您需要允许大量用户上传文件，这种方法可以减轻您的所有网络负担(用户直接上传到S3 ),并且扩展是无缝和自动的。当没人使用你的功能时，你不用付费。</p><p id="9d24">此外，由于用户和S3之间没有服务器中继，您可以消除另一个故障点。<a href="https://acloudguru.com/blog/engineering/brazeal-in-praise-of-s3-the-greatest-cloud-service-of-all-time"> S3以其“11个9”的耐用性而闻名</a>，所以您也可以从文件几乎不可能消失这一事实中受益。</p><p id="cb67">总的来说，考虑到无服务器实现的好处，在使用AWS基础设施时，这似乎是管理任何形式的文件上传的明显而简单的方法。</p><hr class="wp-block-separator is-style-wide"/><h2 class="has-text-align-center" id="h-get-the-skills-you-need-for-a-better-career">获得更好职业所需的技能。</h2><p class="has-text-align-center">掌握现代技术技能，获得认证，提升您的职业生涯。无论您是新手还是经验丰富的专业人士，您都可以通过实践来学习，并在ACG的帮助下推进您的云计算职业生涯。</p><hr class="wp-block-separator is-style-wide"/></div></div>    
</body>
</html>