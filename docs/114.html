<html>
<head>
<title>Create a Serverless Python API with AWS Amplify and Flask | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用AWS Amplify和Flask创建一个无服务器的Python API</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/create-a-serverless-python-api-with-aws-amplify-and-flask#0001-01-01">https://acloudguru.com/blog/engineering/create-a-serverless-python-api-with-aws-amplify-and-flask#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>Flask是我最喜欢的创建快速API的工具之一。Python仍然是我最喜欢的编程语言，尽管过去几年主要使用JavaScript语法对我来说简单而优雅，像Pandas这样的Python库的能力令人难以置信。</p><p>部署Python应用程序并不总是最有趣的活动，所以我们还将使用AWS Lambda来使我们的应用程序<a href="https://aws.amazon.com/serverless/">无服务器</a>。另外，我们将使用AWS Amplify的命令行界面来创建和管理我们的资源。</p><p>我们还需要一个数据库来存储我们的数据，在这种情况下，我们将为布兰妮的歌曲构建一个API，并使用<a href="https://aws.amazon.com/dynamodb/"> DynamoDB </a>来存储我们的数据。</p><p>本教程对于已经掌握了关于AWS Amplify、API如何工作以及Python的基础知识的人来说是最有帮助的。</p><p>让我们深入研究代码！</p><figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler wp-embed-aspect-16-9 wp-has-aspect-ratio"><p class="wp-block-embed__wrapper">项目设置</p></figure><p>首先，我们将初始化一个Amplify项目。你需要安装和配置<a href="https://docs.amplify.aws/cli/start/install">Amplify CLI</a>和<a href="https://nodejs.org/en/download/">节点</a>。我将从React应用程序开始，但我们将专注于教程的后端，所以如果你不是React开发人员，你应该没问题！</p><h2 id="project-setup">在您的终端中运行下面的命令来创建一个React样板文件，更改为它，然后初始化Amplify。</h2><p>初始化Amplify会提示你一些问题。对于所有这些，您只需按enter键就可以选择默认值！</p><p>添加数据库</p><pre class="wp-block-code"><code>$ npx create-react-app britney-spears-api
$ cd britney-spears-api
$ amplify init</code></pre><p>接下来，我们需要向我们的项目添加一个DynamoDB数据库。在您的CLI中运行<code>amplify add storage</code>。这会问你一些关于你的数据的问题。</p><pre class="wp-block-code"><code>? Enter a name for the project britneyspearsapi
? Enter a name for the environment dev
? choose your default editor: Visual Studio Code
? Choose the type of app that you\'re building javascript
? What javascript framework are you using react
? Source Directory Path: src
? Distribution Directory Path build
? Build Command: npm run-script build
? Start Command: npm run-script start
? Do you want to use an AWS profile? yes
? Please choose the profile you want to use `your-profile`</code></pre><h2 id="add-a-database">现在，运行<code>amplify push -y</code>在AWS上部署您的数据库！</h2><p>创建API</p><pre class="wp-block-code"><code>? Please select from one of the below mentioned services: NoSQL Database
? Please provide a friendly name for your resource that will be used to label this category in the project: britneySongStorage
? Please provide table name: britneySongs

? What would you like to name this column: id
? Please choose the data type: string
? Would you like to add another column: Yes
? What would you like to name this column: name
? Please choose the data type: string
? Would you like to add another column: Yes
? What would you like to name this column: year
? Please choose the data type: number
? Would you like to add another column: Yes
? What would you like to name this column: link
? Please choose the data type: string
? Would you like to add another column: No

? Please choose partition key for the table: id
? Do you want to add a sort key to your table? N

? Do you want to add global secondary indexes to your table? No
? Do you want to add a Lambda Trigger for your Table? No</code></pre><p>现在，让我们添加一个API！我们将为所有CRUD操作创建路径，并允许数据库交互。</p><h2 id="create-the-api">我们将使用Amplify CLI添加一个API:<code>amplify add api</code>。</h2><p>系统会提示您回答一些问题。首先，命名您的API，然后为您的路由提供一个基本路径。</p><p>然后，系统会提示我们创建一个新的AWS Lambda函数，并将其命名为。我们将使用Python语言。</p><p>我们还需要配置一些高级设置，以便访问我们的数据库。使用空格键选择存储和所有CRUD操作。</p><pre class="wp-block-code"><code>? Please select from one of the below mentioned services: REST
? Provide a friendly name for your resource to be used as a label for this category in the project: britneySongApi
? Provide a path (e.g., /book/{isbn}): /song</code></pre><p>然后，您可以对接下来的几个问题回答“否”，尽管我会选择“是”来编辑您的本地Lambda函数。它会打开你的文本编辑器找到你想要的文件！</p><pre class="wp-block-code"><code>? Choose a Lambda source Create a new Lambda function
? Provide an AWS Lambda function name: britneyspearsapi
? Choose the runtime that you want to use: Python</code></pre><p>创建一个API将启用<a href="https://aws.amazon.com/api-gateway/"> Amazon API网关</a>，它将处理HTTP请求到我们Lambda函数的路由。</p><pre class="wp-block-code"><code>? Do you want to configure advanced settings? Yes
? Do you want to access other resources in this project from your Lambda function? Yes
? Select the categories you want this function to have access to. storage
? Select the operations you want to permit on britneySongStorage create, read, update, delete</code></pre><p>最后，运行amplify push将您的服务部署到云中。<code>-y</code>标志将跳过确认步骤。</p><pre class="wp-block-code"><code>? Do you want to invoke this function on a recurring schedule? No
? Do you want to configure Lambda layers for this function? No
? Do you want to edit the local lambda function now? Yes
? Restrict API access No
? Do you want to add another path? No</code></pre><p><strong>注意:每当您想要部署对API的更改时，您都需要重新运行这个push命令。</strong></p><p>Python函数</p><pre class="wp-block-code"><code>$ amplify push -y</code></pre><p>首先，转到您的函数的目录:</p><h2 id="python-function">您需要为Python打包安装<a href="https://pypi.org/project/pipenv/"> pipenv </a>。然后，我们将安装必要的软件包。</h2><p><code>aws-wsgi</code>将允许我们使用烧瓶路由</p><pre class="wp-block-code"><code>cd amplify/backend/function/britneyspearsapi
</code></pre><p>在Python中支持与AWS服务的交互，我们将在DynamoDB中使用它</p><ul><li>是我们的网络框架</li><li>将为我们的flask应用程序处理CORS</li><li>然后，打开你的Lambda函数的代码——它是在<code>amplify add api</code>步骤中为你打开的，但是如果你关闭了它，在你的函数文件夹中打开<code>src/index.py</code>。</li><li>在你的文件中会有一个生成的“Hello World”Lambda函数，你可以删除它。</li></ul><pre class="wp-block-code"><code>$ pipenv install aws-wsgi boto3 flask flask-cors</code></pre><p>首先，我们需要初始化Flask应用程序。我们还将使用<code>flask-cors</code>来处理CORS。</p><p>在这段代码下面，添加一个Lambda处理程序—这个函数将处理我们的请求事件。API Gateway专门寻找一个名为<code>handler</code>的函数，所以一定要这样称呼它！</p><p>我们还将使用<a href="https://github.com/slank/awsgi"> <code>awsgi</code> </a>来使用带有API网关的WSGI中间件。</p><pre class="wp-block-code"><code>from flask_cors import CORS
from flask import Flask, jsonify, request

app = Flask(__name__)
CORS(app)</code></pre><p>导入<code>awsgi</code>:</p><p>然后添加<code>handler</code>功能:</p><p>在<code>handler</code>上面，我们来添加我们的第一条路线！在上面的<code>amplify add api</code>步骤中，我们已经为我们的API创建了一个基本路径。我将把这个路由保存到一个变量中，这样我就可以用它作为我所有URL的前缀。然后，我将为我的Flask应用程序添加一个路由，处理那个<code>/songs/</code> url并接受GET请求。现在，我将发送一个“hello world”消息。</p><pre class="wp-block-code"><code>+ import awsgi
from flask_cors import CORS
from flask import Flask, jsonify, request</code></pre><p>运行<code>amplify push -y</code>以部署您的更改。</p><pre class="wp-block-code"><code>def handler(event, context):
    return awsgi.response(app, event, context)</code></pre><p>要在前端使用这个路径，首先我要安装<code>aws-amplify</code>。在你的前端的根目录而不是你的Python函数的根目录中这样做。</p><pre class="wp-block-code"><code># Constant variable with path prefix
BASE_ROUTE = "/song"

@app.route(BASE_ROUTE, methods=['GET'])
def list_songs():
    return jsonify(message="hello world")</code></pre><p>然后，配置放大器。如果你在一个<code>create-react-app</code>生成的项目中，把它放在<code>index.js</code>文件中。</p><p>然后，添加API调用。我们将使用<code>aws-amplify</code>的<code>API.get</code>向我们的API发出GET请求。第一个参数是我们创建的API的名称，第二个参数是我们想要请求的路由。</p><pre class="wp-block-code"><code>$ npm i aws-amplify</code></pre><p>添加创建路线</p><pre class="wp-block-code"><code>import { Amplify } from 'aws-amplify'
import config from './aws-exports'

Amplify.configure(config)</code></pre><p>现在，让我们制作一条将在我们的数据库中创建一首新歌的路线。我将导入<code>boto3</code>、<code>uuid</code>和<code>os</code>，然后创建一个到数据库的新连接。我们还将从Amplify为我们创建的环境变量中获得DynamoDB表的名称。这些在<code>amplify add api</code>步骤的输出中列出。</p><pre class="wp-block-code"><code>import { API } from 'aws-amplify'

const getData = async () =&gt; {
  const data = await API.get('britneySongApi', '/song')
  console.log(data)
}</code></pre><h2 id="add-create-route">现在，我们将创建我们的路线。这个仍然位于<code>/song</code> url，但是这次它将处理一个POST请求。我们将获取请求对象，将其转换为json，然后创建项目。我们将提供表的名称和该项目的数据。我们将使用Python的<code>uuid4</code>函数随机生成<code>id</code>。然后，我们将返回一条消息，表明该项已被创建。</h2><p>现在，在前端，我们将发出创建新歌的POST请求！</p><pre class="wp-block-code"><code>import awsgi
+ import boto3
+ import os

from flask_cors import CORS
from flask import Flask, jsonify, request
+ from uuid import uuid4

+ client = boto3.client("dynamodb")
+ TABLE = os.environ.get("STORAGE_BRITNEYSONGSTORAGE_NAME")
BASE_ROUTE = "/song"</code></pre><p>添加列表路由</p><pre class="wp-block-code"><code>
@app.route(BASE_ROUTE, methods=['POST'])
def create_song():
    request_json = request.get_json()
    client.put_item(TableName=TABLE, Item={
        'id': { 'S': str(uuid4()) },
        'name': {'S': request_json.get("name")},
        'year': {'S': request_json.get("year")},
        'link': {'S': request_json.get("link")},
    })
    return jsonify(message="item created")</code></pre><p>让我们更新我们的list route来返回数据库中所有歌曲的列表。将<code>list_items</code>功能的返回改为表格扫描。</p><pre class="wp-block-code"><code>const data = await API.post('britneySongApi', '/song', { 
  body: { 
    name: 'Toxic', 
    year: '2003', 
    link: 'https://www.youtube.com/watch?v=LOZuxwVk7TU' 
  } 
})
console.log(data)</code></pre><h2 id="add-list-route">然后在前端，你可以提出这个请求来查看所有的歌曲！</h2><p>添加获取路线</p><pre class="wp-block-code"><code>@app.route(BASE_ROUTE, methods=['GET'])
def list_songs():
+    return jsonify(data=client.scan(TableName=TABLE))</code></pre><p>现在，我们将添加一个函数，它根据歌曲的<code>id</code>获取一首歌曲。我们将创建一个路由来处理对<code>/song/&lt;song_id&gt;</code>的GET请求。然后，我们将在数据库中查询具有该id的歌曲！</p><pre class="wp-block-code"><code>const data = await API.get('britneySongApi', '/song')
console.log(data)</code></pre><h2 id="add-get-route">添加编辑路线</h2><p>现在，我们需要添加一个路由来编辑一个项目。这将处理对<code>/song/&lt;song_id&gt;</code>的<code>PUT</code>请求。这个<code>Key</code>将是我们想要更新的歌曲的<code>id</code>。<a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.UpdateExpressions.html"> <code>UpdateExpression</code> </a>将允许我们修改歌曲的所有属性。然后，<code>ExpressionAttributeNames</code>提供键名，<code>ExpressionAttributeValues</code>提供值。</p><pre class="wp-block-code"><code>@app.route(BASE_ROUTE + '/&lt;song_id&gt;', methods=['GET'])
def get_song(song_id):
    item = client.get_item(TableName=TABLE, Key={
        'id': {
            'S': song_id
        }
    })
    return jsonify(data=item)</code></pre><h2 id="add-edit-route">添加删除路线</h2><p>最后，我们将添加一个删除歌曲的路由。</p><pre class="wp-block-code"><code>@app.route(BASE_ROUTE + '/&lt;song_id&gt;', methods=['PUT'])
def update_song(song_id):
    client.update_item(
        TableName=TABLE,
        Key={'id': {'S': song_id}},
        UpdateExpression='SET #name = :name, #year = :year, #link = :link',
        ExpressionAttributeNames={
            '#name': 'name',
            '#year': 'year',
            '#link': 'link'
        },
        ExpressionAttributeValues={
            ':name': {'S': request.json['name']},
            ':year': {'S': request.json['year']},
            ':link': {'S': request.json['link']},
        }
    )
    return jsonify(message="item updated")</code></pre><h2 id="add-delete-route">运行<code>amplify push -y</code>以部署您的更改！</h2><p>排除故障</p><pre class="wp-block-code"><code>@app.route(BASE_ROUTE + '/&lt;song_id&gt;', methods=['DELETE'])
def delete_song(song_id):
    client.delete_item(
        TableName=TABLE,
        Key={'id': {'S': song_id}}
    )
    return jsonify(message="song deleted")</code></pre><p>为了调试API的问题，您可以用一个<code>event.json</code>文件更新run <code>amplify mock</code>来匹配您请求的事件对象。例如，要测试<code>/song</code>路径，您可以使用如下事件:</p><h2 id="debugging"><code>event.json</code></h2><p>然后运行:</p><p>在本地测试您的功能。</p><pre class="wp-block-code"><code>{ "path": "/song", "httpMethod": "GET", "queryStringParameters": ""}</code></pre><p>后续步骤</p><pre class="wp-block-code"><code>$ amplify mock function britneyspearsapi</code></pre><p>本教程演示了如何使用AWS SDK和AWS Amplify生成的Lambda函数来构建完整的CRUD API。你可以继续使用其他的放大资源，比如存储歌曲文件的存储器，或者限制API使用的认证。您还可以构建一个完整的前端来提取数据。</p><h2 id="next-steps">Next Steps</h2><p>This tutorial demonstrates how to use the AWS SDK with an AWS Amplify-generated Lambda function to build a full CRUD API. You could continue to use other Amplify resources like storage to store the song files, or authentication to restrict the API usage. You could also build out a full frontend to pull the data.</p></div></div>    
</body>
</html>