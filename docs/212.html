<html>
<head>
<title>How to Build a Serverless Multi-Region Backend | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何构建无服务器多区域后端|云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/building-a-serverless-multi-region-active-active-backend#0001-01-01">https://acloudguru.com/blog/engineering/building-a-serverless-multi-region-active-active-backend#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p class="has-text-align-center" id="h-the-solution-is-built-using-dynamodb-global-tables-aws-lambda-regional-api-gateway-and-route53-routing-policies"><em>该解决方案使用DynamoDB全局表、AWS Lambda、区域API网关和Route53路由策略构建</em></p><p id="70a3">在之前的帖子中，我们探讨了可用性和可靠性以及在AWS上构建多区域、主动-主动架构的T2需求和方法。在这篇博文中，我将带您了解构建和部署一个<strong>无服务器多区域、主动-主动后端</strong>所需的步骤。</p><p id="233a">这真的让我大吃一惊——因为我可以在一篇博文中解释这一点，你应该可以在大约一个小时内部署一个全功能的后端。相比之下，几年前这需要更多的专业知识、工作、时间和金钱！</p><p id="79c4">首先，让我们看看最终的解决方案，这样我们就知道接下来会发生什么。</p><h2 id="47ee">将DynamoDB用于多区域数据库</h2><p id="9e8a">这里给出的解决方案相当简单。它利用了<a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/GlobalTables.html" target="_blank" rel="noreferrer noopener"> DynamoDB全局表</a>，后者提供了一个完全托管的多区域、多主数据库。</p><p id="58c7">我们还将利用AWS Lambda实现业务逻辑和API网关中新的<a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/create-regional-api.html" target="_blank" rel="noreferrer noopener">区域API端点。最后，我们的解决方案使用</a><a href="https://acloudguru.com/blog/engineering/configure-dns-with-route-53"> AWS Route 53 </a>路由策略在两个AWS区域之间动态路由流量。</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/4a98d7db82580d83f5a87dc44ff8d3da.png" alt="Multi-Region, Active-Active Serverless Backend Solution Overview" class="wp-image-41889" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_9kd-xTVBIRla_41_FNmzOQ.png"/><figcaption>Multi-Region, Active-Active Serverless Backend Solution Overview</figcaption></figure></div><p><strong>我们开始吧！</strong></p><hr class="wp-block-separator is-style-dots"/><h3 id="51f9">步骤1:在DynamoDB中创建一个全局表</h3><p id="a915">请记住，DynamoDB全局表由多个副本表组成，每个副本表对应一个选择区域<em>(目前支持5个区域)</em>，DynamoDB将其视为一个单元。每个副本都有相同的表名和相同的主键模式。</p><p id="17af">要开始创建一个全局表，打开<a href="https://console.aws.amazon.com/dynamodb/home" target="_blank" rel="noreferrer noopener"> DynamoDB控制台</a>创建一个带有主键的表。在我们的示例中，我们将使用<strong> <em> MyGlobalTable </em> </strong>和<strong> <em> item_id </em> </strong>作为主键，并单击<strong> Create </strong>。该表将作为全局表中的第一个副本表。</p><ul><li>一旦创建了表格，选择<strong>全局表格</strong>选项卡</li><li>您会注意到创建了一个全局表</li><li>您应该启用<a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.html" target="_blank" rel="noreferrer noopener"> DynamoDB流</a></li><li>点击<strong>启用流</strong></li></ul><blockquote class="wp-block-quote"><p><strong>注意</strong> <em>:你会注意到一个弹出窗口，提到正在使用的流的视图类型——</em><strong>新旧图像</strong> <em>。这仅仅意味着每当表中的数据被修改时，表中该项目的新旧图像都将被写入流中。当然，这个流用于跨区域复制数据。</em></p></blockquote><p>然后，您可以<strong>将区域</strong>添加到您想要部署副本表的全局表中。</p><p>这将在您选择的区域启动表创建过程。几秒钟后，您应该能够看到新创建的全局表的不同区域。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/8cd2ec4c786a3929500a7b51a71814ab.png" alt="" class="wp-image-41888" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_5dQhCeg6EjF6vGz-3dyarQ.png"/></figure><p>您可以使用AWS CLI做同样的事情——事实上这是值得鼓励的！</p>  <p>然后，您可以使用以下代码测试全局表:</p>  <p>你注意到DynamoDB全局表创建的新字段了吗？跨区域复制过程添加了<strong><em>AWS:rep:update region</em></strong>和<strong><em>AWS:rep:update time</em></strong>属性，以便您可以跟踪项目的来源；这两个字段都可以被您应用程序使用，但是当然不应该被修改。</p><hr class="wp-block-separator is-style-dots"/><h3 id="96b1">步骤2:使用AWS Lambda和API网关创建后端</h3><p id="aedb">由于我们解决方案的这一部分利用了新的区域API端点，让我们先来看看。</p><p id="8e37"><strong>API Gateway Regional Endpoints<br/></strong>A<a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/create-regional-api.html" target="_blank" rel="noreferrer noopener">Regional API Endpoints</a>是一种新的端点类型，可以从部署了REST API的同一个AWS区域进行访问。当API请求来自与REST API相同的区域时，这可以改善请求延迟。</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/554175d87ee49bc03fc7660c4db8e452.png" alt="" class="wp-image-41905" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_Zgkstzi30LTrzCLvWT7Fag.png"/><figcaption>Regional API Endpoints for Amazon API Gateway</figcaption></figure></div><p><strong>后端函数<br/> </strong>出于演示目的，我们将创建三个函数；一个是将项目发布到DynamoDB，一个是从DynamoDB获取项目，还有一个健康检查来确保后端是健康的。</p>  <blockquote class="wp-block-quote"><p><strong>注意</strong>:你注意到健康功能的极端复杂性了吗？我知道…这样做是为了以后我可以很容易地测试Route53中的故障转移机制。请比我聪明🙂</p></blockquote><p id="c81b">为了部署这些功能，让我们使用<a rel="noreferrer noopener" href="https://serverless.com/" target="_blank">无服务器框架</a>。为什么？自从它最初作为<strong> <a rel="noreferrer noopener" href="https://serverlesscode.com/post/serverless-formerly-jaws/" target="_blank">大白鲨</a> </strong>推出以来，我一直在使用它，我喜欢它——就这么简单。您也可以使用<a rel="noreferrer noopener" href="https://docs.aws.amazon.com/lambda/latest/dg/serverless_app.html" target="_blank"> AWS无服务器应用程序模型SAM </a>做同样的事情。</p><p id="eb01">使用无服务器框架部署API的模板如下:</p>  <blockquote class="wp-block-quote"><p><strong>注意</strong>:请确保将<a href="https://gist.github.com/adhorn/cab4b461f46cc66f27d49e1de4230c7f" target="_blank" rel="noreferrer noopener"> serverless.yml </a>文件中的“xxxxxxxxxxxxx”替换为您之前创建DynamoDB表时使用的AWS帐户ID。</p></blockquote><p id="c254">将API部署在爱尔兰和法兰克福——或者您用于DynamoDB表的地区。</p>  <blockquote class="wp-block-quote"><p><strong>注意</strong> <em>:如果在部署中发现关于endpointType的错误，在</em> <a href="https://gist.github.com/adhorn/cab4b461f46cc66f27d49e1de4230c7f" target="_blank" rel="noreferrer noopener"> serverless.yml </a> <em>文件中将其注释掉，然后重新部署。然后，您可以登录到API网关控制台，手动将端点类型转换为区域类型。</em></p></blockquote><p><strong>测试地区API<br/></strong>由于我们之前已经在数据库中插入了一个“foobar”项目，我们可以尝试通过rest API访问它。</p>  <p>太好了！我们的项目可从两个地区。现在让我们创建一个新的。</p>  <p>太棒了——它起作用了。</p><hr class="wp-block-separator is-style-dots"/><h3 id="3088">步骤3:创建自定义域名</h3><p id="7143">接下来，让我们为这些区域API端点创建一个Amazon API网关自定义域名端点。为此，您必须拥有一个可在Route 53中使用的托管区域和域，以及一个用于特定域名的SSL证书。</p><p id="0e6e">现在，在您部署了API Gateway和AWS Lambda后端的每个地区，从<a href="https://eu-west-1.console.aws.amazon.com/acm/home?region=eu-west-1" target="_blank" rel="noreferrer noopener">AWS Certificate Manager(ACM</a>)请求一个SSL证书。</p><p id="bb46">在这些步骤结束时，它会要求您通过电子邮件或在Route 53 DNS配置中添加特殊记录集来验证您的请求。</p><p id="7389">一旦一切都得到验证，您就可以将每个区域中的API网关端点配置为拥有一个自定义域名。在这两个区域中，您实际上配置了相同的自定义域名。请注意，基本路径映射需要在根路径'<strong>/【T1]'和目标路径上，目标路径是之前部署的API，还有stage变量—这里是<em> dev </em>。</strong></p><blockquote class="wp-block-quote"><p><strong>注意</strong>:确保name字段中自定义域名的名称与您的域名匹配，否则它将无法工作(我使用的是globe.adhorn.me)。</p></blockquote><p id="5acd">一旦您配置了新的自定义域名，就获取<strong>目标域名</strong>——在最后的步骤中需要它们。</p><hr class="wp-block-separator is-style-dots"/><h3 id="e2e8">步骤4:在53号公路上增加健康检查</h3><p id="d8a0">一旦您有两个或更多执行相同功能的资源，例如我们的多区域、主动-主动后端，您就可以使用Route 53的健康检查功能将流量仅路由到“健康”资源。</p><p id="6d03">让我们使用之前部署的健康API来配置我们的健康检查。</p><p>对每个地区的运行状况检查API执行相同的操作。一旦完成，您应该能够在Route 53的健康检查中看到健康状态变为绿色。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/12e296c486f35066a89257927078c782.png" alt="" class="wp-image-41890" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_a1rbXA1a6FU7GE6_T6MOiQ.png"/></figure><hr class="wp-block-separator is-style-dots"/><h3 id="3660">步骤#5:使用Route 53在区域之间添加路由策略</h3><p id="d377">现在是最后一部分——添加部署在法兰克福和爱尔兰的两个区域API之间的路由策略。</p><p id="1e2b">进入Route 53控制台，添加如下流量策略。在配置自定义域名时，使用API Gateway创建的<strong>目标域名</strong>，以便在策略中设置端点值。</p><p>最后，使用之前创建的流量策略创建策略记录DNS名称。</p><p>瞧！您的多区域、主动-主动后端已准备好接受测试！</p>  <p>它非常有效！</p><hr class="wp-block-separator is-style-dots"/><h3 id="2878">步骤6:测试53号公路的故障转移功能</h3><p id="a2d8">通过将AWS Lambda控制台中的环境变量STATUS(在<strong> <em> eu-west-1 </em> </strong>、Ireland中)设置为404并保存，来修改精心制作的(<em>讥讽…</em>)<strong><em>makehealthcheckcalls()</em></strong>函数返回的值。</p><p>过一会儿，您应该会看到53号公路的健康检查状态从健康变为<strong>不健康。</strong>在理想情况下，您还会为检查创建一个警报。</p><p>现在，尝试在数据库中创建一系列项目。</p>  <p>正如您在下面看到的，所有创建的新项目都以<strong> <em> eu-central-1 </em> </strong>地区为起点(法兰克福)——因此使用53号公路健康检查的故障转移功能按预期工作。</p><hr class="wp-block-separator is-style-dots"/><h3 id="dba9">这是一个总结！</h3><p id="87ab">现在你可能想知道是不是这样——嗯，是的。这篇文章是一个介绍，给你新的想法，也许挑战一些旧的。</p><p id="12a7">您可以做很多事情来改进这里介绍的解决方案，其中一些可以添加身份验证、监控、持续集成和部署，等等。</p><p id="8c7b">我没有包括身份验证的原因很简单，目前，Cognito不支持跨多区域的用户池同步——所以需要手工构建。已经有一个+1的论坛线程来支持该功能，所以如果你也想这样，请添加你的😉</p><p id="d18b">在这篇文章中，我们已经构建了一个无服务器的多区域、主动-主动后端，由DynamoDB全局表、AWS Lambda和API Gateway提供支持。我们还了解了如何使用Route 53在地区之间路由流量，同时支持故障转移机制。</p><p id="c848">我仍然对此感到惊讶——因为就在几年前，这还需要做更多的工作。回到2012年的平安夜，网飞流媒体服务经历了一次中断，这几乎是他们构建主动-主动多区域架构之旅的起点。那也是我爱上弹性架构的时候——我希望你也会受到启发，为了设计明天的解决方案，挑战目前可能的极限。</p><p id="4025">在接下来的一系列帖子中，我将谈论<a href="https://acloudguru.com/blog/engineering/how-to-improve-your-systems-by-injecting-controlled-failure-with-chaos-engineering">混沌工程</a>并特别讨论为什么要练习打破东西。我将使用这里介绍的这种无服务器多区域、主动-主动体系结构作为实验的起点。敬请期待！</p><p id="148b"><strong>【更新】—我在这里发表了</strong> <a href="https://medium.com/@adhorn/adding-support-for-vpc-build-a-serverless-multi-region-active-active-backend-solution-d80d25157688" target="_blank" rel="noreferrer noopener"> <strong> VPC对AWS Lambda和DynamoDB的支持！</strong> </a></p><h3 id="h-want-some-more-cloud-goodness-check-these-out">想要更多的云朵吗？看看这些:</h3></div></div>    
</body>
</html>