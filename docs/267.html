<html>
<head>
<title>How to build a serverless contact form on AWS | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何在AWS |云专家上构建无服务器联系表单</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/how-to-build-a-serverless-contact-form-on-aws#0001-01-01">https://acloudguru.com/blog/engineering/how-to-build-a-serverless-contact-form-on-aws#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>联系方式对所有网站来说都是至关重要的，无论大小。有许多服务可以将联系表单嵌入到您自己的网站中，但是本教程并不是要利用这些服务。相反，它是关于通过关注创建我们自己的联系表单架构的问题来学习少量的Amazon Web服务。在本指南结束时，我们将创建一个无服务器联系表单，并了解有关以下服务的更多信息:</p><ul> <li>API网关</li> <li>希腊字母的第11个</li> <li>简单电子邮件服务</li></ul><p>我们将创建一个<strong> API网关</strong> (APIGW) POST端点，它将接受以下JSON请求体:<code>{“email”: &lt;contact-email&gt;,“subject”: &lt;contact-subject&gt;,“message”: &lt;contact-message&gt;}</code>这个端点将有一个<strong> Lambda </strong>函数，它将把请求体转换成电子邮件。该电子邮件请求将被发送到<strong>简单电子邮件服务</strong> (SES)进行交付。有了这些部分，我们就可以创建一个发送消息的联系表单。</p><h2>配置简单电子邮件服务向我们发送电子邮件</h2><p>在深入研究任何代码之前，我们需要配置简单的电子邮件服务(SES)。我们的Lambda函数将处理来自我们网站的消息，并通过SES发送电子邮件。SES是一个发送和接收电子邮件的巧妙产品。它提供了高投递率、成本效益和非常可靠的电子邮件处理。在本帖中，我们将利用它来获取一条消息，并将其发送到我们自己的白名单电子邮件地址。对于我们正在创建的项目，我们可以在ses沙盒环境中做任何事情。沙盒环境有以下限制:</p><ol> <li>只能向SES邮箱模拟器<em>或</em>发送电子邮件至您已验证的电子邮件地址或域。</li> <li>每天限发200封邮件。</li></ol><p>如果您打算每天发送超过200封电子邮件，您将需要请求提高发送限额。一旦获得批准，该请求会将您从沙箱中移除。然而，对于这个项目，您在沙盒环境中会很好。要配置SES向您自己发送电子邮件，我们需要完成以下步骤:</p><ol> <li>导航到AWS控制台中的简单电子邮件服务。</li> <li>点击<strong>电子邮件地址</strong></li> <li>点击<strong>验证新的电子邮件地址</strong></li> <li>输入您希望用于联系请求的电子邮件地址。</li> <li>点击<strong>验证该电子邮件地址</strong></li> <li>检查您的电子邮件，查看主题为“亚马逊网络服务-电子邮件地址验证请求”的验证电子邮件</li> <li>单击电子邮件中的链接以确认您的电子邮件地址。</li></ol><h2>设置初始Lambda函数以响应API网关触发器</h2><p>你的SES设置好了吗？您的电子邮件地址是经过验证的电子邮件地址，SES可以向其发送电子邮件。那你已经取得了很大的进步。自2014年11月Lambda函数首次亮相以来，亚马逊网络服务已经简化了它们的创建。过去的情况是，为不同的AWS事件配置Lambda既繁琐又容易出错。如今，初始设置更加简化和用户友好。这对我们来说太棒了，但是要知道，我们将不得不做一些进一步的调整。但是首先，让我们设置初始Lambda并从API网关端点触发它。无服务器堆栈的主干是一个<em>事件</em>。事件启动计算资源的分配以完成某个操作。AWS中的<em>触发器</em>是分配一个容器来执行Lambda函数中的代码的事件。在AWS中，Lambda目前可以响应17种不同的事件。今天，我们通过HTTP端点利用API网关事件。可以把HTTP端点看作是Lambda函数的触发事件。该请求启动容器，并包含Lambda函数的输入事件。使用这个输入，我们可以在代码中处理消息。不如我们跳进去配置初始端点和Lambda函数:</p><ol> <li>从AWS控制台导航到Lambda。</li> <li>点击<strong>创建功能</strong></li> <li>在蓝图输入中，输入“<em> api </em></li> <li>点击NodeJs 6.10中的蓝图“<em>微服务-http-端点</em>”。</li> <li>对于“API名称”，点击<strong>输入值</strong>并输入“<em>联系人</em></li> <li>对于“部署阶段”，保持默认的“<em>产品</em>”处于选中状态。</li> <li>对于“安全”，选择“<em>打开</em></li> <li>点击<strong>下一个</strong></li> <li>输入“<em> ContactFormLambda </em>”作为您的函数名。</li> <li>输入有意义的描述，如"<em>处理APIGW发布到/联系</em></li> <li>运行时选择“<em> Node.js 6.10 </em>”。</li> <li>现在，我们将在内联代码部分输入这个样板代码:</li> <li>在“Lambda函数处理程序和角色”中，将处理程序留在“<em> index.handler </em>”。角色应为“<em>从模板创建新角色</em>”。对于角色名称，输入“<em> ses-contact-form-lambda </em>”。对于策略模板，选择“<em>简单微服务权限</em>”<em>注意:我们稍后将围绕这些方面进行更多配置。</em></li> <li>点击<strong>下一个</strong></li> <li>点击<strong>创建功能</strong></li></ol><p>通过完成此向导，我们将获得以下AWS资源:</p><ul> <li>代理HTTP(S)请求的API网关端点。</li> <li>API网关端点触发的Lambda函数。</li> <li>一个IAM角色"<em> ses-contact-form-lambda </em>"拥有lambda的基本执行策略。</li></ul><p>还需要进一步的改进，但是我们现在已经有了无服务器联系流程所需的资源。</p><h2>配置您的IAM角色以通过SES发送电子邮件</h2><p>在开始编写Lambda函数之前，我们需要暂停一下，配置一下<em>ses-contact-form-Lambda</em>IAM角色。目前，该角色不允许在SES中使用<span> sendEmail </span> API。为了使它变得非常轻量级，我们将创建一个新的IAM策略，该策略只包含我们需要授予访问权限的SES上的API。</p><ol> <li>从AWS控制台导航到IAM。</li> <li>点击<strong>策略</strong></li> <li>点击<strong>创建策略</strong></li> <li>选择“<em>创建您自己的策略</em></li> <li>输入“<em>联系人-表单-发送-电子邮件-策略</em>”作为名称。</li> <li>按如下方式配置策略文档:</li> <li>点击<strong>创建策略</strong></li></ol><p>现在有了一个粒度策略，允许访问<span> ses:SendEmail </span> API。将此策略附加到<em> ses-contact-form-lambda </em>角色:</p><ol> <li>从AWS控制台导航到IAM。</li> <li>点击<strong>角色</strong></li> <li>在搜索中输入"<em> ses-contact-form-lambda </em>"</li> <li>点击<em>ses-联系人-表单-λ</em>角色。</li> <li>点击<strong>附加保单</strong></li> <li>选择<em>联系人-表单-发送-邮件-政策</em></li> <li>点击<strong>附加策略</strong></li></ol><p>随着IAM的这些变化，Lambda函数现在可以访问SES的SendEmail API。</p><h2>从Lambda函数通过SES发送电子邮件</h2><p>我们现在已经为您的无服务器联系流程完成了所有的基础架构部分。只需点击几个按钮，瞧，我们有了API网关、Lambda函数和IAM角色。很圆滑，对吧？基础设施，在这一点上，还没有准备好黄金时间。我们一会儿就会这样做，但首先让我们添加通过SES从Lambda函数发送电子邮件的代码。我们的函数没有外部依赖性。因此，我们可以内联编辑代码。如果我们正在创建需要其他NPM模块的Lambda函数，我们将需要在AWS控制台之外进行开发。原因是当zip文件上传到Lambda时，必须包含NPM包。但这不是这个项目的重点。我们将内联编辑代码，因为我们没有外部依赖。</p><ol> <li>从AWS控制台导航到Lambda。</li> <li>点击<em> ContactFormLambda </em>功能。</li> <li>将以下代码输入行内编辑器:</li></ol><p>在56行代码中，我们有获取API网关请求、解析电子邮件消息、然后利用SES向我们自己发送电子邮件所必需的代码。但是等等——这段代码到底做了什么？很高兴你问了。让我们分解有趣的部分，回顾一下正在发生的事情。从Lambda函数的顶部开始，声明了三个常量:有趣的是,<em> aws-sdk </em>不是外部依赖。这个包在Lambda函数容器中是全局的，并且总是可用的。我们通过调用<span> AWS来实例化一个SES客户端。SES() </span>。我们还申报了<span> sesConfirmedAddress </span>。这必须是您之前在设置SES时验证的电子邮件地址。函数<span> getEmailMessage </span>处理请求的主体。它解析来自API网关请求体的请求，并构建<span> sendEmail </span>请求。我们希望将电子邮件发送给自己，因此<span> ToAddresses </span>是我们之前验证的ses电子邮件。<span>源</span>必须是我们验证过的电子邮件，因为这也是发送的电子邮件。其余的我们从用户通过我们的API网关发送的JSON请求中获得。电子邮件的正文在<span>消息</span>属性中。电子邮件的主题在<span>主题</span>属性中。电子邮件的回复字段在用户传入的<span> email </span>属性中。这是我们函数的核心，主事件处理器。首先要做的是提取请求正文，因为它包含电子邮件、消息和电子邮件的主题。接下来，通过将请求传递给<span> getEmailMessage </span>函数来获取<span> sendEmailRequest </span>。有了请求，我们调用<span>ses client . send email(params)</span>API。我们追加了<span>。promise() </span>方法告诉SDK我们想要一个承诺。<em> <strong>提示</strong>:用JavaScript中的aws-sdk，可以追加。promise()到任何SDK调用来获得一个承诺。</em>API网关端点设置为<em> LAMBDA_PROXY </em>。这意味着Lambda函数必须构建并返回一个HTTP响应。对于我们的目的，返回200表示成功，500表示错误就足够了。当<span> sendEmailPromise </span>解析成功时，返回200。如果失败，邮件发送失败，所以返回500。在这两种情况下，我们只改变<em>响应</em>的<em>状态码</em>并调用<span>回调(空，响应)</span>。您利用LAMBDA中的回调函数来表示成功或失败:<em>API Gateway中的LAMBDA_PROXY </em>需要来自您的Lambda函数的HTTP响应。调用总是以<span>回调(null，response) </span>结束。未能返回HTTP响应会导致API Gateway返回502错误网关。</p><h2>show time–测试您的端点的时间</h2><p>您将Lambda函数代码更新为上面的代码。您已将<span> sesConfirmedAddress </span>设置为已验证的SES电子邮件。Lambda的IAM角色可以访问简单电子邮件服务的<span> sendEmail </span> API。我们剩下的就是测试看看它是否有效。正如一句老话所说，如果你没有测试过它，那么它是不起作用的。对于这个项目的目的，我说的是通过使用它和观察结果来验证它的工作。如果我们要构建一个完整的生产应用程序，我们应该在这里进行其他级别的测试。单元测试和集成测试是很好的补充。但是对于这个简单的联系流，让我们确保它从我们的API网关工作。</p><ol> <li>从AWS控制台导航到API网关。</li> <li>点击<em>联系</em>API。</li> <li>点击“<em> /ContactFormLambda </em>”资源下的任意。</li> <li>点击<strong>测试</strong></li> <li>选择“过帐”作为方法。</li> <li>在请求正文中，输入以下内容:</li> <li>点击<strong>测试</strong></li></ol><p>在右边，我们将看到API Gateway调用Lambda函数的请求流。下面是我们在底层寻找的东西:</p><ul> <li>方法已完成，状态为:200 —太棒了，它成功了！检查你的电子邮件。</li> <li>方法已完成，状态为:500 —该死，它坏了。该检查日志了。</li> <li>方法已完成，状态为:502-配置错误。该检查日志了。</li></ul><p>如果我们看到“可以出发”的标志，也就是a 200，那么我们可以检查我们的电子邮件，确保它看起来像我们预期的那样。如果我们有别的东西，我们需要做一些调试。面对错误时首先要检查的是什么？日志。但是原木住在哪里呢？对于每个Lambda调用，都有一个关联的<strong> CloudWatch </strong>日志流。以下是找到它的方法:</p><ol> <li>从AWS控制台导航到CloudWatch。</li> <li>点击<strong>日志</strong></li> <li>在“日志组名前缀”中输入“<em>/AWS/lambda/contact form lambda</em></li> <li>点击“<em>/AWS/lambda/contact form lambda</em></li></ol><p>一旦我们点击进入日志组，我们将看到我们的Lambda函数的日志流。最上面的是最近的调用。任何Lambda函数调用中的错误都会记录在日志流中。在日志流中，我们可以查看错误。搜索日志记录语句，并查看给定调用使用了多少内存和时间。因此，如果我们得到了除了200响应代码之外的任何东西，请通过检查日志来开始调试。如果日志没有揭示任何信息，那么我们应该检查我们设置的其余部分。需要注意的事项:</p><ul> <li>出乎意料的错别字</li> <li>没有将正确的IAM策略分配给正确的IAM角色</li> <li>Lambda函数配置错误–内存分配或时间分配不正确</li></ul><h2>启用CORS并发布您的API</h2><p>在您的功能API为狂野的西部做好准备之前，您还有一些最后的问题要解决。我们需要做的第一件事是在我们的API端点上启用<em>跨源资源共享(CORS) </em>。这将授予端点对我们指定的域的访问权限。最后一件事是将我们的API发布到公共平台。首先，让我们打开该端点的CORS:</p><ol> <li>从AWS控制台导航到API网关。</li> <li>点击<em>联系</em>API。</li> <li>点击<em> ContactFormLambda </em>资源。</li> <li>点击<strong>动作</strong></li> <li>选择<em>启用CORS </em></li> <li>在“<em>访问-控制-允许-来源</em>”中，输入您将从其呼叫该端点的网站的URL。如果您不确定，请将其保留为' * '，这将允许任何域。</li> <li>点击<strong>启用CORS… </strong></li> <li>点击<strong>是，替换现有值</strong></li></ol><p>启用CORS后，剩下的唯一事情就是将端点发布到一个<em>阶段</em>(也就是一个环境)。</p><ol> <li>从AWS控制台导航到API网关。</li> <li>点击<em>联系</em>API。</li> <li>点击<em> ContactFormLambda </em>资源。</li> <li>点击<strong>动作</strong></li> <li>点击<strong>部署API </strong></li> <li>从部署阶段选择<em>产品</em>。</li> <li>点击<strong>部署</strong></li></ol><p>一旦部署，我们的API现在就存在于<em> prod </em>环境中。我们将会有一个类似于<span> https:// &lt;的URL。execute-api.us-west-2.amazonaws.com/prod/ContactFormLambda</span></p><h2>综合</h2><p>至此，我们有了一个功能性的无服务器联系流程。API网关调用一个Lambda函数。该函数接收请求体，并通过简单的电子邮件服务发送出去。下一步是将您的这个新API集成到您选择的东西中。你可以从自己的网站或作品集页面开始。要集成它，创建一个表单，其字段与请求正文要求的字段相同——用户回复的电子邮件地址、主题和正文。在表单提交时，用JavaScript在请求体中添加一个快速AJAX请求，您就可以开始比赛了。<strong>更新:</strong>我们已经创建了一个后续指南，从我们离开这里的地方继续，并将服务集成到一个网页中。你可以在这里查看<a target="_blank" rel="nofollow noopener noreferrer" href="https://linuxacademy.com/blog/linux-academy/using-your-first-microservice-with-aws-lambda/"/>。</p><h2>结论</h2><p>AWS周围有大量的信息。以至于在试图学习它时很容易迷失。学习任何东西的最好方法是开始使用它。通过在实际问题中使用API Gateway、Lambda和SES，您已经了解了它们的概念。这是我第一次学习AWS的方式。作为一名认证的专业解决方案架构师，这是我至今仍在做的事情。如果你有任何问题，请随时联系我。如果你想通过创建更多这样的项目来了解AWS，可以看看我即将出版的书，<a target="_blank" rel="nofollow noopener noreferrer" href="https://www.kylegalbraith.com/learn-aws/">如何在Amazon Web Services上托管、交付和保护静态网站</a>。</p><hr/><p>通过在<a target="_blank" rel="nofollow noopener noreferrer" href="https://twitter.com/kylegalbraith"> Twitter </a>、<a target="_blank" rel="nofollow noopener noreferrer" href="https://www.linkedin.com/in/kylegalbraith459/"> LinkedIn </a>和<a target="_blank" rel="nofollow noopener noreferrer" href="https://medium.com/@kyle.galbraith"> Medium </a>上关注凯尔，跟上他正在进行的其他项目。</p></div></div>    
</body>
</html>