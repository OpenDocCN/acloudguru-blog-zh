<html>
<head>
<title>AWS VPC: Deploy A Serverless Multi Region Active Backend | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>AWS VPC:部署无服务器多区域活动后端|云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/adding-support-for-vpc-build-a-serverless-multi-region-active-active-backend-solution#0001-01-01">https://acloudguru.com/blog/engineering/adding-support-for-vpc-build-a-serverless-multi-region-active-active-backend-solution#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>一个被问了几次的问题:如何在亚马逊VPC(虚拟私有云)中部署无服务器的多区域、主动-主动后端<strong>？</strong>我想，如果我能进一步推进我们的方法，并改进解决方案来回答这些问题，那就太好了。</p><h2 id="h-what-is-a-vpc">什么是VPC？</h2><p>VPC提高了隐私和安全性，尤其是对于具有严格合规性和审计要求或敏感数据的应用。通常，您使用VPC，这样就无法从公共互联网访问VPC内部的资源。这些资源可以是AWS服务资源，比如您的数据仓库、缓存集群或数据库。</p><p id="9354">因为默认情况下，Lambda函数不能访问VPC中的资源，所以我们必须做一些额外的工作。</p><h2 id="h-how-to-permit-lambda-into-the-vpc">如何允许λ进入VPC？</h2><p id="52b4">为了允许您的Lambda函数访问您的VPC内部的资源，我们必须提供额外的特定于VPC的信息，例如VPC子网id和安全组id。该信息用于建立弹性网络接口<a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_ElasticNetworkInterfaces.html" target="_blank" rel="noreferrer noopener"> (ENI) </a>，该接口使得Lambda功能能够连接到VPC内的资源。</p><p id="4d59">此外，我们还需要启用DynamoDB <a href="https://acloudguru.com/hands-on-labs/create-a-vpc-endpoint-and-s3-bucket-in-aws"> VPC端点</a>并将我们的<a href="https://aws.amazon.com/blogs/aws/new-vpc-endpoints-for-dynamodb/"> VPC路由信息</a>添加到其中。</p><p id="af12"><strong> <em>注</em> </strong> <em>:为了多样性，我将从命令行界面(CLI)创建一切，但你当然也可以从控制台做一切🙂</em></p><p id="ab48">让我们开始吧！</p><p/><hr class="wp-block-separator"/><h2 class="has-text-align-center" id="h-level-up-your-career-in-the-cloud">提升您在云中的职业生涯</h2><p class="has-text-align-center">希望提升您的云计算职业生涯？免费与云专家一起开始，了解我们的实践方法如何帮助您掌握现代技术技能。</p><hr class="wp-block-separator"/><h2 id="e82c">建立VPC网络基础</h2><h3 id="48c2">第1步——创建我们的VPC</h3><p id="a199">当然，我们首先需要在我们想要部署后端的每个地区创建我们的VPC。在这个例子中，我将使用<strong>美国东部-1 </strong>和<strong>美国西部-2 </strong>地区。</p>  <p id="74ac">在<strong> us-west-2 </strong>地区做同样的事情。</p><h3 id="c42b">第2步—在每个VPC内部创建一个子网</h3>  <p id="863b"><strong> <em>注意:</em> </strong> <em>您可以在每个可用性分区中添加一个或多个子网，事实上，您应该这样做，因为这是最佳做法</em>。</p><p id="ead9">当然，我们需要为<strong> <em> us-west-2 </em> </strong>地区做同样的事情。</p><h3 id="09ce">步骤#3 —获取每个VPC的路由信息</h3>  <p>在<strong> <em> us-west-2 </em> </strong>地区重复此操作，并将“<strong> RouteTableId </strong>”字段信息放在身边，因为您稍后会用到它。</p><hr class="wp-block-separator"/><h2 id="a4c5">创建DynamoDB全局表</h2><p id="75d5">这与我上一篇文章中的<a href="http://step%20/#1:%20Creating%20a%20Global%20Table%20in%20DynamoDB" target="_blank" rel="noreferrer noopener"> <em>步骤#1:在DynamoDB </em>中创建一个全局表非常相似:</a></p>  <p id="308b">很好，现在我们有了一个全局表，可以从VPC … <strong>中的Lambda函数访问它，是这样吗？</strong></p><p id="07d6">嗯……不！！！我们的默认DynamoDB全局表还不在VPC，所以它被视为公共互联网。既然我们已经将Lambda函数配置为在VPC内部运行，我们需要为DynamoDB创建一个我们称之为<a href="https://aws.amazon.com/blogs/aws/new-vpc-endpoints-for-dynamodb/" target="_blank" rel="noreferrer noopener">的VPC端点</a>。</p><p id="e792">dynamidb已经提供了数据保护和安全性，使用TLS端点进行传输加密、<a href="https://github.com/awslabs/aws-dynamodb-encryption-java" target="_blank" rel="noreferrer noopener">客户端加密库</a>、以及使用AWS身份和访问管理(IAM)<strong>的细粒度访问控制，那么我们为什么要为dynamidb使用VPC端点呢？</strong></p><p id="248d">简而言之，它进一步提高了隐私和安全性，特别是对于具有严格合规性和审计要求或处理敏感数据的应用程序。</p><p id="99ea">事实上，如果您从VPC连接到DynamoDB，您不再需要互联网网关或NAT网关，因此您的VPC保持关闭并与公共互联网隔离。VPC端点还提供简化的网络配置，使您无需设置和维护防火墙来保护您的VPC免受网络攻击。</p><blockquote class="wp-block-quote"><p><strong>更高的安全性=更满意的客户</strong></p></blockquote><h3 id="a950">步骤4——为DynamoDB创建一个VPC端点</h3>  <h3 id="9b32">步骤#5 —将VPC路由添加到DynamoDB端点</h3><p id="7be9">这里我们需要添加之前返回给命令的"<strong><em>【RoutingTableId】</em></strong>"值。</p>  <p id="6191">太好了！现在，我们的DynamoDB全局表可以从我的VPCs中访问。</p><p id="b073"><strong> <em>注意</em> </strong> <em>:当然，我们需要为每个区域复制命令🙂</em></p><hr class="wp-block-separator"/><h3 id="8abe">使用部署在VPC中的API网关和AWS Lambda函数创建后端</h3><p id="4651">后台功能和我上一篇文章中的<a href="https://read.acloud.guru/building-a-serverless-multi-region-active-active-backend-36f28bed4ecf" target="_blank" rel="noreferrer noopener">一样，这里没有改动；我们还有一个<strong>获取</strong> <em>物品id </em>，一个<strong>发布</strong> <em>物品id </em>和一个<strong>获取</strong> <em>生命值</em>。</a></p>  <p id="cbb5">改变的<strong>是用于在VPC中部署Lambda函数和配置API网关的<strong> <em>无服务器</em> </strong>框架<strong/>模板。</strong></p><p id="a47e">然而，在我们这样做之前，我们需要在每个区域为我们的Lambda函数创建安全组。下面是默认的<strong> <em>入站</em> </strong>和<strong> <em>出站</em> </strong>规则的安全组配置为我的一个VPC。注意到<strong> <em>入站</em> </strong>规则在源中引用了它自己吗？</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/32cf380bd92f330efde50f0a717d45ef.png" alt="" class="wp-image-41727" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_BCLafb4SAjEFLKidmG3fjA.png"/></figure><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/52e760af856cb8df614b1fbc2968e604.png" alt="" class="wp-image-41725" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/1_-J7WcHaw5pkCbLJqVH7KLg.png"/></figure><p id="1ad4"><strong> <em>注意</em> </strong> <em>:您为某个功能选择的安全组将控制该功能对子网内和互联网上的资源的访问。所以可以随意修改。</em></p><p id="0605">现在，我们可以使用<strong> <em>无服务器</em> </strong>框架更新部署后端所需的<em>_ _ all _ _</em>VPC字段，由于我不想管理每个地区的模板，我将使用框架支持的<a href="https://serverless.com/framework/docs/providers/aws/guide/variables/" target="_blank" rel="noreferrer noopener">变量</a>，因为它们允许用户动态替换<strong> <em>无服务器. yml </em> </strong>文件中的配置值。</p>  <p id="c0cc">请注意模板的VPC部分，以及我如何使用cool变量语法根据我部署的地区将地区信息传递给配置？</p><blockquote class="wp-block-quote"><p><strong> ${file(env_${opt:region}。yml):lambdaExecSecurityGroups }</strong></p></blockquote><p id="ba29"><strong> <em>注意</em> </strong> <em>:请确保将</em><a href="https://gist.github.com/adhorn/cab4b461f46cc66f27d49e1de4230c7f" target="_blank" rel="noreferrer noopener"><em>server less . yml</em></a><em>文件中的“xxxxxxxxxxxxx”替换为您之前创建DynamoDB表时使用的AWS帐户ID以及env文件中的正确子网和安全组ID。</em></p><p id="5220">在<strong> <em> us-east-1 </em> </strong>和<strong> <em> us-west-2 </em> </strong>中部署API，其中部署了带有VPC端点的DynamoDB全局表。</p>  <p id="a948">其余的都不会改变——所以你可以从我之前的博客文章中的“第三步:创建自定义域名”开始，一路走下去🙂</p><p id="55cf">瞧啊。希望你喜欢这个小小的<strong> <em>安可。</em> </strong>我计划再多几个..敬请关注！</p><p id="ff47">阿德里安</p></div></div>    
</body>
</html>