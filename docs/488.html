<html>
<head>
<title>Deploy Terraform Pipeline with Policy As Code to Secure Your Multi Cloud | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>部署Terraform Pipeline，将策略作为代码来保护您的多云|云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/securing-your-multi-cloud-terraform-pipelines-with-policy-as-code#0001-01-01">https://acloudguru.com/blog/engineering/securing-your-multi-cloud-terraform-pipelines-with-policy-as-code#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>多年来，我们的许多组织都依赖政策、程序和工作说明来实现<a href="https://acloudguru.com/blog/business/compliance-is-cumbersome-but-cloud-can-help">云合规性</a>和最大限度的保证。已经建立了审查委员会、变更委员会和类似的团队来审查和批准提议的变更，管理内部治理标准，并审核对it基础架构所做的变更。</p><p>在自动化、扫描和协作工具普及之前，变更审查流程是手动的，可能需要大量的时间投入。现在的结果之一是，在请求(提议)变更和实施变更之间可能会有长时间的延迟。</p><p>尽管这种方法太常见了，但它很少能带来“云规模”的敏捷性或响应能力。结果就是我亲切地称之为“糟糕”是的，这些控制增加了我们的安全姿态，但这种体验很糟糕。</p><h3 id="h-how-to-secure-your-cloud-infrastructure">如何保护您的云基础架构？</h3><p>今天，我们有过多的工具和平台。这些工具包括从开源到完全支持的商业SaaS应用程序。我们还需要管理各种各样的基础架构平台，包括公共云、私有云以及传统的内部基础架构(在云环境中，我应该称之为“传统基础架构”吗？).在这些系统中，您有传统的裸机系统、虚拟机、<a href="https://acloudguru.com/blog/engineering/10-docker-security-best-practices-to-cut-container-chaos">容器</a>、无服务器等。每种“风格”都有各种可用的编排和管理平台。</p><p>许多组织结合了不同的技术，有效地采用了最佳方法，例如:</p><ul><li>公共云(多个提供商)</li><li>私有云</li><li>传统内部部署(利用虚拟化和非虚拟化基础架构，有时使用多个虚拟机管理程序)</li></ul><p>这并不是说以上是不好的，只是有很多不一致和移动的部分。同类最佳有很多优势，但缺点之一是它会导致<strong>更高的复杂性</strong>。仅仅是将不同的平台集成在一起，使它们能够有效地相互交流就可能是一个挑战。然后查看所有操作复杂性(修补、漏洞管理等。)，很明显，我们需要比更统一、更标准化的方法更多的技能。</p><p>同样，同类最佳可以为组织提供最大的价值，但组织必须权衡与之相关的成本。成本不仅仅围绕许可、硬件和供应商维护协议，还包括运营需求和效率。</p><p>这个问题的任何解决方案都需要支持各种各样的平台。它应该是可扩展的，并支持大量的集成。为了避免重复发明轮子，让我们检查一下我们过去是如何做事的。也许我们可以为今天重新使用(或改编)过去曾经有效的东西。</p><p>快速提醒:我应该提到我在甲骨文公司工作。我在开发人员关系团队中领导开发人员的工作。因此，我将在这里使用一些Oracle云基础设施(OCI)术语。这些原则很大程度上是可移植的，如果你和不同的云提供商合作过，这些原则可能会很直观(如果不熟悉的话)。为OCI插上一个响亮的插头，如果你还没有试过，你应该试试。<a href="https://www.oracle.com/cloud/free/?source=:ex:pw:::::ACloudGuru&amp;SC=:ex:pw:::::ACloudGuru&amp;pcode=">立即注册</a>获得一个永远免费的甲骨文云账户！</p><h3 id="h-going-back-to-our-roots">追根溯源…</h3><p>让我们沿着记忆之路再走一趟。这是有道理的，忍耐一下！我们的IT基础架构过去主要由交换机、路由器、防火墙、服务器和存储组成。尽管事情变得更简单了(无论如何，在某些方面)，我们仍然有和今天一样的担忧。我们如何阻止不良/未经授权的用户？我们如何让好的/授权的用户进来？即使他们是授权用户，我们如何确保他们只能访问和/或更改他们需要(应该)更改的内容？</p><p>多年来，我们用AAA保护我们重要的基础设施(路由器、交换机和防火墙)。AAA代表<strong>认证、授权和责任。</strong>当然，这也有许多不同的变体(使用不同的名称或术语)，但不管供应商是谁，基本方面都是基本相同的。</p><p><strong>认证</strong>主要是确认你就是你所说的那个人。<strong>授权</strong>确保你只能做你被授权做的事情。<strong>责任</strong>与记录和审查审计日志有关，记录(和查看)谁在何时何地做了什么。</p><p>在过去的几年中，RADIUS和TACACS+等协议一直用于设备和管理系统(RADIUS或TACACS+服务器)之间的通信。许多现代系统(尤其是云平台)可能不支持RADIUS或TACACS+，但我们可以从过去汲取相似之处和概念，并将其应用于现在(和未来)。</p><figure class="wp-block-table"><table><tbody><tr><td><br/></td><td><strong>传统</strong></td><td><strong>云</strong></td></tr><tr><td><strong>认证</strong></td><td>RADIUS/TACACS+，已加入Active Directory或其他LDAP目录。</td><td>IAM，与IdM/国内流离失所者联盟</td></tr><tr><td><strong>授权</strong></td><td>RADIUS/TACACS+，配置的角色/配置文件规定了可以/不可以做什么。</td><td>IAM策略</td></tr><tr><td><strong>问责</strong></td><td>RADIUS/TACACS+和设备日志转发到SIEM/SIMS</td><td>审计日志</td></tr></tbody></table></figure><p>哇，看看上面的对比，可能感觉我们的工作完成了。让我们确保我们联合起来，拥有正确的IAM策略，并且我们在现代云世界中蓄势待发。让我们拍拍自己的背吧！没那么快…</p><h3 id="h-what-s-wrong-with-iam">我怎么了？</h3><p>我真的没什么问题。但是，我们需要认识到，IAM不是一个放之四海而皆准的解决方案。看看下面的场景，看看IAM的不足之处:</p><figure class="wp-block-table"><table><tbody><tr><td><strong>场景</strong></td><td>IAM控件？</td></tr><tr><td>用户A希望在虚拟云网络(VCN)中创建新的子网。</td><td>是</td></tr><tr><td>应该只允许用户A在VCN创建私有子网。</td><td>不</td></tr><tr><td>用户A希望在其子网中创建新的计算实例。</td><td>是</td></tr><tr><td>用户A应该仅对任何计算实例使用白名单中的计算映像。</td><td>不</td></tr></tbody></table></figure><p>上面的列表只是云中可能发生的事情的一小部分。虽然这不是一个详尽的列表，但是很容易看出，对于我们的问题，IAM并不是一个完美的解决方案。</p><p>IAM关注的是你在云平台上能做/不能做的“大块”。它不关心积木的颜色，或者积木上可能有什么样的装饰等等。对于云，IAM通常不关心详细的属性。IAM非常适合为云管理的不同方面配置不同的角色。例如，您可以轻松创建一个网络角色，授予该角色管理子网、路由表、安全列表和虚拟云网络(vcn)的能力。<a href="https://acloudguru.com/blog/engineering/fixing-5-common-aws-iam-errors"> IAM不允许您基于更具体的属性</a>来控制访问，例如资源的名称、允许的(或列入黑名单的)路由目标(对于路由表规则)、允许的CIDRs(在安全列表中配置)等。</p><figure class="wp-block-image"><img loading="lazy" src="../Images/d36432d00e5bdc3702fdc7b201cf2e3c.png" alt="AWS IAM vs GCP IAM vs Azure IAM" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/03/21.03.05.Rosetta-IAM.jpg"/><figcaption><em>IAM confused? Our new deep dive <a href="https://acloudguru.com/blog/engineering/comparing-aws-azure-and-google-cloud-iam-services">breaks down the differences</a> between AWS, GCP, and Azure’s flavors of IAM.</em></figcaption></figure><h3 id="h-but-that-s-what-other-cloud-security-services-are-for">但这正是其他云安全服务的目的！</h3><p>在某种程度上，的确如此。许多云提供商提供的安全服务不仅仅是简单的IAM。OCI也不例外，<a href="https://docs.oracle.com/en-us/iaas/security-zone/using/security-zones.htm">安全区</a>只是OCI的一项服务，有助于减轻上述风险和担忧。如果每个人都只使用OCI(多么伟大的想法！)，本文可以到此为止。但是，在一个有多个云提供商的世界里，我们该怎么做呢？虽然IAM在云提供商之间很大程度上是相似的，但是提供我们需要的额外的详细授权级别的附加安全服务在不同的平台之间会有很大的不同。云服务就像云提供商一样广泛多样。</p><p>我们可以<strong>利用每个云提供商的安全服务</strong>来帮助支撑我们的安全态势。这当然是一个理想的最终状态。这里的部分挑战是不同云提供商之间缺乏功能对等。根据功能的不同，我们可能会也可能不会保证每个环境都在我们设定的范围内。即使在所有正在使用的云平台上都存在全功能对等的情况下，每个不同的云平台都需要专业知识来实现这一理想的最终状态。这意味着实现这一目标需要人员、时间和金钱(假设每个云平台都有足够的原生功能)。</p><p>我们应该利用OCI(和任何其他云平台)内可用的所有内置本机安全功能，但是，在多云环境中，这可能是一座需要一次攀登的陡峭山峰。这就是采用爬-走-跑方法的好处。要在一个多云世界中启动一个更强大的安全态势，需要…</p><h3 id="h-what-is-policy-as-code-pac">什么是作为代码的策略(PaC)？</h3><p><strong>策略即代码(PaC) </strong>是一种定义不同角色工作边界的方法。这些边界可以表示为允许列表(仅允许特定的属性/值)、阻止列表(允许除特定的值/属性集之外的所有内容)或其任意组合。</p><p>PaC通常最好与基础设施即代码(IaC)一起使用。这是因为IaC已经给出了如何以编程(通常是声明性的)方式与我们的基础设施交互的定义。PaC可以读取代码并评估它是否符合给定策略，从而决定它是否符合策略。</p><p>与IaC紧密集成是一件好事，因为我们大多数人已经在用代码(比如HashiCorp Terraform)管理我们的环境。只要对“我应该使用IaC吗？”给出一个笼统的“是”回答就足够了问题通常是正确的答案。</p><p>这么多选择…</p><h3 id="h-so-many-choices">有许多PaC解决方案可供选择，因为有许多IaC平台可供选择。一个值得强调的PaC解决方案是<a href="https://www.openpolicyagent.org/">开放策略代理(OPA) </a>，它是CNCF(开源)的一部分，适用于许多用例。HashiCorp <a href="https://www.terraform.io/"> Terraform </a>很容易利用OPA，使其对许多组织具有即时价值(因为Terraform被广泛使用)。在为您的组织选择一个PaC解决方案之前，值得花时间评估您的选择。</h3><p>从我们现在的地方开始</p><figure class="wp-block-image"><a href="https://acloudguru.com/blog/engineering/the-ultimate-terraform-cheatsheet"><img loading="lazy" src="../Images/079f543cc60333160171f62053f9585d.png" alt="Terraform Cheatsheet" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/11/Terraforming_BlogHeader.jpg"/></a><figcaption><em>No need to run in terror from Terraform. Download our <a href="https://acloudguru.com/blog/engineering/the-ultimate-terraform-cheatsheet">Ultimate Terraform Cheatsheet</a> for a handy guide to helpful syntax.</em></figcaption></figure><h3 id="h-starting-where-we-re-at">在组织中，要么在他们的管道中没有控制，要么依赖于提交代码的人工审查/批准，这种情况太普遍了。看看一个使用HashiCorp Terraform的组织，这两种情况中有一种是典型的。没有任何控制的简单地形管道:</h3><p>当Terraform代码提交给Git repo时(或者更具体地说，当提交拉/合并请求时)，它会触发管道运行。请注意，实际上没有验证(除了每个云的IAM支持的以外)？<em>地形图</em>的输出作为管道运行日志的一部分被捕获，这确实给了我们一点关于环境变化的背景。然而，这确实需要手动审查，而不是预防性控制(更像是审计控制)。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/0b7a66cbf4e56ec674f08a496e99a9f7.png" alt="" class="wp-image-48780" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1316/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image.png 1316w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image.png 768w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_380/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image.png 380w" sizes="(max-width: 1316px) 100vw, 1316px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image.png"/></figure><p>下图显示了一个简单的管道，在该管道中可以手动检查更改:</p><p>至少在这种情况下，有某种手动控制，但这通常会导致糟糕的结果(缓慢、糟糕的用户体验，并且容易出错)。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/af9fa32df8aa83de1b87f5f9bd9bbaa1.png" alt="" class="wp-image-48781" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1316/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-1.png 1316w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-1.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_1024/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-1.png 1024w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-1.png 768w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_380/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-1.png 380w" sizes="(max-width: 1316px) 100vw, 1316px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-1.png"/></figure><p>这两种选择都不理想。让我们看看如何用PaC来改进这一点。</p><p>PaC可能是什么</p><h3 id="h-what-it-might-be-with-pac">以下是我们可能想要努力的方向:</h3><p>这里的主要区别是增加了<em> Compliant？</em>管道中的决策点。这是一个过于简化/高层次的观点，但是它允许我们验证用户提交的代码，并确保它符合我们的组织标准。如果它不在我们的标准之内，用户将被警告(自动管道抛出一个或多个错误)，并有机会更新他们的代码并重新提交。在提交的代码是兼容的情况下，变更将不受阻碍地进行。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/cbe57dcf8ae56d6e8e55a802261b381e.png" alt="" class="wp-image-48782" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_936/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-2.png 936w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-2.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-2.png 768w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_380/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-2.png 380w" sizes="(max-width: 936px) 100vw, 936px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-2.png"/></figure><p>这种方法的一个关键优势是，无论我们是只使用OCI还是OCI以及其他几个云平台，安全策略都会保护我们。此外，要设置它，只需要很少的特定于平台的领域专业知识。理想情况下，安全、合规或另一个指定团队将定义和管理每个云平台上允许(和不允许)的内容。</p><p>下面是一个更详细的示例工作流，它使用OPA来确定提交的Terraform (TF)代码是否可接受:</p><p>这就是我们所认为的应有的一切吗？不，一点也不。</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/86dba061da644c7beeb7460f9458e5cb.png" alt="" class="wp-image-48783" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_936/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-3.png 936w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-3.png 300w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_768/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-3.png 768w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_380/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-3.png 380w" sizes="(max-width: 936px) 100vw, 936px" data-original-src="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/04/image-3.png"/></figure><p>采用这种方法，存在一个“门”(控制)，可以在对环境进行任何更改之前<em>做出进行/不进行决策。这有助于确保提议的基础架构更改符合组织标准(如OPA策略中所定义的)。用户可以获得即时反馈，并能够快速行动，同时保持对环境的高度保证。</em></p><p>我们为什么要再做一次？</p><h3 id="h-why-did-we-do-this-again">我们在内存领域走了几趟，进了几个兔子洞，但结果是PaC是一致管理多云环境的理想方式(当使用HashiCorp Terraform或类似的跨平台IaC解决方案时)。PaC提供了一种方法，可以高度保证我们的公司政策得到遵守。这可以在不牺牲执行速度或不需要大量持续时间投资的情况下完成(一旦创建了PaC策略，就可以使用PaC来重复验证代码提交)。</h3><p>有了安全措施，我们可以安全地允许团队管理他们自己的基础设施，知道PaC将帮助我们保持合规性。通过使用集成的自动化管道，用户可以获得几乎即时的结果，这提高了团队(和组织)的敏捷性和响应能力。我们已经使我们的组织能够做他们需要做的事情，而不影响我们的安全态势。我们已经成功地从糟糕走向安全。这对每个人都是双赢的！</p><p><em>想成为<a href="https://acloudguru.com/course/hashicorp-certified-terraform-associate">哈希公司认证的Terraform助理</a>？<a href="https://acloudguru.com/pricing">开始免费试用云专家</a>，参加数百门云认证课程，以及1，500个动手实验室、模拟考试等。</em></p><hr class="wp-block-separator"/><p class="has-text-align-center"><em>Looking to become a <a href="https://acloudguru.com/course/hashicorp-certified-terraform-associate">Hashicorp Certified Terraform Associate</a>? <a href="https://acloudguru.com/pricing">Start your free trial of A Cloud Guru</a> and get access to hundreds of cloud certification courses, plus 1,500 hands-on labs, practice exams, and more.</em></p></div></div>    
</body>
</html>