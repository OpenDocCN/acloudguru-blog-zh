<html>
<head>
<title>Using Redis on Cloud? Here are ten things you should know | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在云上使用Redis？以下是你应该知道的十件事</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/how-to-use-redis-on-cloud#0001-01-01">https://acloudguru.com/blog/engineering/how-to-use-redis-on-cloud#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>大规模操作有状态分布式系统是很难的，Redis也不例外。托管数据库通过承担大量繁重的工作使生活变得更容易，但是您仍然需要一个良好的体系结构并应用最佳实践——无论是在服务器(Redis)上还是在客户机(应用程序)上。</p><p>这篇博客文章涵盖了一系列与Redis相关的最佳实践、技巧和诀窍，包括集群可伸缩性、客户端配置、集成和指标。虽然我会不时地引用亚马逊memory db T1和T2 elastic cache T3来描述Redis，但是大多数(如果不是全部)都适用于Redis集群。</p><p>这绝不意味着是一份详尽的清单。我只是选择了10，因为这是一个很好的，有益健康的数字！</p><p>让我们直入主题，从您在扩展Redis集群方面有哪些选择开始。</p><hr class="wp-block-separator" id="block-54e868af-ff0f-4e59-9487-1fd74fbbdd2a"/><p class="has-text-align-center" id="h-your-keys-to-a-better-career"><strong>通往更好职业的钥匙</strong></p><p class="has-text-align-center"><a href="https://acloudguru.com/pricing">立即开始ACG </a>通过AWS、Microsoft Azure、Google Cloud等领域的课程和实际动手实验室来改变你的职业生涯。</p><hr class="wp-block-separator" id="block-da0c2ec3-2040-4ea3-978a-a2c48f63678b"/><h2 id="h-1-scalability-options"><strong> 1。可扩展性选项</strong></h2><p>你可以将<em>放大</em>或者将<em>缩小</em>:</p><ul><li>纵向扩展(纵向)–您可以增加单个节点/实例的容量，例如从<a href="https://aws.amazon.com/ec2/instance-types/" target="_blank" rel="noreferrer noopener">亚马逊EC2 </a> <code>db.r6g.xlarge type</code>升级到<code>db.r6g.2xlarge</code></li><li>横向扩展(水平)–您可以向群集中添加更多节点</li></ul><p>将<em>向外扩展</em>的需求可能由几个原因驱动。</p><p>如果您需要处理<em>读取繁重的</em>工作负载，您可以选择添加更多副本节点。这适用于Redis集群设置(如<code>MemoryDB</code>)或非集群主副本模式，如集群模式禁用的<a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/Replication.Redis-RedisCluster.html" target="_blank" rel="noreferrer noopener">elastic cache</a>。</p><p>如果您想增加<em>写</em>容量，您会发现自己受到主副本模式的限制，应该选择基于Redis集群的设置。您可以增加集群中碎片的数量——这是因为只有主节点可以接受写入，并且每个碎片只能有一个主节点。</p><p>这还具有提高整体高可用性的额外好处。</p><figure class="wp-block-image"><img loading="lazy" src="../Images/bde5c15de53d114530a4944be355259d.png" alt="" data-original-src="https://lh5.googleusercontent.com/8rxqHosu3Fwv27XFiPWV3weoNTYh-UilKyoM4vnx3wbvDD3TBAAjfbv-bpLMvQCFoFL_L2HUQF4USJ2UVMFf4wO-zeJymPcv5PhzcsIcGd0zr_aqFYtZrYVt0SRmzxifE_bwbKVHqqhHYSSshrDFpju4cF5VShPn7q5H8vMwS7Gj--RKVyhxQRv9tw"/></figure><p><em>图1: Redis(禁用集群模式)和Redis(启用集群模式)集群——Redis文档的ElastiCache】</em></p><h2><strong> 2。在扩展您的集群之后，您最好使用这些副本！</strong></h2><p>大多数Redis集群客户端(包括<code>redis-cli</code>)的默认行为是将所有<em>读取</em>重定向到<em>主</em>节点。如果您添加了读取副本来扩展读取流量，它们将处于闲置状态！</p><p>您需要切换到<a href="https://redis.io/commands/readonly/" target="_blank" rel="noreferrer noopener"> READONLY </a>模式，以确保处理所有读取请求的副本不仅仅是被动的参与者。确保正确配置Redis客户端——这将因客户端和编程语言而异。</p><p>例如，在<a href="https://github.com/go-redis/redis" target="_blank" rel="noreferrer noopener"> Go Redis客户端</a>中，您可以将<code>ReadOnly</code>设置为true:</p><pre class="wp-block-code"><code>client := redis.NewClusterClient(
	&amp;redis.ClusterOptions{
		Addrs:     []string{clusterEndpoint},
		ReadOnly:  true,
		//..other options
	})
</code></pre><p>要进一步优化，还可以使用<code>RouteByLatency</code>或<code>RouteRandomly</code>，两者都会自动开启<code>ReadOnly</code>模式。</p><p><em>你可以参考一下</em> <a href="https://lettuce.io/core/release/reference/index.html#readfrom.read-from-settings" target="_blank" rel="noreferrer noopener"> <em> Java客户端比如莴苣</em> </a></p><h2><strong> 3。使用读取副本时要注意一致性特征</strong></h2><p>您的应用程序可能会从副本中读取陈旧数据——这是<em>最终一致性</em>在起作用。由于主节点到副本节点的复制是<em>异步</em>，因此您发送到主节点的写入可能尚未反映在读取的副本中。</p><p>当您有大量读取副本时，尤其是跨多个可用性分区时，很可能会出现这种情况。如果这对于您的用例来说是不可接受的，那么您将不得不求助于使用主节点进行读取。</p><p>MemoryDB或ElastiCache for Redis中的<a href="https://docs.aws.amazon.com/memorydb/latest/devguide/metrics.memorydb.html" target="_blank" rel="noreferrer noopener"> ReplicationLag指标</a>可用于检查副本在应用主节点的更改方面落后多少(以秒为单位)。</p><h3><strong>强一致性呢？</strong></h3><p>在<code>MemoryDB</code>、<a href="https://docs.aws.amazon.com/memorydb/latest/devguide/consistency.html" target="_blank" rel="noreferrer noopener">的情况下，主节点的读数是强一致的</a>。这是因为客户端应用程序只有在写入(到主节点)到<em>持久多AZ事务日志</em>之后才会收到成功的写入确认。</p><h2><strong> 4。请记住，您可以影响您的键在Redis集群中的分布方式</strong></h2><p>Redis没有使用一致散列(像许多其他分布式数据库一样)，而是使用散列槽的概念。总共有16384个槽，散列槽的范围被分配给集群中的每个主节点，并且每个键属于特定的散列槽(从而被分配给特定的节点)。如果键属于不同的哈希槽，在Redis集群上执行的多键操作将无法工作。</p><p>但是，你并不完全受集群的支配！可以通过使用<em>散列标签</em>来影响密钥的放置。因此，您可以确保特定的键具有相同的哈希槽。</p><p>例如，如果您将客户ID 42的订单存储在名为<code>customer:42:orders</code>的散列中，将客户概要信息存储在<code>customer:42:profile</code>中，那么您可以使用花括号{}来定义将被散列的特定子串。</p><p>在这种情况下，我们的键是<code>{customer:42}:orders</code>和<code>{customer:42}:profile</code>—<code>{customer:42}</code>现在驱动散列槽的放置。现在我们可以确信这两个键都在同一个散列槽中(因此是同一个节点)。</p><h2><strong> 5。你考虑过缩小规模吗？</strong></h2><p>你的应用是成功的，它有很多用户和流量。您横向扩展了集群，但事情仍然进展顺利。厉害！</p><h3>但是如果你需要缩减规模呢？</h3><p>在这样做之前，您需要注意几件事情:</p><ul><li>每个节点上都有足够的空闲内存吗？</li><li>非高峰时段可以这样吗？</li><li>它将如何影响您的客户端应用程序？</li><li>在此阶段，您可以监控哪些指标？(如<code>CPUUtilization</code>、<code>CurrConnections</code>等。)</li></ul><p>参考MemoryDb for Redis文档中的一些<a href="https://docs.aws.amazon.com/memorydb/latest/devguide/best-practices-online-resharding.html" target="_blank" rel="noreferrer noopener">最佳实践，以更好地规划扩展。</a></p><h2><strong> 6。当事情出错时…</strong></h2><p>面对现实吧，失败是令人羡慕的。重要的是你是否为他们做好了准备？对于Redis集群，需要考虑以下几点:</p><ul><li>面对失败，您是否测试过您的应用/服务行为？如果没有，请做！使用MemoryDB和ElastiCache for Redis，您可以利用<a href="https://docs.aws.amazon.com/memorydb/latest/devguide/autofailover.html#auto-failover-test" target="_blank" rel="noreferrer noopener">故障转移API </a>来模拟主节点故障并触发故障转移。</li><li>您有副本节点吗？如果您只有一个带有单个主节点的碎片，那么如果该节点出现故障，您肯定会停机。</li><li>你有多个碎片吗？如果您只有一个碎片(包含主碎片和副本碎片)，那么在该碎片的主节点出现故障的情况下，群集将无法接受任何写入。</li><li><strong>您的碎片是否跨越多个可用性区域？如果你有跨多个AZ的碎片，你将更好地准备处理AZ故障。</strong></li></ul><p>在所有情况下，MemoryDB确保在节点替换或故障转移期间不会丢失数据</p><h3><strong>无法连接Redis，求助！</strong></h3><p><em>Tl；DR:可能是网络/安全配置</em></p><p>这是一件经常让人犯错的事情！使用MemoryDB和ElastiCache，您的<a href="https://docs.aws.amazon.com/memorydb/latest/devguide/vpcs.html" target="_blank" rel="noreferrer noopener"> Redis节点在一个VPC </a>中。如果您有一个部署到计算服务的客户端应用程序，如<a href="https://docs.aws.amazon.com/lambda/latest/dg/welcome.html" target="_blank" rel="noreferrer noopener"> AWS Lambda </a>、<a href="https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html" target="_blank" rel="noreferrer noopener"> EKS </a>、<a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/Welcome.html" target="_blank" rel="noreferrer noopener"> ECS </a>、<a href="https://docs.aws.amazon.com/apprunner/latest/dg/what-is-apprunner.html" target="_blank" rel="noreferrer noopener"> App Runner </a>等。，您需要确保您拥有正确的配置，特别是在VPC和安全组方面。</p><p>这可能因您使用的计算平台而异。例如，你如何<a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html" target="_blank" rel="noreferrer noopener">配置一个Lambda函数来访问VPC </a>中的资源，与App Runner如何做(通过一个<a href="https://docs.aws.amazon.com/apprunner/latest/dg/network-vpc.html" target="_blank" rel="noreferrer noopener"> VPC连接器</a>)或者甚至EKS(尽管从概念上来说，它们是相同的)相比，会有些许不同。</p><h2><strong> 8。Redis 6带有访问控制列表——使用它们！</strong></h2><p>没有理由不对您的Redis群集应用身份验证(用户名/密码)和授权(基于ACL的权限)。<code>MemoryDB</code>符合Redis 6，且<a href="https://docs.aws.amazon.com/memorydb/latest/devguide/clusters.acls.html" target="_blank" rel="noreferrer noopener">支持ACL </a>。然而，为了与旧的Redis版本保持一致，它为每个帐户配置了一个<em>默认</em>用户(用户名为<strong>默认</strong>)和一个不可变的ACL，称为开放访问。如果您创建了一个<code>MemoryDB</code>集群并将其与该ACL相关联:</p><ul><li>客户端可以连接<em>而无需</em>认证</li><li>客户端可以在任何键上执行<em>任何</em>命令(也没有权限或授权)</li></ul><p>作为最佳实践:</p><ul><li>定义显式ACL</li><li>添加用户(以及密码)，以及</li><li>根据您的安全要求配置访问字符串。</li></ul><p>您应该监控身份验证失败。例如，MemoryDB中的<a href="https://docs.aws.amazon.com/memorydb/latest/devguide/metrics.memorydb.html" target="_blank" rel="noreferrer noopener"> AuthenticationFailures </a>指标为您提供了失败的身份验证尝试的总数——设置警报以检测未授权的访问尝试。</p><h3><strong>别忘了外围安全</strong></h3><p>如果您已经在服务器上配置了TLS，不要忘记在您的客户机上也使用它！例如，使用Go Redis:</p><pre class="wp-block-code"><code>client := redis.NewClusterClient(
	&amp;redis.ClusterOptions{
		Addrs:     []string{clusterEndpoint},
		TLSConfig: &amp;tls.Config{MaxVersion: tls.VersionTLS12},
		//..other options
	})
</code></pre><p>不使用它会给你带来不太明显的错误(比如一个普通的<code>i/o timeout</code>)并使事情难以调试——这是你需要小心的事情。</p><h2><strong> 9。有些事情你不能做</strong></h2><p>作为托管数据库服务，MemoryDB或elastic cache<a href="https://docs.aws.amazon.com/memorydb/latest/devguide/restrictedcommands.html" target="_blank" rel="noreferrer noopener">限制对某些Redis命令</a>的访问。例如，你<em>不能</em>使用<a href="https://redis.io/commands/cluster/" target="_blank" rel="noreferrer noopener">集群</a>相关命令的子集，因为集群管理(缩放、分片等。)是由服务本身负责的。</p><p>但是，在某些情况下，你也许可以找到替代方案。以监控运行缓慢的查询为例。虽然您<em>无法使用<a href="https://redis.io/commands/config-set/" target="_blank" rel="noreferrer noopener">配置集</a>对<code>latency-monitor-threshold</code>进行</em>配置，但是您可以在<a href="https://docs.aws.amazon.com/memorydb/latest/devguide/components.html#whatis.components.parametergroups" target="_blank" rel="noreferrer noopener">参数组</a>中设置<code>slowlog-log-slower-than setting</code>，然后使用<code>slowlog</code> get对其进行比较。</p><h2>10。使用连接池</h2><p>您的Redis服务器节点(即使是强大的节点)资源有限。其中之一是支持一定数量的并发连接的能力。大多数redis客户机提供连接池，作为有效管理Redis服务器连接的一种方式。重用连接不仅有利于Redis服务器，而且由于开销更少，客户端性能也得到提高——这在高容量场景中非常重要。</p><p>ElastiCache为<a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/CacheMetrics.Redis.html" target="_blank" rel="noreferrer noopener">提供了一些您可以跟踪的指标</a>:</p><ul><li><code>CurrConnections</code>:客户端连接的数量(不包括读取副本的数量)</li><li><code>NewConnections</code>:特定时间段内服务器已经接受的连接总数。</li></ul><h2><strong> 11。(奖励)使用合适的连接模式</strong></h2><p>这是一个显而易见的错误，但我还是要把它说出来，因为这是我见过的最常见的“入门”错误之一。</p><p>您在客户端应用程序中使用的连接模式将取决于您是否使用独立的Redis设置，即Redis集群(很可能)。大多数Redis客户对它们进行了明确的区分。例如，如果您使用的是启用了<code>MemoryDB</code>或<code>Elasticache</code>集群模式的<a href="https://github.com/go-redis/redis" target="_blank" rel="noreferrer noopener"> Go Redis客户端</a>，则需要使用<a href="https://pkg.go.dev/github.com/go-redis/redis#NewClusterClient" target="_blank" rel="noreferrer noopener"> NewClusterClient </a>(不是<a href="https://pkg.go.dev/github.com/go-redis/redis#NewClient" target="_blank" rel="noreferrer noopener"> NewClient </a>):</p><pre class="wp-block-code"><code>redis.NewClusterClient(&amp;redis.ClusterOptions{//....})</code></pre><p><em>有意思的是，还有</em><a href="https://pkg.go.dev/github.com/go-redis/redis#NewUniversalClient" target="_blank" rel="noreferrer noopener"><em>universal client</em></a><em>选项哪个更灵活一点(在写这篇文章的时候，这是在Go Redis v9) </em></p><p>如果你没有使用正确的连接模式，你会得到一个错误。但有时，根本原因会隐藏在一般的错误信息后面——所以您需要保持警惕。</p><h2><strong>结论</strong></h2><p>您做出的架构选择最终将由您的特定需求驱动。我建议您浏览以下博客文章，深入了解MemoryDB和ElastiCache for Redis的性能特征，以及它们如何影响您设计解决方案的方式:</p><p/><p>Abhishek目前是AWS的首席开发人员，专注于数据库。在他的职业生涯中，他身兼数职，包括工程、产品管理和开发者权益。他的大部分工作都围绕着开源技术，包括分布式数据系统和云原生平台。Abhishek也是一名开源贡献者、热心的博客作者和作家。</p><p aria-hidden="true" class="wp-block-spacer"/></div></div>    
</body>
</html>