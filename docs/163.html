<html>
<head>
<title>Lambda: Building Cost Effective Functions | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Lambda:构建经济高效的功能|云专家</h1>
<blockquote>原文：<a href="https://acloudguru.com/blog/engineering/building-more-cost-effective-lambda-functions-with-1-ms-billing#0001-01-01">https://acloudguru.com/blog/engineering/building-more-cost-effective-lambda-functions-with-1-ms-billing#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p>AWS re:Invent 2020 最大的无服务器声明之一是<a href="https://aws.amazon.com/lambda/pricing/"> AWS Lambda </a>功能的1 ms计费。这是一项行业领先的变革，从根本上改变了许多无服务器应用程序的运行成本。</p><p>在这篇文章中，我解释了它的影响，并展示了如何优化Lambda函数来利用这个新特性。这可以帮助您进一步降低运行无服务器应用程序的成本。</p><h2 id="h-how-lambda-billing-works">Lambda计费的工作原理</h2><p>Lambda是一个按需计算平台——它只在响应事件时运行，你只需在代码运行时付费。</p><p><a href="https://aws.amazon.com/lambda/pricing/">λ定价</a>有两个维度——请求和持续时间。每当调用一个函数时，就会发生一个请求，不管函数的大小如何，费用都是每百万0.20美元。持续时间是作为时间和内存使用的一个因素计算的，每GB秒0.0000166667美元。还有一个<a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc&amp;awsf.Free%2520Tier%2520Categories=categories%2523serverless">自由层</a>允许100万个请求和每月高达400，000 GB/s的计算。在这个级别下，你不需要为任何Lambda的使用付费。</p><p>在此次发布之前，计费的最小持续时间是100毫秒，计费持续时间总是四舍五入到最接近的100毫秒。这意味着，一个5毫秒的功能四舍五入到100毫秒，一个385毫秒的功能四舍五入到400毫秒。随着改为1毫秒计费，最小持续时间值现在是1毫秒，所有其他使用都四舍五入到下一个1毫秒。</p><h2 id="h-from-100-ms-to-1-ms-rounding-the-cost-difference-for-existing-code">从100毫秒到1毫秒的舍入-现有代码的成本差异</h2><p>Lambda是为非常高的流量而设计的，许多基于生产的应用程序会导致数百万次调用。持续时间粒度的这种变化为几乎所有的Lambda函数节省了成本，这将自动出现在您的AWS账单上。</p><p>为了了解这种价格变化对不同函数持续时间的影响，我比较了三种类型的Lambda函数:</p><ol><li>短命的(~100毫秒):它们通常作为“粘合剂”运行，在AWS服务之间最低限度地处理数据。</li><li>亚秒(1秒以下):用于<a href="https://acloudguru.com/blog/engineering/evolution-of-business-logic-from-monoliths-through-microservices-to-functions">更复杂的业务逻辑</a>处理更多数据。</li><li>长期函数(不到1分钟):用于计算复杂的逻辑，或者同步调用第三方服务的函数。</li></ol><p>下表对这三种功能的持续时间进行了随机抽样，然后按1毫秒和100毫秒的粒度对可计费持续时间进行舍入:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/2044ad142858f0c825164469c0653f4a.png" alt="" class="wp-image-42499" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_468/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image.png 468w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image.png 300w" sizes="(max-width: 468px) 100vw, 468px" data-original-src="https://acloudguru.com//app/uploads/2020/12/image.png?x64535"/></figure><p>这表明，可计费持续时间的变化对运行短期功能的成本影响最大，在本例中，可计费持续时间缩短了67%。对于亚秒函数，该示例显示平均持续时间下降了10%,而对长期函数的影响较小。</p><p>实际上，在大多数生产工作负载中，Lambda函数运行的时间很短，因此这里有很好的优化机会。</p><h2 id="h-memory-cost-and-duration">内存、成本和持续时间</h2><p>作为Lambda开发人员，您可以使用的主要配置工具之一是内存。您可以在128 MB到10 GB范围内以64 MB为增量设置分配的内存。然而，内存也控制着可用于您的功能的虚拟CPU的数量，范围从128 MB的单核的百分比到最大内存的六个完整的虚拟CPU。</p><p>对于许多计算密集型功能，增加内存会缩短整体持续时间。这意味着在许多情况下，您可以实现更快的功能，而对成本的影响可以忽略不计。要找到您的功能的最佳平衡，有几个选项。您可以手动测试一个具有不同内存分配的函数，以测量对持续时间的影响，或者您可以使用<a href="https://github.com/alexcasalboni/aws-lambda-power-tuning"> AWS Lambda功率调整</a>工具。</p><p>该工具有助于自动寻找内存、持续时间和成本之间的平衡，并将结果可视化。例如，计算密集型函数在不同的内存级别进行评估。结果图表显示，3008 MB内存的性能最快，但1024 MB和1536 MB内存的成本最低:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/78bcab60d7fdf142efa008ab4be68ea3.png" alt="" class="wp-image-42500" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_468/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image-1.png 468w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image-1.png 300w" sizes="(max-width: 468px) 100vw, 468px" data-original-src="https://acloudguru.com//app/uploads/2020/12/image-1.png?x64535"/></figure><p>当最短计费持续时间为100毫秒时，优化运行时间少于100毫秒的功能不会带来任何财务收益。虽然在这些情况下增加内存可能会减少毫秒数，但由于额外的内存使用量和最短持续时间不变，总体成本会增加。然而，随着1毫秒计费的出现，这一切都变了——现在有必要优化这些功能的效率。您可以采取许多步骤来优化这些短期运行的函数。</p><h2 id="h-reusing-tcp-connections-in-node-js">在Node.js中重用TCP连接</h2><p>在Node.js中，默认的HTTPS代理为每个新请求创建一个新的TCP连接。如果您正在与DynamoDB之类的服务进行交互，此操作的延迟可能会比数据库请求所花费的时间更长。如果您的服务请求使用<a href="https://aws.amazon.com/kms/"> AWS密钥管理服务</a>，这种延迟也会增加。</p><p>您可以通过使用版本<a href="https://github.com/aws/aws-sdk-js/blob/master/CHANGELOG.md#24630"> 2.463.0 </a>中的<a href="https://aws.amazon.com/tools/"> AWS SDK </a>启用的标志来更改设置，以确保TCP连接被重用。最简单的方法是在Lambda函数中使用一个环境变量。通过将<em>AWS _ NODEJS _ CONNECTION _ REUSE _ ENABLED</em>设置为1，函数的热调用将重用该连接。</p><p>本节引用了本<a href="https://github.com/aws-samples/building-faster-aws-lambda-functions">代码报告</a>中的一个应用示例。我比较了将一个项目放入<a href="https://aws.amazon.com/dynamodb/"> Amazon DynamoDB </a>表的延迟，有和没有重用标志。我在300秒内对1000个请求的每个函数运行了一个<a href="https://aws.amazon.com/blogs/compute/load-testing-a-web-applications-serverless-backend/">负载测试</a>。使用这个<a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/AnalyzingLogData.html"> CloudWatch Insights </a>查询，我可以分析持续时间平均值和百分比指标:</p><div class="wp-container-640f29f046943 wp-block-group"><div class="wp-block-group__inner-container"><div class="wp-container-640f29f046608 wp-block-group"><div class="wp-block-group__inner-container"><pre class="wp-block-preformatted">filter @type = "REPORT"
| stats
    avg(@duration) as Average,
percentile(@duration, 99) as NinetyNinth,
percentile(@duration, 95) as NinetyFifth,
percentile(@duration, 90) as Ninetieth
by bin(60m)</pre></div></div></div></div><p>在没有重用标志的示例代码的v1中，结果如下:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/ca962e7ba7b555e970c349cb8166faac.png" alt="" class="wp-image-42501" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_468/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image-2.png 468w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image-2.png 300w" sizes="(max-width: 468px) 100vw, 468px" data-original-src="https://acloudguru.com//app/uploads/2020/12/image-2.png?x64535"/></figure><p>在示例代码的<a href="https://github.com/aws-samples/building-faster-aws-lambda-functions/tree/main/v2"> v2中，</a><a href="https://aws.amazon.com/serverless/sam/"> AWS无服务器应用模型</a> (AWS SAM)模板在函数定义中将标志作为环境变量传递:</p><pre class="wp-block-preformatted">AddToDDBfunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: addToDDBfunction/
      Handler: app.handler
      Runtime: nodejs12.x
      MemorySize: 128
      Timeout: 3      
      Environment:
        Variables:
          AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1  </pre><p>在此版本上运行相同的负载测试，CloudWatch Insights查询显示了性能提升:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/f1d9ddaa4b930e48dded27e901bf79d0.png" alt="" class="wp-image-42502" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_468/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image-3.png 468w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image-3.png 300w" sizes="(max-width: 468px) 100vw, 468px" data-original-src="https://acloudguru.com//app/uploads/2020/12/image-3.png?x64535"/></figure><p>如果这两个功能都被调用100万次，这些平均持续时间指标显示成本降低了23%:</p><figure class="wp-block-table"><table><tbody><tr><td><br/></td><td><strong>请求</strong></td><td><strong>内存(MB) </strong></td><td><strong>持续时间(毫秒)</strong></td><td><strong> GBs </strong></td><td><strong>请求$ </strong></td><td><strong>持续时间$ </strong></td><td><strong>总计</strong></td></tr><tr><td><strong><em/>v1</strong></td><td>1,000,000</td><td>128</td><td>56</td><td>0.007</td><td>$0.20</td><td>$0.12</td><td>$0.32</td></tr><tr><td><strong> <em> v2 </em> </strong></td><td>1,000,000</td><td>128</td><td>21</td><td>0.002625</td><td>$0.20</td><td>$0.04</td><td>$0.24</td></tr></tbody></table></figure><h2 id="h-optimizing-dependency-usage-for-node-js">优化Node.js的依赖关系用法</h2><p>当您<em>需要</em>函数中的JavaScript SDK时，它会导入整个SDK，但您的函数可能只使用一两个AWS服务。这是来自示例的<a href="https://github.com/aws-samples/building-faster-aws-lambda-functions/tree/main/v2">版本2 </a>的代码:</p><pre class="wp-block-preformatted">const AWS = require('aws-sdk')
AWS.config.region = process.env.AWS_REGION 
const docClient = new AWS.DynamoDB.DocumentClient()</pre><p>您可以通过仅<a href="https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/creating-and-calling-service-objects.html">请求您的函数中使用的服务</a>来减少内存使用和初始化时间。为此，更新require语句来指定服务，然后将任何配置选项传递给服务构造函数，如示例的<a href="https://github.com/aws-samples/building-faster-aws-lambda-functions/tree/main/v3">版本3 </a>所示:</p><pre class="wp-block-preformatted">const DynamoDB = require('aws-sdk/clients/dynamodb')
const documentClient = new DynamoDB.DocumentClient()</pre><p>此版本的负载测试在CloudWatch Insights查询中显示了以下结果:</p><figure class="wp-block-image size-large"><img loading="lazy" src="../Images/f6b8aa884b407a28dfa21460ad630623.png" alt="" class="wp-image-42503" srcset="https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_468/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image-4.png 468w, https://res.cloudinary.com/acloud-guru/image/fetch/c_thumb,f_auto,q_auto,w_300/https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2020/12/image-4.png 300w" sizes="(max-width: 468px) 100vw, 468px" data-original-src="https://acloudguru.com//app/uploads/2020/12/image-4.png?x64535"/></figure><p>与原始版本相比，这将持续时间成本降低了约75%，总体成本降低了26%:</p><figure class="wp-block-table"><table><tbody><tr><td><br/></td><td><strong>请求</strong></td><td><strong>内存(MB) </strong></td><td><strong>持续时间(毫秒)</strong></td><td><strong> GBs </strong></td><td><strong>请求$ </strong></td><td><strong>持续时间$ </strong></td><td><strong>总计</strong></td></tr><tr><td><strong><em/>v1</strong></td><td>1,000,000</td><td>128</td><td>56</td><td>0.007</td><td>$0.20</td><td>$0.12</td><td>$0.32</td></tr><tr><td><strong> <em> v2 </em> </strong></td><td>1,000,000</td><td>128</td><td>21</td><td>0.002625</td><td>$0.20</td><td>$0.04</td><td>$0.24</td></tr><tr><td><strong> <em> V3 </em> </strong></td><td>1,000,000</td><td>128</td><td>16</td><td>0.002</td><td>$0.20</td><td>$0.03</td><td>$0.23</td></tr></tbody></table></figure><h2 id="h-other-optimizations-for-sub-100-millisecond-functions">亚100毫秒函数的其他优化</h2><p>还有其他几个因素需要考虑，这些因素可能会缩短函数的总持续时间。您的用例将决定您可以应用哪些。</p><p>首先，您对运行时的选择很重要。尽管Lambda服务对运行时是不可知的，但是一些运行时比另一些运行时初始化得更快。对于短函数，可以考虑使用Node.js、Go和Python这样的运行时，它们通常可以运行得更快。</p><p>让您的部署包尽可能小，因为较大的包通常需要较长的初始化时间。您应该删除函数不直接使用的任何需求或库导入。此外，避免包含多个代码路径的“单一”函数，尽可能缩小您的代码，以帮助获得尽可能小的部署包大小。</p><p>确保在全局范围内定义了任何需要初始化的全局对象，如数据库连接。这是Lambda处理函数之外的代码，也称为“INIT”代码。如果同一个执行环境被多次调用，那么任何冗长的初始化代码的成本都会分摊到多次调用中。</p><p>寻找更多的云转型善？看看这些:</p><h2 id="h-conclusion">结论</h2><p>对于Lambda函数的新1 ms计费，优化代码持续时间对运行Lambda函数的成本有直接影响。寿命较短的函数通常只需做一些小的改动就可以运行得更快，这就意味着降低了成本。</p><p>Lambda中的内存分配决定了函数的CPU能力。为了帮助确定持续时间、成本和内存之间的最佳平衡，请使用AWS功率调整工具。“重用HTTP连接”标志有助于减少Node.js函数中的延迟，您可以使用环境变量来启用它。选择性地选择要导入的AWS SDK的一部分还可以减少持续时间，而不会影响业务逻辑的功能。</p><p>想采取下一步措施提升您自己或您的团队在无服务器应用方面的技能吗？云专家提供最新的课程库来超越你的简单项目。例如，为您的下一个无服务器项目利用<a href="https://acloudguru.com/course/go-serverless-with-a-graph-database"> aws图形数据库</a>的力量！立即开始您的<a href="https://acloudguru.com/pricing">免费试用</a>或与我们交流您的需求。</p><p>要获得更多帮助您充分利用基于Lambda的应用程序的技巧和诀窍，请访问<a href="https://serverlessland.com/">无服务器世界</a>。</p></div></div>    
</body>
</html>